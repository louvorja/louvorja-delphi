unit fmMenu;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Buttons, CustomizeDlg, DB, ADODB, ComCtrls, ImgList,
  Grids, DBGrids, LMDCustomComponent, LMDStarter, IniFiles,
  Menus, ExtCtrls,IdBaseComponent, IdComponent, IdIPWatch,
  IdAntiFreezeBase, IdAntiFreeze, acTitleBar, acAlphaImageList,
  sSkinManager, DBClient, IdTCPConnection, IdTCPClient, IdHTTP, AppEvnts,
  ValEdit, sListView, sLabel, sCheckBox, Mask, sMaskEdit, sSpeedButton,
  MPlayer, sGauge, sListBox, sCheckListBox, sComboBox, sRadioButton,
  sRichEdit, sStatusBar, sEdit, sGroupBox, sButton, sScrollBox,
  acImage, sPanel, sPageControl,
  DateUtils, ActiveX,
  ShellApi,
  DBCtrls, OleCtrls,
  WinInet,
  OleCtnrs, Tedit_Align, CheckLst, pngimage,
  IdIOHandlerStack,
  IdSSL, IdSSLOpenSSL, pngextra, ToolWin, sToolBar,
  sCustomComboEdit, sSpinEdit, sToolEdit, sSplitter, sMemo,
  QuickRpt, SHDocVw, acWebBrowser, sFontCtrls, sColorSelect, jpeg;

type
  TfmIndex = class(TForm)
    ADO: TADOConnection;
    PageControl1: TsPageControl;
    TabSheet1: TsTabSheet;
    TabSheet2: TsTabSheet;
    TabSheet3: TsTabSheet;
    qrSEL_COLETANEAS: TADOQuery;
    sbColJA: TsScrollBox;
    sbColDIV: TsScrollBox;
    qrSEL_COLETANEAS_ID: TADOQuery;
    lmdEXEC: TLMDStarter;
    ppColetaneas: TPopupMenu;
    StatusBar1: TsStatusBar;
    qrSEL_MUSICAS_ID: TADOQuery;
    qrSEL_MUSICAS_IDMUS: TADOQuery;
    Panel1: TsPanel;
    DBGrid1: TDBGrid;
    qrHINOS: TADOQuery;
    dsHINOS: TDataSource;
    gbHino: TsGroupBox;
    Panel2: TsPanel;
    Panel3: TsPanel;
    Panel4: TsPanel;
    txtHino: TsEdit;
    pnlGRIDBotoes: TsPanel;
    ApplicationEvents1: TApplicationEvents;
    TabSheet4: TsTabSheet;
    TabSheet5: TsTabSheet;
    MainMenu1: TMainMenu;
    N1: TMenuItem;
    Localizar1: TMenuItem;
    Localizar2: TMenuItem;
    Hinrio1: TMenuItem;
    JA1: TMenuItem;
    Diversas1: TMenuItem;
    Utilitrios1: TMenuItem;
    Panel5: TsPanel;
    gbBusca: TsGroupBox;
    txtBusca: TsEdit;
    pnlGRID2Botoes: TsPanel;
    Panel7: TsPanel;
    Panel8: TsPanel;
    Panel9: TsPanel;
    Panel10: TsPanel;
    DBGrid2: TDBGrid;
    qrBUSCA: TADOQuery;
    dsBUSCA: TDataSource;
    PageControl2: TsPageControl;
    TabSheet6: TsTabSheet;
    TabSheet7: TsTabSheet;
    pnlSorteioE: TsPanel;
    pnlSorteioD: TsPanel;
    pnlSorteio: TsPanel;
    tmrSorteio: TTimer;
    opNumSorteado: TsEdit;
    pnlTempoGravado: TsPanel;
    pnlCrono: TsPanel;
    tmrCrono: TTimer;
    TabSheet8: TsTabSheet;
    qrVALIDA_LINKS: TADOQuery;
    PageControl3: TsPageControl;
    TabSheet9: TsTabSheet;
    ppGrid: TPopupMenu;
    migCantada: TMenuItem;
    migInstrumental: TMenuItem;
    migLetra: TMenuItem;
    migSlide: TMenuItem;
    migAlbum: TMenuItem;
    N2: TMenuItem;
    qrVERSAO: TADOQuery;
    TabSheet10: TsTabSheet;
    Sistema1: TMenuItem;
    TabSheet11: TsTabSheet;
    Bblia1: TMenuItem;
    qrBIBLIA: TADOQuery;
    dsBIBLIA: TDataSource;
    qrVERSAO_BIB: TADOQuery;
    dsVERSAO_BIB: TDataSource;
    qrPASSAGEM: TADOQuery;
    IdHTTP1: TIdHTTP;
    dd1: TMenuItem;
    Panel16: TsPanel;
    rbFiltro2: TsRadioButton;
    rbFiltro1: TsRadioButton;
    Label1: TsLabel;
    Panel17: TsPanel;
    Label9: TsLabel;
    rbIdioma1: TsRadioButton;
    rbIdioma2: TsRadioButton;
    rbIdioma3: TsRadioButton;
    rbIdioma4: TsRadioButton;
    tmrSortear: TTimer;
    tabsEscSb: TsTabSheet;
    tmrEscSb: TTimer;
    mpMusica: TMediaPlayer;
    tmrMediaPlayer: TTimer;
    pageControl4: TsPageControl;
    TabSheet16: TsTabSheet;
    TabSheet13: TsTabSheet;
    Panel18: TsPanel;
    TabSheet14: TsTabSheet;
    pnlEscSb_Fonte: TsPanel;
    TabSheet15: TsTabSheet;
    cdsCOLETANEAS_PERSO: TClientDataSet;
    dsCOLETANEAS_PERSO: TDataSource;
    sbColPERSO: TsScrollBox;
    cdsCOLETANEAS_PERSONOME: TStringField;
    cdsCOLETANEAS_PERSOURL: TStringField;
    cdsCOLETANEAS_PERSOIMAGEM: TStringField;
    cdsCOLETANEAS_PERSOID: TStringField;
    cdsCOLETANEAS_PERSOURL_INFO: TStringField;
    cdsCOLETANEAS_PERSOIMAGEM_INFO: TStringField;
    ColetneasPersonalizadas1: TMenuItem;
    sSkinManager1: TsSkinManager;
    ico_32x32: TsAlphaImageList;
    barraTitulo: TsTitleBar;
    sDragBar1: TsPanel;
    sButton1: TsButton;
    ico_24x24: TsAlphaImageList;
    ico_16x16: TsAlphaImageList;
    sButton2: TsButton;
    sPanel1: TsPanel;
    stHinos: TsStatusBar;
    sPanel2: TsPanel;
    pnlStatusBuscaMusicas: TsStatusBar;
    Toolbar9: TsPanel;
    btLigar: TsButton;
    btOuvir: TsButton;
    meESHora: TsMaskEdit;
    cbMusica: TsComboBox;
    cb1: TsCheckBox;
    cb5: TsCheckBox;
    cbA: TsCheckBox;
    Label5: TsLabel;
    lmdEscSb_Fonte_A: TsSpeedButton;
    sSpeedButton2: TsSpeedButton;
    sSpeedButton3: TsSpeedButton;
    sSpeedButton4: TsSpeedButton;
    lmdEscSb_Fonte_D: TsSpeedButton;
    pnlEscSbR_Fonte: TsPanel;
    lmdEscSbR_Fonte_A: TsSpeedButton;
    lmdEscSbR_Fonte_D: TsSpeedButton;
    gEscSbR: TsGauge;
    sSkinManager2: TsSkinManager;
    pnlEscSB: TsPanel;
    lbCrono: TsListView;
    ToolBar6: TsPanel;
    ToolButton9: TsButton;
    ToolButton12: TsButton;
    ppZeraSorteio: TPopupMenu;
    ToolButton6: TMenuItem;
    ToolButton15: TMenuItem;
    sPanel3: TsPanel;
    opSort_Ini: TsEdit;
    opSort_Fin: TsEdit;
    SpeedButton1: TsButton;
    lbSort_D: TsListView;
    lblNumDis: TsLabel;
    sDragBar3: TsPanel;
    ToolButton1: TsButton;
    sButton4: TsButton;
    ToolButton3: TsButton;
    sLabel1: TsLabel;
    lblNumSort: TsLabel;
    sDragBar4: TsPanel;
    ToolButton2: TsButton;
    sButton5: TsButton;
    ToolButton4: TsButton;
    lbSort_S: TsListView;
    opNumIndice: TsEdit;
    sPanel5: TsPanel;
    kfVersao: TsListBox;
    sPanel6: TsPanel;
    Panel19: TsPanel;
    Button5: TsButton;
    Button6: TsButton;
    Button9: TsButton;
    Button7: TsButton;
    Button8: TsButton;
    ckLivros: TsCheckListBox;
    sLabel2: TsLabel;
    sPanel8: TsPanel;
    sPanel9: TsPanel;
    SpeedButton2: TsButton;
    SpeedButton3: TsButton;
    sButton3: TsButton;
    lvErros: TsListView;
    lvAtalhos: TsListView;
    reAux: TsRichEdit;
    reHino: TsRichEdit;
    ico_64x64: TsAlphaImageList;
    ico_128x128: TsAlphaImageList;
    IdAntiFreeze1: TIdAntiFreeze;
    sPanel10: TsPanel;
    sImagemCapa: TsImage;
    tmrSair: TTimer;
    sButton6: TsButton;
    imCapas: TImageList;
    reBusca: TsRichEdit;
    sPanel11: TsPanel;
    sGroupBox1: TsGroupBox;
    sPanel12: TsPanel;
    cbExtensaoHinosHinario: TsComboBox;
    sTabSheet1: TsTabSheet;
    sPanel13: TsPanel;
    tbLiturgiaSemana: TsToolBar;
    lcal_7: TToolButton;
    lcal_1: TToolButton;
    lcal_2: TToolButton;
    lcal_3: TToolButton;
    lcal_4: TToolButton;
    lcal_5: TToolButton;
    lcal_6: TToolButton;
    sListView1: TsListView;
    ppLiturgiaGrid: TPopupMenu;
    MenuItem1: TMenuItem;
    MenuItem2: TMenuItem;
    N3: TMenuItem;
    miUp: TMenuItem;
    miDown: TMenuItem;
    dsLITURGIA: TDataSource;
    cdsLITURGIA: TClientDataSet;
    StringField1: TStringField;
    StringField2: TStringField;
    StringField4: TStringField;
    cdsLITURGIAORDEM: TIntegerField;
    cdsLITURGIASEMANA: TIntegerField;
    sPanel14: TsPanel;
    txtItem: TsEdit;
    cbAbrir: TsComboBox;
    pnlLitBotoes: TsPanel;
    btSave: TsButton;
    pnlLitPanel: TsPanel;
    cbNome: TsComboBox;
    seHino: TsSpinEdit;
    txtUrl: TsFilenameEdit;
    txtNome: TsEdit;
    txtUrlInfo: TsEdit;
    btCancel: TsButton;
    cbKeys: TsComboBox;
    qrHINOS_LITURGIA: TADOQuery;
    qrCOLETANEAS_LITURGIA: TADOQuery;
    cdsLITURGIAITEM: TStringField;
    seSemana: TsSpinEdit;
    cdsLITURGIAURL_INFO: TStringField;
    cdsLITURGIATIPO: TIntegerField;
    txtID: TsEdit;
    txtSite: TsEdit;
    sTabSheet2: TsTabSheet;
    sbOpc: TsScrollBox;
    sPanel16: TsPanel;
    sPanel15: TsPanel;
    sLabel3: TsLabel;
    cbExtensaoHinos: TsComboBox;
    sPanel17: TsPanel;
    sLabel4: TsLabel;
    sPanel18: TsPanel;
    sbMonitorAreaExtendida: TsComboBox;
    sPanel19: TsPanel;
    sPanel20: TsPanel;
    pnBotoesBiblia: TsPanel;
    sSpeedButton6: TsSpeedButton;
    btLimpar: TsButton;
    btPassagem: TsButton;
    Button2: TsButton;
    Button1: TsButton;
    btExp_Biblia: TsButton;
    pnLivro: TsPanel;
    sLabel5: TsLabel;
    cbLivro: TsComboBox;
    pnCapitulo: TsPanel;
    txtCapitulo: TsSpinEdit;
    sLabel6: TsLabel;
    pnVersiculo: TsPanel;
    txtVersiculo: TsEdit;
    pnVersao: TsPanel;
    dbVersao: TsComboBox;
    sLabel7: TsLabel;
    pnLocalizaBiblia: TsPanel;
    txtLocaliza: TsEdit;
    pnBotoesBibliaBusca: TsPanel;
    sSpeedButton7: TsSpeedButton;
    btExp_BibliaBusca: TsButton;
    Button3: TsButton;
    Button4: TsButton;
    pnVersao2: TsPanel;
    dbVersao2: TsComboBox;
    tsDesenvolvedor: TsTabSheet;
    sPanel21: TsPanel;
    sPanel22: TsPanel;
    sSplitter1: TsSplitter;
    sSplitter2: TsSplitter;
    sSplitter3: TsSplitter;
    Memo1: TMemo;
    sPanel26: TsPanel;
    sSplitter4: TsSplitter;
    sSpeedButton8: TsSpeedButton;
    btExp_EscolaSabatina: TsButton;
    sSplitter5: TsSplitter;
    sPanel29: TsPanel;
    sPanel25: TsPanel;
    paramAtualiz: TValueListEditor;
    sPanel30: TsPanel;
    param: TValueListEditor;
    sPanel24: TsPanel;
    sPanel31: TsPanel;
    sPanel23: TsPanel;
    loadCol: TValueListEditor;
    sPanel32: TsPanel;
    lvMonitores: TsListView;
    sPanel27: TsPanel;
    sPanel33: TsPanel;
    sPanel28: TsPanel;
    mmParam: TsMemo;
    sPanel35: TsPanel;
    sPanel34: TsPanel;
    mmConfigJA: TsMemo;
    sPanel36: TsPanel;
    sPanel37: TsPanel;
    sPanel38: TsPanel;
    sPanel39: TsPanel;
    sSplitter6: TsSplitter;
    sSplitter7: TsSplitter;
    DBGrid3: TDBGrid;
    DBGrid4: TDBGrid;
    cbFormatoHino: TsComboBox;
    wbBiblia: TsWebBrowser;
    wbLocaliza: TsWebBrowser;
    sPanel4: TsPanel;
    sPanel7: TsPanel;
    sLabel8: TsLabel;
    sPanel40: TsPanel;
    fcBibliabFonte: TsFontComboBox;
    sPanel47: TsPanel;
    sPanel48: TsPanel;
    sLabel13: TsLabel;
    sLabel14: TsLabel;
    sPanel49: TsPanel;
    fcEscsbFonte: TsFontComboBox;
    sPanel50: TsPanel;
    sImage3: TsImage;
    seEscsbTamanhoExtendido: TsSpinEdit;
    sPanel52: TsPanel;
    sImage4: TsImage;
    seEscsbTamanho: TsSpinEdit;
    sPanel54: TsPanel;
    sPanel56: TsPanel;
    sPanel64: TsPanel;
    sLabel20: TsLabel;
    sLabel21: TsLabel;
    sPanel65: TsPanel;
    fcSorteioFonte: TsFontComboBox;
    sPanel66: TsPanel;
    sImage7: TsImage;
    seSorteioTamanhoExtendido: TsSpinEdit;
    sPanel68: TsPanel;
    sImage8: TsImage;
    seSorteioTamanho: TsSpinEdit;
    sPanel71: TsPanel;
    sLabel23: TsLabel;
    sLabel24: TsLabel;
    sPanel72: TsPanel;
    fcCronoFonte: TsFontComboBox;
    sPanel73: TsPanel;
    sImage9: TsImage;
    seCronoTamanhoExtendido: TsSpinEdit;
    sPanel75: TsPanel;
    sImage10: TsImage;
    seCronoTamanho: TsSpinEdit;
    sPanel57: TsPanel;
    sLabel19: TsLabel;
    sPanel60: TsPanel;
    csCronoCor: TsColorSelect;
    sPanel62: TsPanel;
    sLabel17: TsLabel;
    sPanel58: TsPanel;
    sLabel26: TsLabel;
    sPanel63: TsPanel;
    csSorteioCor: TsColorSelect;
    sPanel76: TsPanel;
    sLabel18: TsLabel;
    sPanel59: TsPanel;
    sLabel22: TsLabel;
    sLabel25: TsLabel;
    sPanel61: TsPanel;
    csEscsbCor: TsColorSelect;
    sPanel67: TsPanel;
    btEscsbReset: TsButton;
    sLabel15: TsLabel;
    sPanel51: TsPanel;
    sImage5: TsImage;
    seEscsbTamanho2: TsSpinEdit;
    sPanel53: TsPanel;
    sImage6: TsImage;
    seEscsbTamanhoExtendido2: TsSpinEdit;
    sPanel55: TsPanel;
    csEscsbCor2: TsColorSelect;
    sLabel16: TsLabel;
    sPanel69: TsPanel;
    sLabel27: TsLabel;
    sLabel28: TsLabel;
    sLabel29: TsLabel;
    sPanel70: TsPanel;
    csBibliabCor: TsColorSelect;
    sPanel77: TsPanel;
    csBibliabCor2: TsColorSelect;
    sPanel45: TsPanel;
    csBibliabCor3: TsColorSelect;
    sLabel11: TsLabel;
    sPanel46: TsPanel;
    sLabel30: TsLabel;
    sLabel31: TsLabel;
    sPanel79: TsPanel;
    sImage13: TsImage;
    seBibliabTamanhoExtendido: TsSpinEdit;
    sPanel80: TsPanel;
    sImage14: TsImage;
    seBibliabTamanho: TsSpinEdit;
    sPanel81: TsPanel;
    sImage15: TsImage;
    seBibliabTamanho2: TsSpinEdit;
    sPanel82: TsPanel;
    sImage16: TsImage;
    seBibliabTamanhoExtendido2: TsSpinEdit;
    sLabel12: TsLabel;
    sPanel78: TsPanel;
    sImage17: TsImage;
    seBibliabTamanho3: TsSpinEdit;
    sPanel83: TsPanel;
    sImage18: TsImage;
    seBibliabTamanhoExtendido3: TsSpinEdit;
    sPanel41: TsPanel;
    csBibliabCor4: TsColorSelect;
    sLabel9: TsLabel;
    sPanel42: TsPanel;
    sPanel43: TsPanel;
    sLabel10: TsLabel;
    sPanel44: TsPanel;
    fcBibliaFonte: TsFontComboBox;
    sPanel84: TsPanel;
    sLabel32: TsLabel;
    sLabel33: TsLabel;
    sLabel34: TsLabel;
    sPanel85: TsPanel;
    sImage1: TsImage;
    seBibliaTamanhoExtendido: TsSpinEdit;
    sPanel86: TsPanel;
    sImage2: TsImage;
    seBibliaTamanho: TsSpinEdit;
    sPanel87: TsPanel;
    sImage11: TsImage;
    seBibliaTamanho2: TsSpinEdit;
    sPanel88: TsPanel;
    sImage12: TsImage;
    seBibliaTamanhoExtendido2: TsSpinEdit;
    sPanel89: TsPanel;
    sImage19: TsImage;
    seBibliaTamanho3: TsSpinEdit;
    sPanel90: TsPanel;
    sImage20: TsImage;
    seBibliaTamanhoExtendido3: TsSpinEdit;
    sPanel91: TsPanel;
    sLabel35: TsLabel;
    sLabel36: TsLabel;
    sLabel37: TsLabel;
    sLabel38: TsLabel;
    sLabel39: TsLabel;
    sPanel92: TsPanel;
    csBibliaCor: TsColorSelect;
    sPanel94: TsPanel;
    csBibliaCor2: TsColorSelect;
    sPanel95: TsPanel;
    csBibliaCor3: TsColorSelect;
    sPanel96: TsPanel;
    csBibliaCor4: TsColorSelect;
    sPanel97: TsPanel;
    csBibliabCor5: TsColorSelect;
    sLabel40: TsLabel;
    sPanel98: TsPanel;
    csCronoCorFundo: TsColorSelect;
    sLabel41: TsLabel;
    sPanel100: TsPanel;
    csSorteioCorFundo: TsColorSelect;
    sLabel42: TsLabel;
    sPanel101: TsPanel;
    csEscsbCorFundo: TsColorSelect;
    sLabel43: TsLabel;
    Panel15: TPanel;
    lmdEscSbR: TsLabelFX;
    lmdEscSb: TsLabelFX;
    pnlSorteio_Fonte: TsPanel;
    lmdSorteio_Fonte_A: TsSpeedButton;
    lmdSorteio_Fonte_D: TsSpeedButton;
    lmdSorteio: TsLabelFX;
    gSorteio: TsGauge;
    sDragBar2: TsPanel;
    sSpeedButton9: TsSpeedButton;
    ToolButton5: TsButton;
    ToolButton7: TsButton;
    btExp_Sorteio: TsButton;
    lmdCrono: TsLabelFX;
    pnlCrono_Fonte: TsPanel;
    lmdCrono_Fonte_A: TsSpeedButton;
    lmdCrono_Fonte_D: TsSpeedButton;
    gCrono: TsGauge;
    Toolbar7: TsPanel;
    sSpeedButton1: TsSpeedButton;
    sSpeedButton5: TsSpeedButton;
    sSpeedButton10: TsSpeedButton;
    btIniciarCrono: TsButton;
    txtDecr: TsMaskEdit;
    btZerarCrono: TsButton;
    btAnotTempo: TsButton;
    rbCronoDir: TsRadioButton;
    rbCronoDec: TsRadioButton;
    btExp_Cronometro: TsButton;
    sPanel99: TsPanel;
    sLabel44: TsLabel;
    sPanel103: TsPanel;
    btCronoReset: TsButton;
    cbCronoEl1: TsCheckBox;
    sPanel102: TsPanel;
    sPanel105: TsPanel;
    btSorteioReset: TsButton;
    sLabel48: TsLabel;
    cbSorteioEl2: TsCheckBox;
    cbSorteioEl1: TsCheckBox;
    sPanel104: TsPanel;
    csBibliabCorFundo: TsColorSelect;
    sLabel45: TsLabel;
    sPanel106: TsPanel;
    csBibliaCorFundo: TsColorSelect;
    sLabel46: TsLabel;
    sPanel107: TsPanel;
    sLabel47: TsLabel;
    sPanel108: TsPanel;
    tsBibliaImagem: TsFilenameEdit;
    tsBibliaImagemInfo: TsEdit;
    sPanel93: TsPanel;
    sButton7: TsButton;
    sPanel109: TsPanel;
    sLabel49: TsLabel;
    sPanel110: TsPanel;
    tsBibliabImagem: TsFilenameEdit;
    tsBibliabImagemInfo: TsEdit;
    sPanel74: TsPanel;
    btBibliabReset: TsButton;
    procedure FormCreate(Sender: TObject);
    procedure fExibeColetaneas(Tipo: string = 'JA');
    procedure fExibeColetaneasPerso();
    procedure sbClick(Sender: TObject);
    procedure sbClickPerso(Sender: TObject);
    procedure sbBaixar(Sender: TObject);
    procedure sbOpenMusica(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure StatusMSG(Mensagem: string = '');
    procedure ppColetaneasPopup(Sender: TObject);
    procedure TabSheet3Show(Sender: TObject);
    procedure txtHinoChange(Sender: TObject);
    procedure corCampoBusca(Query: TADOQuery; Campo: TEdit);
    function qtHinos: string;
    function qtBusca: string;
    procedure DBGrid1DblClick(Sender: TObject);
    procedure txtHinoKeyPress(Sender: TObject; var Key: Char);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure abreLetra(ID: integer;BUSCA: string = '');
    procedure abreMusica(URL: string;Tipo: string = 'musica');
    procedure TabSheet1Show(Sender: TObject);
    procedure TabSheet2Show(Sender: TObject);
    procedure ApplicationEvents1Message(var Msg: tagMSG;
      var Handled: Boolean);
    procedure Localizar1Click(Sender: TObject);
    procedure TabSheet4Show(Sender: TObject);
    procedure Hinrio1Click(Sender: TObject);
    procedure JA1Click(Sender: TObject);
    procedure Diversas1Click(Sender: TObject);
    procedure Utilitrios1Click(Sender: TObject);
    procedure txtBuscaChange(Sender: TObject);
    procedure rbFiltro1Click(Sender: TObject);
    procedure DBGrid2DblClick(Sender: TObject);
    procedure txtBuscaKeyPress(Sender: TObject; var Key: Char);
    procedure DBGrid2DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure SpeedButton1Click(Sender: TObject);
    procedure RemoveDuplicadasListBox(ListView: TsListView);
    procedure RemoveItemListBox(ListView: TsListView;MonitorListView: TsListView = nil;tag:integer = -1);
    procedure LimpaItemListBox(ListView: TsListView;MonitorListView: TsListView = nil;tag:integer = -1);
    procedure TransfereItemListView(ListViewA,ListViewB: TsListView; Topo: boolean;MonitorListViewA: TsListView = nil;MonitorListViewB: TsListView = nil;tag:integer = -1);
    procedure ToolButton1Click(Sender: TObject);
    procedure ToolButton2Click(Sender: TObject);
    procedure ToolButton3Click(Sender: TObject);
    procedure ToolButton4Click(Sender: TObject);
    procedure tmrSorteioTimer(Sender: TObject);
    procedure ToolButton6Click(Sender: TObject);
    procedure ToolButton7Click(Sender: TObject);
    procedure SorteioContador();
    procedure tmrCronoTimer(Sender: TObject);
    procedure lbSort_DKeyPress(Sender: TObject; var Key: Char);
    procedure lbSort_DKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure lbSort_SKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure opSort_IniKeyPress(Sender: TObject; var Key: Char);
    procedure rbCronoDirClick(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure ToolButton15Click(Sender: TObject);
    procedure ppGridPopup(Sender: TObject);
    procedure migCantadaClick(Sender: TObject);
    procedure migInstrumentalClick(Sender: TObject);
    procedure migLetraClick(Sender: TObject);
    procedure migAlbumClick(Sender: TObject);
    function isFolderEmpty(szPath: String): Boolean;
    procedure SpeedButton3Click(Sender: TObject);
    procedure Sistema1Click(Sender: TObject);
    procedure TabSheet10Show(Sender: TObject);
    procedure Bblia1Click(Sender: TObject);
    procedure carregaCombo(TIPO: string);
    procedure cbLivroKeyPress(Sender: TObject; var Key: Char);
    function IsNumeric(S : String): boolean;
    procedure geraPassagem(acao: string = '';alertas: boolean = True);
    procedure gravaPassagem(acao:string = 'BIBLIA');
    procedure txtVersiculoKeyPress(Sender: TObject; var Key: Char);
    procedure btPassagemClick(Sender: TObject);
    procedure verVersao();
    procedure dd1Click(Sender: TObject);
    procedure btLimparClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure tmrSortearTimer(Sender: TObject);
    procedure TabSheet6Show(Sender: TObject);
    procedure TabSheet7Show(Sender: TObject);
    procedure tabsEscSbShow(Sender: TObject);
    procedure tmrEscSbTimer(Sender: TObject);
    procedure txtDecrChange(Sender: TObject);
    procedure txtDecrExit(Sender: TObject);
    function lerParam(Grupo,Param,Valor: string): string;
    procedure gravaParam(Grupo,Param,Valor: string);
    procedure apagaParam(Grupo: string;Param: string = '');
    procedure cbAClick(Sender: TObject);
    procedure cb5Click(Sender: TObject);
    procedure cb1Click(Sender: TObject);
    procedure cbMusicaChange(Sender: TObject);
    procedure selMusica();
    procedure meESHoraChange(Sender: TObject);
    procedure tmrMediaPlayerTimer(Sender: TObject);
    procedure TabSheet16Show(Sender: TObject);
    procedure TabSheet13Show(Sender: TObject);
    procedure txtLocalizaKeyPress(Sender: TObject; var Key: Char);
    procedure Button3Click(Sender: TObject);
    procedure localizaPalavraChave(alertas: boolean = True);
    procedure Button4Click(Sender: TObject);
    procedure Button5Click(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure Button7Click(Sender: TObject);
    procedure Button8Click(Sender: TObject);
    procedure Button9Click(Sender: TObject);
    function ToLower(Text: String): String;
    function ToUpper(Text: String): String;
    procedure TabSheet14Show(Sender: TObject);
    procedure Link(Sender: TObject);
    procedure PageControl1Change(Sender: TObject);
    procedure Fonte_AD_Click(Sender: TObject);
    procedure TabSheet15Show(Sender: TObject);
    procedure ColetneasPersonalizadas1Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure sTitleBar1Items0Click(Sender: TObject);
    procedure sButton1Click(Sender: TObject);
    procedure sButton2Click(Sender: TObject);
    procedure btOuvirClick(Sender: TObject);
    procedure btLigarClick(Sender: TObject);
    procedure posicionaElementosTimers();
    procedure btIniciarCronoClick(Sender: TObject);
    procedure btZerarCronoClick(Sender: TObject);
    procedure btAnotTempoClick(Sender: TObject);
    procedure sListView1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure ToolButton12Click(Sender: TObject);
    procedure ToolButton9Click(Sender: TObject);
    procedure ToolButton5Click(Sender: TObject);
    procedure sButton4Click(Sender: TObject);
    procedure sButton5Click(Sender: TObject);
    procedure lbSort_SKeyPress(Sender: TObject; var Key: Char);
    procedure dbVersaoChange(Sender: TObject);
    procedure dbVersao2Change(Sender: TObject);
    procedure Localizar(ValorBusca: String; RichEdit: TRichEdit; recolore: boolean);
    procedure sButton3Click(Sender: TObject);
    procedure TabSheet9Show(Sender: TObject);
    procedure formataTexto(RichEdit: TsRichEdit);
    procedure FormResize(Sender: TObject);
    procedure TabSheet11Show(Sender: TObject);
    procedure TabSheet5Show(Sender: TObject);
    procedure TabSheet8Show(Sender: TObject);
    function ExtraiTexto(const Str, Str1, Str2: String) : String;
    procedure BaixaColetanea(col, tit: string);
    function EncodeBase64(const inStr: string): string;
    function DecodeBase64(const CinLine: string): string;
    procedure carregaParams();
    procedure tmrSairTimer(Sender: TObject);
    procedure barraTituloItems0Click(Sender: TObject);
    procedure Espere( N:Integer );
    procedure removeArqTemp(dir: string='');
    procedure sButton6Click(Sender: TObject);
    function GetComputerNameFunc : string;
    procedure BitmapFileToPNG(const Source, Dest: String);
    procedure LiturgiaCalendarClick(Sender: TObject);
    procedure sTabSheet1Show(Sender: TObject);
    function verificaURL(url: string; input: TEdit): string;
    procedure txtUrlChange(Sender: TObject);
    procedure limpaCamposLiturgia();
    procedure cbAbrirChange(Sender: TObject);
    procedure cbNomeChange(Sender: TObject);
    procedure seHinoChange(Sender: TObject);
    procedure btSaveClick(Sender: TObject);
    procedure carregaLiturgia(dia_semana: integer);
    procedure sListView1DblClick(Sender: TObject);
    procedure lbCronoKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure MenuItem2Click(Sender: TObject);
    procedure ppLiturgiaGridPopup(Sender: TObject);
    procedure miUpClick(Sender: TObject);
    procedure sListView1Change(Sender: TObject; Item: TListItem;
      Change: TItemChange);
    procedure miDownClick(Sender: TObject);
    procedure MenuItem1Click(Sender: TObject);
    procedure btCancelClick(Sender: TObject);
    procedure sListView1CustomDrawItem(Sender: TCustomListView;
      Item: TListItem; State: TCustomDrawState; var DefaultDraw: Boolean);
    procedure sTabSheet2Show(Sender: TObject);
    procedure cbExtensaoHinosChange(Sender: TObject);
    procedure cbExtensaoHinosHinarioChange(Sender: TObject);
    procedure sbMonitorAreaExtendidaChange(Sender: TObject);
    procedure expandirArea(Sender: TObject);
    procedure tsDesenvolvedorShow(Sender: TObject);
    procedure copiaDadosTelaExtendida();
    function monitorAtivo(index: integer):Boolean;
    procedure WBLoadHTML(WebBrowser: TWebBrowser; HTMLCode: string) ;
    procedure fcOpcFonteChange(Sender: TObject);
    procedure seOpcTamanhoChange(Sender: TObject);
    procedure seOpcTamanhoExtendidoChange(Sender: TObject);
    procedure cbOpcCheckBox(Sender: TObject);
    procedure csOpcCorChange(Sender: TObject);
    procedure btOpcResetClick(Sender: TObject);
    procedure btOpcFileNameEditChange(Sender: TObject);
    function ColorToHtml(DColor:TColor):string;
    procedure txtCapituloKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
  private
    { Private declarations }
  public
    { Public declarations }
    TITULO: PChar;
    VERSAO: String;

    tCrono: TDateTime;
    tCronoOld: TDateTime;
    tCronoT: TDateTime;

    resize: boolean;
    passag: integer;

    vSorteio: integer;

    fonte: string;
    carrega_opc: Boolean;

    titulos_abas: array[0..10] of string;
  end;

var
  fmIndex: TfmIndex;

implementation

uses fmLetra, fmAbout, frmColetPerso, fmDialogVersao, fmAtualiza, StrUtils,
  Math, fmMonitor;

{$R *.dfm}

procedure TfmIndex.FormCreate(Sender: TObject);
begin
  TITULO := 'Louvor JA';
  VERSAO := '12.3';
  DecimalSeparator := '.';

  fonte := 'Arial Rounded MT Bold';
  carrega_opc := false;

  tsDesenvolvedor.TabVisible := (ParamStr(2) = 'desenvolvedor');

  if not FileExists(ExtractFilePath(Application.ExeName)+'config/BD.mdb') then
  begin
    application.messagebox(PChar('Não foi possível localizar o Banco de Dados '''+ExtractFilePath(Application.ExeName)+'config\BD.mdb'''),TITULO,MB_OK+mb_iconerror);
    application.terminate;
  end;

  ADO.Connected := false;
  ADO.ConnectionString := 'Provider=Microsoft.Jet.OLEDB.4.0;Data Source='+ExtractFilePath(Application.ExeName)+'config\BD.mdb;Persist Security Info=False;Jet OLEDB:Database Password=bddbuscacdja';
  try
    ADO.Connected := true;
  except
    application.messagebox('Não foi possível conectar ao Banco de Dados.',TITULO,MB_OK+mb_iconerror);
    application.terminate;
  end;

  titulos_abas[0] := '';
  titulos_abas[1] := 'Coletâneas JA';
  titulos_abas[2] := 'Coletâneas Diversas';
  titulos_abas[3] := 'Coletâneas Personalizadas';
  titulos_abas[4] := 'Hinário Adventista';
  titulos_abas[5] := 'Liturgia';
  titulos_abas[6] := 'Buscar Músicas';
  titulos_abas[7] := 'Bíblia';
  titulos_abas[8] := 'Utilitários';
  titulos_abas[9] := 'Configurações';
  titulos_abas[10] := 'Ferramentas do Desenvolvedor';

  removeArqTemp();
  if DirectoryExists(ExtractFilePath(Application.ExeName)+'~temp')
    then RemoveDir(ExtractFilePath(Application.ExeName)+'~temp');

  resize := true;
  PageControl1.ActivePageIndex := 0;
  PageControl2.ActivePageIndex := 0;
  PageControl3.ActivePageIndex := 0;
  PageControl4.ActivePageIndex := 0;
  TabSheet14Show(Sender);
end;

procedure TfmIndex.fExibeColetaneas(Tipo: string);
var
  ScrollBox: TsScrollBox;
  GroupBox: TsGroupBox;
  Button: TsButton;
  gLeft,gTop,gWidth,gHeight: Integer;
  mLeft: integer;
  dirIMG: string;
  id: string;
  formWidth: Integer;
  bitmap: TBitmap;
  idimg: Integer;
begin
  qrSEL_COLETANEAS.Close;
  qrSEL_COLETANEAS.Parameters.ParamByName('TIPO').Value := Tipo;
  qrSEL_COLETANEAS.Open;

  ScrollBox := TsScrollBox(FindComponent('sbCol'+Tipo));
  formWidth := ScrollBox.Width;

  gLeft := 0;
  gTop := 10;
  gWidth := 165;
  gHeight := 190;

  while ((gLeft + gWidth + 10 + gWidth) < formWidth) do
    gLeft := gLeft + gWidth + 10;
  mLeft := trunc((formWidth-(gLeft + gWidth + 10))/2);
  gLeft := mLeft;

  while not qrSEL_COLETANEAS.Eof do
  begin
    id := qrSEL_COLETANEAS.FieldByName('ID').AsString;

    GroupBox := TsGroupBox(FindComponent('gb_'+id));
    GroupBox.Free;
    if Assigned(GroupBox) then
      continue;

    try
      GroupBox := TsGroupBox.Create(ScrollBox);
      with GroupBox do
      begin
        Parent := ScrollBox;
        Name := 'gb_'+id;
        if Tipo = 'JA'
          then Caption := ' '+qrSEL_COLETANEAS.FieldByName('ANO').AsString+' '
          else Caption := ' '+qrSEL_COLETANEAS.FieldByName('NOME').AsString+' ';
        Width := gWidth;
        Height := gHeight;
        Left := gLeft;
        Top := gTop;
      end;
    except
      with GroupBox do
      begin
        Width := gWidth;
        Height := gHeight;
        Left := gLeft;
        Top := gTop;
      end;
    end;

    dirIMG := ExtractFilePath(Application.ExeName)+'config\'+qrSEL_COLETANEAS.FieldByName('URL').AsString;
    Button := TsButton.Create(GroupBox);
    if FileExists(dirIMG) then
    begin
      dirIMG := ExtractFilePath(application.ExeName)+'config\'+qrSEL_COLETANEAS.FieldByName('IMAGEM').AsString;
      with Button do
      begin
        Parent := GroupBox;
        Name := 'sb_'+id;
        if Tipo = 'JA'
          then Caption := ' '+qrSEL_COLETANEAS.FieldByName('NOME').AsString+' '
          else Caption := '';
        Width := gWidth - 10;
        Height := gHeight - 20;
        Left := 5;
        Top := 15;
        Images := imCapas;
        ImageAlignment := iaTop;
        if (fileexists(dirImg) and (UpperCase(copy(dirIMG,length(dirIMG)-3,4)) = '.BMP')) then
        begin
          bitmap := TBitmap.Create;
          bitmap.LoadFromFile(dirIMG);
          bitmap.TransparentColor := clFuchsia;
          bitmap.Transparent := false;
          idimg := imCapas.Add(bitmap,bitmap);
          ImageIndex := idimg;
          bitmap.Free;
        end;
        Tag := qrSEL_COLETANEAS.FieldByName('ID').AsInteger;
        onClick := sbClick;
        PopupMenu := ppColetaneas;
      end;
    end
    else
    begin
      with Button do
      begin
        Parent := GroupBox;
        Name := 'sb_'+id;
        Caption := 'Baixar Coletânea';
        Width := gWidth - 10;
        Height := gHeight - 20;
        Left := 5;
        Top := 15;
        Tag := qrSEL_COLETANEAS.FieldByName('ID').AsInteger;
        onClick := sbBaixar;
      end;
    end;
    if ((gLeft + gWidth + 10 + gWidth) >= formWidth) then
    begin
      gLeft := mLeft;
      gTop := gTop + gHeight + 10;
    end
    else
      gLeft := gLeft + gWidth + 10;
    qrSEL_COLETANEAS.Next;
  end;
end;

procedure TfmIndex.sbClick(Sender: TObject);
var
  URL: string;
  ID: integer;
begin
  StatusMSG('Aguarde...');
  ID := TComponent(Sender).Tag;

  qrSEL_COLETANEAS_ID.Close;
  qrSEL_COLETANEAS_ID.Parameters.ParamByName('ID').Value := ID;
  qrSEL_COLETANEAS_ID.Open;

  URL := ExtractFilePath(Application.ExeName)+'config\'+qrSEL_COLETANEAS_ID.FieldByName('URL').AsString;
  StatusMSG('Aguarde... Carregando Coletânea '''+qrSEL_COLETANEAS_ID.FieldByName('NOME').AsString+''' ('+URL+')');

  if not FileExists(URL) then
  begin
    StatusMSG('Coletânea não localizada...');
    application.MessageBox(PChar('Não foi possível localizar a coletânea '''+URL+'''!'),TITULO,mb_ok + mb_iconerror);
    StatusMSG;
    exit;
  end;
  lmdEXEC.Command := URL;
  lmdEXEC.Execute;
  StatusMSG;
end;

procedure TfmIndex.FormActivate(Sender: TObject);
begin
  if (loadCol.Strings.Values['MENU'] <> 'ok') then
  begin
    loadCol.Strings.Values['MENU'] := 'ok';

    barraTitulo.Items[0].Visible := False;
    application.Title := TITULO;
    Caption := TITULO;

    sPanel10.Color := $00623D0B;

    opSort_Ini.text := '1';
    opSort_Fin.text := '50';

    tCronoT := 0;
    passag := 0;

    TabSheet14Show(Sender);

    carregaParams();
    verVersao();

    if (trim(ParamStr(2)) <> '') then
    begin
      paramAtualiz.Strings.Text := DecodeBase64(ParamStr(2));
      if (trim(paramAtualiz.Strings.Values['aba']) <> '') then PageControl1.ActivePageIndex := StrToInt(paramAtualiz.Strings.Values['aba']);
      if (ParamStr(3) = '1')
        then Application.MessageBox(PChar(paramAtualiz.Strings.Values['label']+' atualizado com sucesso!'),TITULO,mb_ok+mb_iconinformation)
        else if (ParamStr(3) <> '') then
          Application.MessageBox(PChar('Houve um erro ao tentar atualizar '+paramAtualiz.Strings.Values['label']+'!'+#13+
                                          'Tente novamente mais tarde, ou baixe o arquivo diretamente do blog http://louvorja.blogspot.com.br.'+#13+
                                          'Se preferir, envie um e-mail para louvorja@outlook.com.'),TITULO,mb_ok+mb_iconerror);

    end;

    if (loadCol.Strings.Values['BIBLIA'] <> 'ok') then WBLoadHTML(wbBiblia,'');
    if (loadCol.Strings.Values['BIBLIA_BUSCA'] <> 'ok') then WBLoadHTML(wbLocaliza,'');
  end;    
end;

procedure TfmIndex.StatusMSG(Mensagem: string);
begin
  StatusBar1.Panels[0].Text := Mensagem;
end;

procedure TfmIndex.ppColetaneasPopup(Sender: TObject);
var
  mItem : TMenuItem;
  ID: integer;
  pValor: string;
begin
  ppColetaneas.Items.Clear;

  pValor := ppColetaneas.PopupComponent.Name;
  ID := strtoint(copy(pValor,pos('_',pValor)+1,length(pValor)));

  qrSEL_MUSICAS_ID.Close;
  qrSEL_MUSICAS_ID.Parameters.ParamByName('ID').Value := ID;
  qrSEL_MUSICAS_ID.Open;

  if TMenuItem('pp_'+pValor) <> nil then
  begin
    mItem := TMenuItem.Create(Self);
    mItem.Caption := 'Abrir Álbum "'+qrSEL_MUSICAS_ID.fieldbyname('ALBUM_NOME').AsString+'"';
    mItem.Name := 'pp_'+pValor;
    mItem.OnClick := sbClick;
    mItem.Tag := qrSEL_MUSICAS_ID.fieldbyname('ALBUM').AsInteger;
    mItem.ImageIndex := 2;
    ppColetaneas.Items.Add(mItem);
  end;
  if TMenuItem('pp_'+pValor+'_') <> nil then
  begin
    mItem := TMenuItem.Create(Self);
    mItem.Caption := '-';
    mItem.Name := 'pp_'+pValor+'_';
    ppColetaneas.Items.Add(mItem);
  end;

  qrSEL_MUSICAS_ID.First;
  while not qrSEL_MUSICAS_ID.Eof do
  begin
    if TMenuItem('pp_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString) <> nil then
    begin
      mItem := TMenuItem.Create(Self);
      mItem.Caption := qrSEL_MUSICAS_ID.fieldbyname('FAIXA').AsString+'. '+qrSEL_MUSICAS_ID.fieldbyname('NOME').AsString;
      mItem.Name := 'pp_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString;
      mItem.ImageIndex := 7;
      ppColetaneas.Items.Add(mItem);

      if (TMenuItem('pp_url_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString) <> nil) then
      begin
        mItem := TMenuItem.Create(Self);
        mItem.Caption := 'Cantada';
        mItem.Name := 'pp_url_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString;
        mItem.ImageIndex := 1;
        mItem.OnClick := sbOpenMusica;
        mItem.Enabled := not (trim(qrSEL_MUSICAS_ID.fieldbyname('URL').AsString) = '');
        ppColetaneas.Items[ppColetaneas.Items.Count-1].Add(mItem);
      end;

      if (TMenuItem('pp_urlins_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString) <> nil) then
      begin
        mItem := TMenuItem.Create(Self);
        mItem.Caption := 'Instrumental';
        mItem.Name := 'pp_urlins_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString;
        mItem.ImageIndex := 6;
        mItem.OnClick := sbOpenMusica;
        mItem.Enabled := not (trim(qrSEL_MUSICAS_ID.fieldbyname('URL_INSTRUMENTAL').AsString) = '');
        ppColetaneas.Items[ppColetaneas.Items.Count-1].Add(mItem);
      end;

      if (TMenuItem('pp_letra_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString) <> nil) then
      begin
        mItem := TMenuItem.Create(Self);
        mItem.Caption := 'Letra';
        mItem.Name := 'pp_letra_'+qrSEL_MUSICAS_ID.fieldbyname('ID').AsString;
        mItem.ImageIndex := 5;
        mItem.OnClick := sbOpenMusica;
        mItem.Enabled := not (trim(qrSEL_MUSICAS_ID.fieldbyname('LETRA').AsString) = '');
        ppColetaneas.Items[ppColetaneas.Items.Count-1].Add(mItem);
      end;

    end;
    qrSEL_MUSICAS_ID.Next;
  end;
end;

procedure TfmIndex.sbOpenMusica(Sender: TObject);
var
  mComponente,mCPar: String;
  i,ID: integer;
begin
  StatusMSG('Aguarde...');
  if (Sender is TMenuItem) then
    mComponente := TMenuItem(Sender).Name;

  mCPar := '';
  for i := Length(mComponente) downto 1 do
  begin
    if mComponente[i] = '_' then break;
    mCPar := mComponente[i]+mCPar;
  end;
  ID := strtoint(mCPar);

  mCPar := '';
  for i := (Length(mComponente)-length(inttostr(ID))-1) downto 1 do
  begin
    if mComponente[i] = '_' then break;
    mCPar := mComponente[i]+mCPar;
  end;

  qrSEL_MUSICAS_IDMUS.Close;
  qrSEL_MUSICAS_IDMUS.Parameters.ParamByName('ID').Value := ID;
  qrSEL_MUSICAS_IDMUS.Open;

  if (mCPar = 'url') then
    abreMusica(ExtractFilePath(Application.ExeName)+'config\'+qrSEL_MUSICAS_IDMUS.FieldByName('PASTA').AsString+'\'+qrSEL_MUSICAS_IDMUS.FieldByName('URL').AsString)
  else if (mCPar = 'urlins') then
    abreMusica(ExtractFilePath(Application.ExeName)+'config\'+qrSEL_MUSICAS_IDMUS.FieldByName('PASTA').AsString+'\'+qrSEL_MUSICAS_IDMUS.FieldByName('URL_INSTRUMENTAL').AsString)
  else if (mCPar = 'letra') then
  begin
    abreLetra(qrSEL_MUSICAS_IDMUS.FieldByName('ID').AsInteger);
  end;
end;

procedure TfmIndex.TabSheet3Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['HASD'] <> 'ok') then
  begin
    loadCol.Strings.Values['HASD'] := 'ok';

    if ((param.Strings.Values['metodo_download'] = 'link') or (param.Strings.Values['internet_conexao'] = '0') or (param.Strings.Values['internet_conexao'] = '-1'))
      then sButton6.Visible := False
      else sButton6.Visible := True;
    cbExtensaoHinosHinario.Items := cbExtensaoHinos.Items;
    cbExtensaoHinosHinario.ItemIndex := cbExtensaoHinosHinario.Items.IndexOf(lerParam('Hinario','Formato','pps'));

    txtHino.Width := gbHino.Width - 20;
    dbGrid1.Columns[1].Width := dbGrid1.Width - dbGrid1.Columns[0].Width - 20;

    txtHino.Text := '';
    qrHINOS.Close;
    qrHINOS.Open;

    stHinos.Panels[1].text := qtHinos;
  end;
  txtHino.SetFocus;
end;

procedure TfmIndex.txtHinoChange(Sender: TObject);
var
  valor: string;
  nr: integer;
  c: integer;
begin
  reHino.Visible := False;
  valor := trim(txtHino.Text);
  if trim(valor) = '' then
  begin
    qrHinos.Filter := '';
    stHinos.Panels[0].text := '';
    stHinos.Panels[1].text := qtHinos;
    corCampoBusca(qrHinos,txtHino);
    exit;
  end;

  val(txtHino.Text,nr,c);
  if c = 0 then
  begin
    qrHinos.filter := 'FAIXA = '+valor;
    stHinos.Panels[0].text := 'Buscando nº: '+valor;
  end
  else
  begin
    qrHinos.filter := 'NOME LIKE ''%'+valor+'%''';
    stHinos.Panels[0].text := 'Buscando nome: '''+valor+'''';
  end;

  if (qrHINOS.RecordCount = 1) then
  begin
    reHino.Lines.Clear;
    reHino.Text := qrHINOS.fieldbyname('LETRA').AsString;
    reHino.Left := DBGrid1.Left;
    reHino.Width := DBGrid1.Width - 19;
    reHino.Top := DBGrid1.Top + 43;
    reHino.Height := DBGrid1.Height - 43;
    formataTexto(reHino);
    reHino.Visible := true;
  end
  else
  begin
    reHino.Visible := False;
  end;

  corCampoBusca(qrHinos,txtHino);
  stHinos.Panels[1].text := qtHinos;
end;

procedure TfmIndex.corCampoBusca(Query: TADOQuery; Campo: TEdit);
begin
  if (Query.Active = false) or (Query.RecordCount > 0)
    then Campo.Font.Color := clBlack
    else Campo.Font.Color := clRed;
end;

function TfmIndex.qtHinos: string;
begin
  if qrHinos.RecordCount > 1 then
    result := inttostr(qrHinos.RecordCount)+' hinos encontrados    '
  else if qrHinos.RecordCount = 1 then
    result := inttostr(qrHinos.RecordCount)+' hino encontrado    '
  else
    result := 'Nenhum hino encontrado    ';
end;

procedure TfmIndex.DBGrid1DblClick(Sender: TObject);
var
  url_musica: string;
begin
  if qrHINOS.RecordCount <= 0 then
  begin
    application.MessageBox('Hino não encontrado!',TITULO,mb_ok+mb_iconerror);
    txtHino.SetFocus;
    Exit;
  end;

  url_musica := ChangeFileExt(ExtractFilePath(application.ExeName)+'config\'+qrHINOS.fieldbyname('URL_ALBUM').AsString,'.'+cbExtensaoHinosHinario.Items[cbExtensaoHinosHinario.itemIndex]);

  if not FileExists(url_musica) then
  begin
    application.MessageBox(PChar('Não foi possível localizar o arquivo '''+url_musica+''''),titulo,mb_ok+mb_iconerror);
    txtHino.SetFocus;
    Exit;
  end;


  lmdEXEC.Command := url_musica;
  lmdEXEC.Execute;
end;

procedure TfmIndex.txtHinoKeyPress(Sender: TObject; var Key: Char);
begin
  if key = #13 then
  begin
    key := #0;
    DBGrid1DblClick(Sender);
  end;
end;

procedure TfmIndex.DBGrid1DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
var
  S: string;
  R: TRect;
begin
  with DBGrid1.Canvas do
  begin
    FillRect(Rect);
    S := Column.Field.AsString;
    R := Rect;
    R.Top := R.Top + trunc(trunc((R.Bottom-R.Top)/2)/2);
    R.Left := R.Left + 5;
    R.Right := R.Right - 5;

    if (gdSelected in State) or (gdFocused in State)
      then Brush.Color := $00f7e0c9
    else
      if odd(qrHINOS.RecNo) then
        Brush.Color := $00F7F7F7
      else
        Brush.Color := clWhite;

    Font.Color := Brush.Color;
    TDbGrid(Sender).DefaultDrawDataCell(Rect, TDbGrid(Sender).columns[datacol].field, State);

    Font.Color := clBlack;
    if Column.Index = 0 then
      DrawText(Handle, PChar(S), Length(S), R, DT_RIGHT)
    else
      DrawText(Handle, PChar(S), Length(S), R, DT_LEFT);
  end;
end;

procedure TfmIndex.abreLetra(ID: integer;BUSCA: string);
begin
  Application.CreateForm(TfLetra,fLetra);
  fLetra.id_mus := ID;
  fLetra.txtLocaliz.Text := BUSCA;
  fLetra.txtLocalizChange(nil);
  fLetra.ShowModal;
  StatusMSG;
end;

procedure TfmIndex.abreMusica(URL, Tipo: string);
begin
  if trim(URL) = '' then
    exit;

  StatusMSG('Aguarde...');
  if not FileExists(URL) then
  begin
    if Tipo = 'musica' then
    begin
      StatusMSG('Música não localizada...');
      application.MessageBox(PChar('Não foi possível localizar a música '''+URL+'''!'),fmIndex.TITULO,mb_ok + mb_iconerror);
    end
    else if Tipo = 'album' then
    begin
      StatusMSG('Coletânea não localizada...');
      application.MessageBox(PChar('Não foi possível localizar a coletânea '''+URL+'''!'),fmIndex.TITULO,mb_ok + mb_iconerror);
    end;
    StatusMSG;
    exit;
  end;
  lmdEXEC.Command := URL;
  lmdEXEC.Execute;
  StatusMSG;
end;

procedure TfmIndex.TabSheet1Show(Sender: TObject);
var
  i: Integer;
begin
  if (loadCol.Strings.Values['JA'] <> 'ok') then
  begin
    loadCol.Strings.Values['JA'] := 'ok';

    for i := sbColJA.ComponentCount-1 downto 0 do
      sbColJA.Components[i].Free;

    fExibeColetaneas('JA');
  end;
end;

procedure TfmIndex.TabSheet2Show(Sender: TObject);
var
  i: integer;
begin
  if (loadCol.Strings.Values['DIV'] <> 'ok') then
  begin
    loadCol.Strings.Values['DIV'] := 'ok';

    for i := sbColDIV.ComponentCount-1 downto 0 do
      sbColDIV.Components[i].Free;

    fExibeColetaneas('DIV');
  end;
end;

procedure TfmIndex.ApplicationEvents1Message(var Msg: tagMSG;
  var Handled: Boolean);
var
  i: SmallInt;
begin
//  If (Msg.Message = WM_RBUTTONDOWN) Then Handled := True;

  if Msg.message = WM_MOUSEWHEEL then
  begin
    Msg.message := WM_KEYDOWN;
    Msg.lParam := 0;
    i := HiWord(Msg.wParam) ;
    if i > 0 then
      Msg.wParam := VK_UP
    else
      Msg.wParam := VK_DOWN;
    Handled := False;
  end;
end;

procedure TfmIndex.Localizar1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet4;
  PageControl1Change(Sender);  
end;

procedure TfmIndex.TabSheet4Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['BUSCA'] <> 'ok') then
  begin
    loadCol.Strings.Values['BUSCA'] := 'ok';
    txtBusca.Width := gbBusca.Width - 20;
    dbGrid2.Columns[1].Width := dbGrid2.Width - dbGrid2.Columns[0].Width - 20;
    txtBusca.Text := '';

    qrBUSCA.Close;
    qrBUSCA.Open;
  end;
  txtBusca.SetFocus;
end;

procedure TfmIndex.Hinrio1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet3;
  PageControl1Change(Sender);
end;

procedure TfmIndex.JA1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet1;
  PageControl1Change(Sender);
end;

procedure TfmIndex.Diversas1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet2;
  PageControl1Change(Sender);  
end;

procedure TfmIndex.Utilitrios1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet5;
  PageControl1Change(Sender);  
end;

procedure TfmIndex.txtBuscaChange(Sender: TObject);
var
  valor: string;
  filtro: string;
begin
  reBusca.Visible := False;
  valor := trim(txtBusca.Text);

  filtro := '';
  if (trim(valor) <> '') then
  begin
    if rbFiltro2.Checked
      then filtro := '(NOME LIKE ''%'+valor+'%'' OR LETRA LIKE ''%'+valor+'%'')'
      else filtro := 'NOME LIKE ''%'+valor+'%''';
  end;

  if (rbIdioma1.Checked = false) and (trim(valor) <> '')
    then filtro := filtro + ' AND ';

  if (rbIdioma2.Checked) then filtro := filtro + ' IDIOMA = ''PT'''
  else if (rbIdioma3.Checked) then filtro := filtro + ' IDIOMA = ''EN'''
  else if (rbIdioma4.Checked) then filtro := filtro + ' IDIOMA = ''ES''';

  qrBUSCA.Filter := filtro;

  if (qrBUSCA.RecordCount = 1) then
  begin
    reBusca.Lines.Clear;
    reBusca.Text := qrBUSCA.fieldbyname('LETRA').AsString;
    reBusca.Left := DBGrid2.Left;
    reBusca.Width := DBGrid2.Width - 19;
    reBusca.Top := DBGrid2.Top + 43;
    reBusca.Height := DBGrid2.Height - 43;
    formataTexto(reBusca);
    reBusca.Visible := true;
  end
  else
  begin
    reBusca.Visible := False;
  end;

  corCampoBusca(qrBUSCA,txtBusca);
  pnlStatusBuscaMusicas.Panels[1].Text := qtBusca;
end;

procedure TfmIndex.rbFiltro1Click(Sender: TObject);
begin
  txtBuscaChange(Sender);
end;

function TfmIndex.qtBusca: string;
begin
  if qrBUSCA.RecordCount > 1 then
    result := inttostr(qrBUSCA.RecordCount)+' músicas encontradas    '
  else if qrBUSCA.RecordCount = 1 then
    result := inttostr(qrBUSCA.RecordCount)+' música encontrada    '
  else
    result := 'Nenhuma música encontrada    ';
end;

procedure TfmIndex.DBGrid2DblClick(Sender: TObject);
var
  url_musica: string;
begin
  if qrBUSCA.Active = false then
    exit;

  if qrBUSCA.RecordCount <= 0 then
  begin
    application.MessageBox('Música não encontrada!',TITULO,mb_ok+mb_iconerror);
    txtBusca.SetFocus;
    Exit;
  end;

  if (qrBUSCA.fieldbyname('TIPO').AsString = 'HASD') then
    url_musica := ChangeFileExt(ExtractFilePath(application.ExeName)+'config\'+qrBUSCA.fieldbyname('URL_ALBUM').AsString,'.'+lerParam('Hinario','Formato','pps'))
  else
    url_musica := ExtractFilePath(application.ExeName)+'config\'+qrBUSCA.fieldbyname('URL_ALBUM').AsString;

  if not FileExists(url_musica) then
  begin
    application.MessageBox(PChar('Não foi possível localizar o arquivo '''+url_musica+''''),titulo,mb_ok+mb_iconerror);
    txtBusca.SetFocus;
    Exit;
  end;

  lmdEXEC.Command := url_musica;
  lmdEXEC.Execute;
end;

procedure TfmIndex.txtBuscaKeyPress(Sender: TObject; var Key: Char);
begin
  if key = #13 then
  begin
    key := #0;
    DBGrid2DblClick(Sender);
  end;
end;

procedure TfmIndex.DBGrid2DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
var
  S: string;
  R: TRect;
begin
  with DBGrid2.Canvas do
  begin
    FillRect(Rect);
    S := Column.Field.AsString;
    R := Rect;
    R.Top := R.Top + trunc(trunc((R.Bottom-R.Top)/2)/2);
    R.Left := R.Left + 5;
    R.Right := R.Right - 5;

    if (gdSelected in State) or (gdFocused in State)
      then Brush.Color := $00f7e0c9
    else
      if odd(qrBUSCA.RecNo) then
        Brush.Color := $00F7F7F7
      else
        Brush.Color := clWhite;

    Font.Color := Brush.Color;
    TDbGrid(Sender).DefaultDrawDataCell(Rect, TDbGrid(Sender).columns[datacol].field, State);

    Font.Color := clBlack;
    DrawText(Handle, PChar(S), Length(S), R, DT_LEFT);
  end;
end;

procedure TfmIndex.SpeedButton1Click(Sender: TObject);
var
  i: integer;
  Item: TListItem;
begin
  if tmrSorteio.Enabled = false then tmrSorteio.Enabled := true;

  for i := strtoint(opSort_Ini.text) to strtoint(opSort_Fin.text) do
  begin
    Item := lbSort_D.Items.Add();
    Item.Caption := formatfloat('0000',i);
    if monitorAtivo(4) then
    begin
      Item := fMonitor.lbSort_D.Items.Add();
      Item.Caption := formatfloat('0000',i);
    end;
  end;
  RemoveDuplicadasListBox(lbSort_D);
  if monitorAtivo(4) then RemoveDuplicadasListBox(fMonitor.lbSort_D);
  SorteioContador();
end;

procedure TfmIndex.RemoveDuplicadasListBox(ListView: TsListView);
var
  i: Integer;
  u: string;
begin
  u := '';
  for i := ListView.items.Count-1 downto 0 do
  begin
    if (ListView.Items[i].Caption = u)
      then ListView.Items[i].Delete
      else u := ListView.Items[i].Caption;
  end;
end;

procedure TfmIndex.ToolButton1Click(Sender: TObject);
begin
  if monitorAtivo(4)
    then RemoveItemListBox(lbSort_D,fMonitor.lbSort_D,4)
    else RemoveItemListBox(lbSort_D);
  SorteioContador();
end;

procedure TfmIndex.RemoveItemListBox(ListView: TsListView;MonitorListView: TsListView = nil;tag:integer = -1);
begin
  if ListView.Items.Count <= 0 then
  begin
    application.MessageBox('Não há nenhum item para ser removido!',TITULO,mb_ok+mb_iconexclamation);
    exit;
  end;

  if ListView.ItemIndex < 0 then
  begin
    application.MessageBox('Selecione um item para remover da lista!',TITULO,mb_ok+mb_iconexclamation);
    exit;
  end;

  ListView.DeleteSelected;
  if monitorAtivo(tag) then
  begin
    MonitorListView.Items.Clear;
    MonitorListView.Items := ListView.Items;
  end;
end;

procedure TfmIndex.ToolButton2Click(Sender: TObject);
begin
  if monitorAtivo(4)
    then RemoveItemListBox(lbSort_S,fMonitor.lbSort_S,4)
    else RemoveItemListBox(lbSort_S);
  SorteioContador();
end;

procedure TfmIndex.TransfereItemListView(ListViewA, ListViewB: TsListView; Topo: boolean;MonitorListViewA: TsListView = nil;MonitorListViewB: TsListView = nil;tag:integer = -1);
var
  i: integer;
  item: TListItem;
begin
  if ListViewA.Items.Count <= 0 then
  begin
    application.MessageBox('Não há nenhum item para ser transferido!',TITULO,mb_ok+mb_iconexclamation);
    exit;
  end;

  if ListViewA.ItemIndex < 0 then
  begin
    application.MessageBox('Selecione um item para transferir!',TITULO,mb_ok+mb_iconexclamation);
    exit;
  end;

  for i := ListViewA.Items.Count-1 downto 0 do
  begin
    if ListViewA.Items[i].Selected then
    begin
      if Topo = true
        then item := ListViewB.Items.Insert(0)
        else item := ListViewB.Items.Add();
      item.Caption := ListViewA.Items[i].Caption;

      ListViewA.Items[i].Delete;
    end;
  end;

  if (monitorAtivo(tag)) then
  begin
    MonitorListViewA.Items.Clear;
    MonitorListViewB.Items.Clear;
    MonitorListViewA.Items := ListViewA.Items;
    MonitorListViewB.Items := ListViewB.Items;
  end;

  SorteioContador();
end;

procedure TfmIndex.ToolButton3Click(Sender: TObject);
begin
  if monitorAtivo(4)
    then TransfereItemListView(lbSort_D,lbSort_S,true,fMonitor.lbSort_D,fMonitor.lbSort_S,4)
    else TransfereItemListView(lbSort_D,lbSort_S,true);
  SendMessage(lbSort_S.Handle, WM_VSCROLL, SB_TOP, 0);
  if monitorAtivo(4) then SendMessage(fMonitor.lbSort_S.Handle, WM_VSCROLL, SB_TOP, 0);
end;

procedure TfmIndex.ToolButton4Click(Sender: TObject);
begin
  if monitorAtivo(4)
    then TransfereItemListView(lbSort_S,lbSort_D,false,fMonitor.lbSort_S,fMonitor.lbSort_D,4)
    else TransfereItemListView(lbSort_S,lbSort_D,false);
  RemoveDuplicadasListBox(lbSort_D);
  if monitorAtivo(4) then RemoveDuplicadasListBox(fMonitor.lbSort_D);
  SorteioContador();
end;

procedure TfmIndex.tmrSorteioTimer(Sender: TObject);
var
  Rnd: integer;
begin
  if lbSort_D.Items.Count <= 0 then exit;

  Rnd := 0 + Random(lbSort_D.Items.Count);
  opNumSorteado.text := lbSort_D.Items[Rnd].Caption;
  opNumIndice.Text := IntToStr(Rnd);
end;

procedure TfmIndex.ToolButton6Click(Sender: TObject);
begin
  if application.messagebox(PChar('Deseja realmente reiniciar o sorteio?'+#13+'Todos os números sorteados voltarão para a lista de números disponíveis!'),TITULO,mb_yesno+mb_iconquestion) <> 6
    then exit;

  if tmrSorteio.Enabled = false then tmrSorteio.Enabled := true;

  lbSort_S.SelectAll;
  ToolButton4Click(Sender);
  lmdSorteio.Caption := '0000';
  if monitorAtivo(4) then fMonitor.lmdSorteio.Caption := lmdSorteio.Caption; 
end;

procedure TfmIndex.ToolButton7Click(Sender: TObject);
begin
  if application.messagebox(PChar('Deseja realmente zerar o sorteio?'+#13+'Todos os números disponívels e a sorteados serão apagados!'),TITULO,mb_yesno+mb_iconquestion) <> 6
    then exit;

  if tmrSorteio.Enabled = false then tmrSorteio.Enabled := true;

  lbSort_D.items.Clear;
  lbSort_S.items.Clear;
  lmdSorteio.Caption := '0000';
  if monitorAtivo(4) then
  begin
    fMonitor.lbSort_D.items.Clear;
    fMonitor.lbSort_S.items.Clear;
    fMonitor.lmdSorteio.Caption := lmdSorteio.Caption;
  end;
  SorteioContador();  
end;

procedure TfmIndex.SorteioContador;
begin
  if (lbSort_D.Items.Count <= 0)
    then lblNumDis.Caption := 'Disponíveis:'
    else lblNumDis.Caption := 'Disponíveis ('+inttostr(lbSort_D.Items.Count)+'):';

  if (lbSort_S.Items.Count <= 0)
    then lblNumSort.Caption := 'Sorteados:'
    else lblNumSort.Caption := 'Sorteados ('+inttostr(lbSort_S.Items.Count)+'):';

  if monitorAtivo(4) then
  begin
    fMonitor.lblNumDis.Caption := lblNumDis.Caption;
    fMonitor.lblNumSort.Caption := lblNumSort.Caption;
  end;
end;

procedure TfmIndex.tmrCronoTimer(Sender: TObject);
var
  MyHora,MyMinuto,MySegundo, MyMiliSegundo:Word;
  Segundos: integer;
begin
  if rbCronoDir.Checked then
  begin
    tCronoT := tCrono + Now - tCronoOld;
    lmdCrono.Caption := FormatDateTime('HH:MM:SS.ZZZ', tCrono + Now - tCronoOld);
    if (gCrono.MaxValue <= 1) then gCrono.MaxValue := 1000;
    gCrono.Progress := gCrono.Progress+1;
    gCrono.MaxValue := gCrono.MaxValue+2;
    if monitorAtivo(5) then
    begin
      fMonitor.lmdCrono.Caption := lmdCrono.Caption;
      fMonitor.gCrono.Progress := gCrono.Progress;
      fMonitor.gCrono.MaxValue := gCrono.MaxValue;
    end;
  end
  else
  begin
    tCronoT := tCrono - (Now - tCronoOld);
    lmdCrono.Caption := FormatDateTime('HH:MM:SS.ZZZ', tCrono - (Now - tCronoOld));

    DecodeTime(tCrono - (Now - tCronoOld),MyHora,MyMinuto,MySegundo,MyMiliSegundo);
    Segundos := MyMiliSegundo + (MySegundo * 1000) + (MyMinuto * 60000) + (MyHora * 3600000);
    if (Segundos > gCrono.MaxValue)
      then gCrono.MaxValue := Segundos;
    gCrono.Progress := Segundos;

    if monitorAtivo(5) then
    begin
      fMonitor.lmdCrono.Caption := lmdCrono.Caption;
      fMonitor.gCrono.Progress := gCrono.Progress;
      fMonitor.gCrono.MaxValue := gCrono.MaxValue;
    end;

    if tCronoT <= 0 then
    begin
      tmrCrono.enabled := false;
      lmdCrono.Caption := '00:00:00.000';
      if monitorAtivo(5) then fMonitor.lmdCrono.Caption := lmdCrono.Caption;
      PageControl1.ActivePage := TabSheet5;
      PageControl2.ActivePage := TabSheet7;
      application.messagebox('Tempo esgotado!',PChar(TITULO+' - Cronômetro'),mb_ok+mb_iconinformation);
      btZerarCronoClick(Sender);
    end;
  end;
end;

procedure TfmIndex.lbSort_DKeyPress(Sender: TObject; var Key: Char);
begin
  if key = #46 then
  begin
    key := #0;
    ToolButton1Click(Sender);
  end;
end;

procedure TfmIndex.lbSort_DKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = vk_Delete then
    ToolButton1Click(Sender);
end;

procedure TfmIndex.lbSort_SKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = vk_Delete then
    ToolButton2Click(Sender);
end;

procedure TfmIndex.opSort_IniKeyPress(Sender: TObject; var Key: Char);
begin
  if not (Key in['0'..'9']) and (Key <> #8) then Key := #0;
end;

procedure TfmIndex.rbCronoDirClick(Sender: TObject);
begin
  txtDecr.Enabled := not rbCronoDir.Checked;
  if txtDecr.Enabled then txtDecr.Setfocus;

  btZerarCronoClick(Sender);
end;

procedure TfmIndex.SpeedButton2Click(Sender: TObject);
var
  i,j,c: integer;
  url,file_url,dir_url,dir_purl: string;
  item: TListItem;
  err: boolean;
begin
  lvErros.Items.Clear;

  qrVALIDA_LINKS.Close;
  qrVALIDA_LINKS.Open;

  i := 0;
  j := 0;
  while not qrVALIDA_LINKS.Eof do
  begin
    err := false;
    file_url := (qrVALIDA_LINKS.fieldbyname('URL').AsString);
    for c := length(file_url) downto 0 do
      if copy(file_url,c,1) = '\' then break;
    file_url := copy(file_url,c+1,length(file_url));
    dir_url := copy(qrVALIDA_LINKS.fieldbyname('URL').AsString,0,length(qrVALIDA_LINKS.fieldbyname('URL').AsString)-length(file_url));
    dir_purl := copy(dir_url,pos('\',dir_url)+1,length(dir_url));

    url := extractfilepath(application.exename)+'config\'+qrVALIDA_LINKS.fieldbyname('URL').AsString;
    if not fileexists(url) then
    begin
      inc(i);
      if fileexists(extractfilepath(application.exename)+'config\'+file_url) then
      begin
        if not directoryexists(extractfilepath(application.exename)+'config\'+dir_url)
          then ForceDirectories(extractfilepath(application.exename)+'config\'+dir_url);
        err := true;
        movefile(PChar(extractfilepath(application.exename)+'config\'+file_url),
                 PChar(url));
        inc(j);
      end;
      if fileexists(extractfilepath(application.exename)+'config\'+dir_purl+file_url) then
      begin
        if not directoryexists(extractfilepath(application.exename)+'config\'+dir_url)
          then ForceDirectories(extractfilepath(application.exename)+'config\'+dir_url);
        err := true;
        movefile(PChar(extractfilepath(application.exename)+'config\'+dir_purl+file_url),
                 PChar(url));
        inc(j);
      end;
      if isfolderempty(extractfilepath(application.exename)+'config\'+dir_purl)
        then RemoveDir(extractfilepath(application.exename)+'config\'+dir_purl);

      if err <> true then
      begin
        item := lvErros.Items.Add();
        item.Caption := 'Não encontrado';
        item.ImageIndex := 14;
        item.SubItems.Add(qrVALIDA_LINKS.fieldbyname('TIPO').AsString);
        item.SubItems.Add(qrVALIDA_LINKS.fieldbyname('NOME').AsString);
        item.SubItems.Add(url);
      end
      else
      begin
        item := lvErros.Items.Add();
        item.Caption := 'Corrigido';
        item.ImageIndex := 13;
        item.SubItems.Add(qrVALIDA_LINKS.fieldbyname('TIPO').AsString);
        item.SubItems.Add(qrVALIDA_LINKS.fieldbyname('NOME').AsString);
        item.SubItems.Add(url);
      end;
    end;
    qrVALIDA_LINKS.Next;
  end;

  if i <= 0 then
    application.MessageBox('Todos os links estão corretos! A coletânea está funcionando sem problemas.',TITULO,mb_ok+mb_iconinformation)
  else
    application.MessageBox(PChar('Foram encontrados erros.'+#13+
                           'Links com problemas: '+inttostr(i)+#13+
                           'Links corrigidos: '+inttostr(j)),TITULO,mb_ok+mb_iconinformation);
end;

procedure TfmIndex.ToolButton15Click(Sender: TObject);
begin
  if tmrSorteio.Enabled = false then tmrSorteio.Enabled := true;

  lmdSorteio.Caption := '0000';
  if monitorAtivo(4) then fMonitor.lmdSorteio.Caption := lmdSorteio.Caption;
end;

procedure TfmIndex.ppGridPopup(Sender: TObject);
var
  Query: TADOQuery;
begin
  Query := TADOQuery(FindComponent(TDBGrid(FindComponent(ppGrid.PopupComponent.Name)).DataSource.DataSet.Name));
  if (Query.Active = false) or (Query.Eof) then
  begin
    migAlbum.Caption := 'Abrir Álbum';
    migSlide.Caption := 'Abrir Slide';
    migCantada.Caption := 'Cantada';
    migInstrumental.Caption := 'Instrumental';
    migLetra.Caption := 'Letra';
    migAlbum.Visible := not (ppGrid.PopupComponent.Name = 'DBGrid1');
    migSlide.Visible := (ppGrid.PopupComponent.Name = 'DBGrid1');

    migAlbum.Enabled := false;
    migSlide.Enabled := false;
    migCantada.Enabled := false;
    migInstrumental.Enabled := false;
    migLetra.Enabled := false;
    exit;
  end;

  migAlbum.Caption := 'Abrir Álbum "' + Query.FieldByName('NOME_ALBUM').AsString + '"';
  migSlide.Caption := 'Abrir Slide "' + Query.FieldByName('NOME_ALBUM').AsString + '"';
  migCantada.Caption := 'Música "'+Query.FieldByName('NOME').AsString+'"  - Cantada';
  migInstrumental.Caption := 'Música "'+Query.FieldByName('NOME').AsString+'"  - Instrumental';
  migLetra.Caption := 'Letra da Música "'+Query.FieldByName('NOME').AsString+'"';

  migAlbum.Enabled := true;
  migSlide.Enabled := true;
    
  migAlbum.Visible := not (Query.FieldByName('TIPO').AsString = 'HASD');
  migSlide.Visible := (Query.FieldByName('TIPO').AsString = 'HASD');
  migCantada.Enabled := not (trim(Query.FieldByName('URL').AsString) = '');
  migInstrumental.Enabled := not (trim(Query.FieldByName('URL_INSTRUMENTAL').AsString) = '');
  migLetra.Enabled := not (trim(Query.FieldByName('LETRA').AsString) = '');
end;

procedure TfmIndex.migCantadaClick(Sender: TObject);
var
  Query: TADOQuery;
begin
  Query := TADOQuery(FindComponent(TDBGrid(FindComponent(ppGrid.PopupComponent.Name)).DataSource.DataSet.Name));
  abreMusica(ExtractFilePath(Application.ExeName)+'config\'+Query.FieldByName('PASTA').AsString+'\'+Query.FieldByName('URL').AsString);
end;

procedure TfmIndex.migInstrumentalClick(Sender: TObject);
var
  Query: TADOQuery;
begin
  Query := TADOQuery(FindComponent(TDBGrid(FindComponent(ppGrid.PopupComponent.Name)).DataSource.DataSet.Name));
  abreMusica(ExtractFilePath(Application.ExeName)+'config\'+Query.FieldByName('PASTA').AsString+'\'+Query.FieldByName('URL_INSTRUMENTAL').AsString);
end;

procedure TfmIndex.migLetraClick(Sender: TObject);
var
  Query: TADOQuery;
  busca: string;
begin
  Query := TADOQuery(FindComponent(TDBGrid(FindComponent(ppGrid.PopupComponent.Name)).DataSource.DataSet.Name));
  if Query.Name = 'qrBUSCA'
    then busca := txtBusca.Text
    else busca := '';
  abreLetra(Query.FieldByName('ID').AsInteger,busca);
end;

procedure TfmIndex.migAlbumClick(Sender: TObject);
begin
  if ppGrid.PopupComponent.Name = 'DBGrid1' then DBGrid1DblClick(Sender)
  else
  if ppGrid.PopupComponent.Name = 'DBGrid2' then DBGrid2DblClick(Sender);
end;

procedure TfmIndex.sbBaixar(Sender: TObject);
var
  ID: Integer;
  URL: string;
begin
  ID := TComponent(Sender).Tag;

  qrSEL_COLETANEAS_ID.Close;
  qrSEL_COLETANEAS_ID.Parameters.ParamByName('ID').Value := ID;
  qrSEL_COLETANEAS_ID.Open;

  URL := ChangeFileExt(qrSEL_COLETANEAS_ID.fieldbyname('URL').AsString,'');

  if (fmIndex.param.Strings.Values['metodo_download'] = 'link') then
  begin
    if (Application.MessageBox('Link para baixar a coletânea não disponível.'+#13+
                               'Deseja se conectar ao site para baixar manualmente a coletâena?',TITULO,mb_yesno+mb_iconquestion) = 6)
      then ShellExecute(0, Nil, 'http://louvorja.blogspot.com.br/p/download.html', Nil, Nil, 0);
  end
  else if (trim(param.Strings.Values[URL]) = '') then
  begin
    if (Application.MessageBox(PChar('Não foi possível localizar o link para baixar a coletânea "'+qrSEL_COLETANEAS_ID.fieldbyname('NOME').AsString+'"!'+#13+
                               'Deseja se conectar ao site para baixar manualmente a coletâena?'),TITULO,mb_yesno+mb_iconquestion) = 6)
      then ShellExecute(0, Nil, 'http://louvorja.blogspot.com.br/p/download.html', Nil, Nil, 0);
  end
  else
  begin
    if (Application.MessageBox(PChar('Deseja baixar a coletânea "'+qrSEL_COLETANEAS_ID.fieldbyname('NOME').AsString+'"?'),TITULO,mb_yesno+mb_iconquestion) = 6) then
    begin
      BaixaColetanea(URL,'Coletânea '+qrSEL_COLETANEAS_ID.fieldbyname('NOME').AsString);
    end;
  end;
end;

function TfmIndex.isFolderEmpty(szPath: String): Boolean;
var
  res: TSearchRec;
begin
  szPath := IncludeTrailingBackslash(szPath);
  Result := (FindFirst(szPath + '*.*', faAnyFile - faDirectory, res) <> 0);
  FindClose(res);
end;

procedure TfmIndex.SpeedButton3Click(Sender: TObject);
begin
  ShellExecute(Application.HANDLE, 'open', PChar(ExtractFilePath(Application.ExeName)),nil,nil,SW_SHOWNORMAL);
end;

procedure TfmIndex.Sistema1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet8;
  PageControl1Change(Sender);  
end;

procedure TfmIndex.TabSheet10Show(Sender: TObject);
var
  i: integer;
  item: TListItem;
begin
  if (loadCol.Strings.Values['ATALHOS'] <> 'ok') then
  begin
    loadCol.Strings.Values['ATALHOS'] := 'ok';

    lvAtalhos.Columns[1].Width := lvAtalhos.Width - lvAtalhos.Columns[0].Width - 25;

    for i := 0 to MainMenu1.Items[0].Count-1 do
    begin
      if i > 0 then
      begin
        if MainMenu1.Items[0].Items[i].Caption = MainMenu1.Items[0].Items[i-1].Caption then
        begin
          item := lvAtalhos.Items[lvAtalhos.Items.Count-1];
          item.SubItems[0] := item.SubItems[0] + ' / ' + ShortCutToText(MainMenu1.Items[0].Items[i].ShortCut);
        end
        else
        begin
          item := lvAtalhos.Items.Add();
          item.Caption := MainMenu1.Items[0].Items[i].Caption;
          item.SubItems.Add(ShortCutToText(MainMenu1.Items[0].Items[i].ShortCut));
        end;
      end
      else
      begin
        item := lvAtalhos.Items.Add();
        item.Caption := MainMenu1.Items[0].Items[i].Caption;
        item.SubItems.Add(ShortCutToText(MainMenu1.Items[0].Items[i].ShortCut));
      end;
    end;
  end;
end;

procedure TfmIndex.Bblia1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet11;
  PageControl1Change(Sender);
end;

procedure TfmIndex.carregaCombo(TIPO: string);
begin
  cbLivro.Items.Clear;
  ckLivros.Items.Clear;
  if (TIPO = 'L') then
  begin
    qrBIBLIA.Active := false;
    qrBIBLIA.Active := true;
    while not qrBIBLIA.Eof do
    begin
      cbLivro.Items.Add(qrBIBLIA.FieldByName('LIVRO').AsString);
      ckLivros.Items.Add(qrBIBLIA.FieldByName('LIVRO').AsString);
      ckLivros.Checked[ckLivros.Items.Count-1] := true;
      qrBIBLIA.Next;
    end;
  end;
end;

procedure TfmIndex.cbLivroKeyPress(Sender: TObject; var Key: Char);
begin
  if (Key = #13) then
  begin
    gravaPassagem();  
    geraPassagem();
    Key := #0;
    exit;
  end;
end;

function TfmIndex.IsNumeric(S: String): boolean;
var 
  i: integer;
begin
  Result := TryStrToInt(S, i);
end;

procedure TfmIndex.geraPassagem(acao: string = '';alertas: boolean = True);
var
  verso,texto: string;
  p,v,v2,passagem: string;
  i,min,max,pmin,pmax: integer;
  html,htmlE: string;

  p_livro,p_capitulo,p_versiculo,p_versao: string;
begin
  WBLoadHTML(wbBiblia,'');
  if (monitorAtivo(1)) then WBLoadHTML(fMonitor.wbBiblia,'');

  p_livro := loadCol.Strings.Values['BIBLIA:LIVRO'];
  p_capitulo := loadCol.Strings.Values['BIBLIA:CAPITULO'];
  p_versiculo := loadCol.Strings.Values['BIBLIA:VERSO'];
  p_versao := loadCol.Strings.Values['BIBLIA:VERSAO'];

  if (trim(p_livro) = '') then
  begin
    if (alertas) then
    begin
      application.MessageBox('Selecione o Livro!',TITULO,mb_ok+mb_iconexclamation);
      cbLivro.setfocus;
    end;
    exit;
  end;

  passagem := '';
  pmin := 9999;
  pmax := 0;
  p := IfThen(trim(p_versiculo) = '','1-200',p_versiculo)+',';
  while (pos(',',p) > 0) do
  begin
    v := copy(p,0,pos(',',p)-1);
    if (trim(v) <> '') then
    begin
      if (pos('-',v) <= 0) then
      begin
        if (strtoint(v) < pmin) then pmin := strtoint(v);
        if (strtoint(v) > pmax) then pmax := strtoint(v);
        passagem := passagem + v + ',';
      end
      else
      begin
        min := 9999;
        max := 0;
        v := v + '-';
        while (pos('-',v) > 0) do
        begin
          v2 := copy(v,0,pos('-',v)-1);
          if (trim(v2) <> '') then
          begin
            if (strtoint(v2) < min) then min := strtoint(v2);
            if (strtoint(v2) > max) then max := strtoint(v2);
            if (strtoint(v2) < pmin) then pmin := strtoint(v2);
            if (strtoint(v2) > pmax) then pmax := strtoint(v2);
          end;
          v := copy(v,pos('-',v)+1,length(v));
        end;
        for i := min to max do passagem := passagem + inttostr(i) + ',';
      end;
    end;
    p := copy(p,pos(',',p)+1,length(p));
  end;
  passagem := copy(passagem,0,length(passagem)-1);

  pmin := pmin-1;
  pmax := pmax+1;
  if (acao = '-') then
  begin
    qrPassagem.Close;
    qrPassagem.SQL.Clear;
    qrPassagem.SQL.Add('SELECT BIBLIA.VERSICULO,BIBLIA.PASSAGEM FROM BIBLIA,LIVRO');
    qrPassagem.SQL.Add('WHERE');
    qrPassagem.SQL.Add('BIBLIA.LIVRO = LIVRO.ID');
    qrPassagem.SQL.Add('AND BIBLIA.VERSAO = "'+p_versao+'"');
    qrPassagem.SQL.Add('AND LIVRO.LIVRO LIKE "'+p_livro+'"');
    qrPassagem.SQL.Add('AND BIBLIA.CAPITULO = '+p_capitulo);
    qrPassagem.SQL.Add('AND BIBLIA.VERSICULO IN ('+inttostr(pmin)+')');
    qrPassagem.SQL.Add('ORDER BY');
    qrPassagem.SQL.Add('BIBLIA.VERSICULO');
    qrPassagem.Open;

    if qrPassagem.Eof
      then acao := ''
    else
    begin
      cbLivro.Text := p_livro;
      txtCapitulo.Text := p_capitulo;
      txtVersiculo.Text := inttostr(pmin);
      dbVersao.Items.IndexOf(p_versao);
      loadCol.Strings.Values['BIBLIA:VERSO'] := txtVersiculo.Text;
    end;
  end
  else if (acao = '+') then
  begin
    qrPassagem.Close;
    qrPassagem.SQL.Clear;
    qrPassagem.SQL.Add('SELECT BIBLIA.VERSICULO,BIBLIA.PASSAGEM FROM BIBLIA,LIVRO');
    qrPassagem.SQL.Add('WHERE');
    qrPassagem.SQL.Add('BIBLIA.LIVRO = LIVRO.ID');
    qrPassagem.SQL.Add('AND BIBLIA.VERSAO = "'+p_versao+'"');
    qrPassagem.SQL.Add('AND LIVRO.LIVRO LIKE "'+p_livro+'"');
    qrPassagem.SQL.Add('AND BIBLIA.CAPITULO = '+p_capitulo);
    qrPassagem.SQL.Add('AND BIBLIA.VERSICULO IN ('+inttostr(pmax)+')');
    qrPassagem.SQL.Add('ORDER BY');
    qrPassagem.SQL.Add('BIBLIA.VERSICULO');
    qrPassagem.Open;

    if qrPassagem.Eof
      then acao := ''
    else
    begin
      cbLivro.Text := p_livro;
      txtCapitulo.Text := p_capitulo;
      txtVersiculo.Text := inttostr(pmax);
      dbVersao.Items.IndexOf(p_versao);
      loadCol.Strings.Values['BIBLIA:VERSO'] := txtVersiculo.Text;      
    end;
  end;

  if (acao = '') then
  begin
    qrPassagem.Close;
    qrPassagem.SQL.Clear;
    qrPassagem.SQL.Add('SELECT BIBLIA.VERSICULO,BIBLIA.PASSAGEM FROM BIBLIA,LIVRO');
    qrPassagem.SQL.Add('WHERE');
    qrPassagem.SQL.Add('BIBLIA.LIVRO = LIVRO.ID');
    qrPassagem.SQL.Add('AND BIBLIA.VERSAO = "'+p_versao+'"');
    qrPassagem.SQL.Add('AND LIVRO.LIVRO LIKE "'+p_livro+'"');
    qrPassagem.SQL.Add('AND BIBLIA.CAPITULO = '+p_capitulo);
    qrPassagem.SQL.Add('AND BIBLIA.VERSICULO IN ('+passagem+')');
    qrPassagem.SQL.Add('ORDER BY');
    qrPassagem.SQL.Add('BIBLIA.VERSICULO');
    qrPassagem.Open;
  end;

  html := '';
  htmlE := '';

  if (qrPassagem.Eof) then
  begin
    if (alertas) then
    begin
      application.MessageBox(PChar('Passagem "'+p_livro+' '+p_capitulo+ifThen(trim(p_versiculo) <> '',':'+p_versiculo)+'" não encontrada!'),TITULO,mb_ok+mb_iconexclamation);
      cbLivro.setfocus;
    end;
    exit;
  end
  else
  begin
    html := html + '<font face="'+lerParam('Biblia','Fonte',fonte)+'"><table width="100%" height="100%"><tr><td colspan=2 style= "font-size:'+lerParam('Biblia','Tamanho Titulo','36')+'px"><b><font color="'+colortohtml(StringToColor(lerParam('Biblia','Cor Titulo','$00dbb497')))+'">' + p_livro+' '+p_capitulo + '</font></b></td></tr><tr><td style= "font-size:'+lerParam('Biblia','Tamanho','36')+'px;height:100%;">';
    htmlE := htmlE + '<font face="'+lerParam('Biblia','Fonte',fonte)+'"><table width="100%" height="100%"><tr><td colspan=2 style= "font-size:'+lerParam('Biblia','Tamanho Titulo (Extendido)','36')+'px"><b><font color="'+colortohtml(StringToColor(lerParam('Biblia','Cor Titulo','$00dbb497')))+'">' + p_livro+' '+p_capitulo + '</font></b></td></tr><tr><td style= "font-size:'+lerParam('Biblia','Tamanho (Extendido)','36')+'px;height:100%;">';
    while not qrPassagem.Eof do
    begin
      verso := qrPassagem.fieldbyname('VERSICULO').AsString;
      texto := qrPassagem.fieldbyname('PASSAGEM').AsString;

      html := html + '<b><font color="'+ColorToHtml(StringToColor(lerParam('Biblia','Cor Versos','$00dbb497')))+'">'+verso+'</font></b> <font color="'+ColorToHtml(StringToColor(lerParam('Biblia','Cor','clBlack')))+'">'+texto+'</font><br>';
      htmlE := htmlE + '<b><font color="'+ColorToHtml(StringToColor(lerParam('Biblia','Cor Versos','$00dbb497')))+'">'+verso+'</font></b> <font color="'+ColorToHtml(StringToColor(lerParam('Biblia','Cor','clBlack')))+'">'+texto+'</font><br>';

      qrPassagem.Next;
    end;

    html := html + '</td></tr><tr><td colspan=2 style="text-align:right" style= "font-size:'+lerParam('Biblia','Tamanho Versao','36')+'px"><b><font color="'+colortohtml(StringToColor(lerParam('Biblia','Cor Versao','$00dbb497')))+'">' + dbVersao.Items[dbVersao.itemIndex] + '</font></b></td></tr></table></font>';
    htmlE := htmlE + '</td></tr><tr><td colspan=2 style="text-align:right" style= "font-size:'+lerParam('Biblia','Tamanho Versao (Extendido)','36')+'px"><b><font color="'+colortohtml(StringToColor(lerParam('Biblia','Cor Versao','$00dbb497')))+'">' + dbVersao.Items[dbVersao.itemIndex] + '</font></b></td></tr></table></font>';
    
    WBLoadHTML(wbBiblia,html);
    if (monitorAtivo(1)) then WBLoadHTML(fMonitor.wbBiblia,htmlE);

    if (alertas) then txtVersiculo.setfocus;
  end;
end;

procedure TfmIndex.txtVersiculoKeyPress(Sender: TObject; var Key: Char);
begin
  if (Key = #13) then
  begin
    gravaPassagem();  
    geraPassagem();
    Key := #0;
    exit;
  end;

  if (Key = #8) and (trim(txtVersiculo.text) = '') then
  begin
    txtCapitulo.setfocus;
    Key := #0;
    exit;
  end;

  if (Key <> '-') and (Key <> ',') and (Key <> '0') and
     (Key <> '1') and (Key <> '2') and (Key <> '3') and
     (Key <> '4') and (Key <> '5') and (Key <> '6') and
     (Key <> '7') and (Key <> '8') and (Key <> '9') and
     (Key <> #8) and (Key <> '#18') and (Key <> '#46') and
     (Key <> '#37') and (Key <> '#38') and (Key <> '#39') and (Key <> '#40') then
  begin
    Key := #0;
    exit;
  end;
end;

procedure TfmIndex.btPassagemClick(Sender: TObject);
begin
  gravaPassagem();
  geraPassagem();
end;

procedure TfmIndex.verVersao;
var
  vers,atu: string;
  vers_s,vers_b,atu_s,atu_b: double;
  parte : TStringList;
begin
  barraTitulo.Items[0].Visible := false;
  vers := param.Strings.Values['versao'];
  if (vers = '') or (param.Strings.Values['internet_conexao'] = '-1') then Exit;

  qrVERSAO.Close;
  qrVERSAO.Open;
  atu_s := strtofloat(VERSAO);
  atu_b := strtofloat(qrVERSAO.fieldbyname('VERSAO_BD').AsString);

  Parte := TStringList.Create;
  Parte.Delimiter := '.';
  Parte.DelimitedText := vers;

  vers_s := strtofloat(parte[0]+'.'+parte[1]);
  vers_b := strtofloat(parte[2]+'.'+parte[3]);

  atu := VERSAO+'.'+qrVERSAO.fieldbyname('VERSAO_BD').AsString;

  if ((vers_s > atu_s) or ((vers_s = atu_s) and (vers_b > atu_b))) then
  begin
    barraTitulo.Items[0].Visible := true;
    application.CreateForm(TfDialogVersao,fDialogVersao);
    fDialogVersao.lbVAtu.Caption := atu;
    fDialogVersao.lbVNova.Caption := vers;
    fDialogVersao.showmodal;
  end;
end;

procedure TfmIndex.dd1Click(Sender: TObject);
begin
  if fMonitor <> nil then
    fMonitor.Close
  else
  begin
    resize := false;
    tmrSair.Enabled := True;
  end;
end;

procedure TfmIndex.btLimparClick(Sender: TObject);
begin
  WBLoadHTML(wbBiblia,'');
  if (monitorAtivo(1)) then WBLoadHTML(fMonitor.wbBiblia,'');
//  cbLivro.Text := '';
//  txtCapitulo.Text := '';
//  txtVersiculo.Text := '';
//  cbLivro.SetFocus;
end;

procedure TfmIndex.Button1Click(Sender: TObject);
begin
  geraPassagem('-');
end;

procedure TfmIndex.Button2Click(Sender: TObject);
begin
  geraPassagem('+');
end;

procedure TfmIndex.tmrSortearTimer(Sender: TObject);
var
  sorteado: string;
begin
  vSorteio := vSorteio + 1;
  if vSorteio >= 100 then
  begin
    speedbutton1.Enabled := true;
    ToolButton5.Enabled := true;
    ToolButton15.Enabled := true;
    ToolButton6.Enabled := true;
    ToolButton7.Enabled := true;
    ToolButton3.Enabled := true;
    ToolButton1.Enabled := true;
    ToolButton4.Enabled := true;
    ToolButton2.Enabled := true;
    sButton4.Enabled := true;
    sButton5.Enabled := true;

    sorteado := opNumSorteado.text;
    lmdSorteio.Caption := sorteado;

    lbSort_D.ClearSelection;
    lbSort_D.SelectItem(StrToInt(opNumIndice.Text));
    if monitorAtivo(4) then
    begin
      fMonitor.lmdSorteio.Caption := lmdSorteio.Caption;
      fMonitor.lbSort_D.ClearSelection;
      fMonitor.lbSort_D.SelectItem(StrToInt(opNumIndice.Text));
    end;
    ToolButton3Click(Sender);

    SendMessage(lbSort_S.Handle, WM_VSCROLL, SB_TOP, 0);
    SorteioContador();
    tmrSortear.Enabled := false;

    gSorteio.MaxValue := 1;
    gSorteio.Progress := 1;
    if monitorAtivo(4) then
    begin
      fMonitor.gSorteio.MaxValue := gSorteio.MaxValue;
      fMonitor.gSorteio.Progress := gSorteio.Progress;
    end;
  end
  else
  begin
    speedbutton1.Enabled := false;
    ToolButton5.Enabled := false;
    ToolButton15.Enabled := false;
    ToolButton6.Enabled := false;
    ToolButton7.Enabled := false;
    ToolButton3.Enabled := false;
    ToolButton1.Enabled := false;
    ToolButton4.Enabled := false;
    ToolButton2.Enabled := false;
    sButton4.Enabled := false;
    sButton5.Enabled := false;

    lmdSorteio.Caption := opNumSorteado.text;
    gSorteio.MaxValue := 100;
    gSorteio.Progress := vSorteio;
    if monitorAtivo(4) then
    begin
      fMonitor.lmdSorteio.Caption := lmdSorteio.Caption;
      fMonitor.gSorteio.MaxValue := gSorteio.MaxValue;
      fMonitor.gSorteio.Progress := gSorteio.Progress;
    end;
  end;
end;

procedure TfmIndex.TabSheet6Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['SORTEIO'] <> 'ok') then
  begin
    loadCol.Strings.Values['SORTEIO'] := 'ok';

    lmdSorteio.Font.Name := lerParam('Sorteio','Fonte',fonte);
    lmdSorteio.Font.Size := strtoint(lerParam('Sorteio','Tamanho','100'));
    lmdSorteio.Font.Color := StringToColor(lerParam('Sorteio','Cor','clBlack'));
    pnlSorteio.Color := StringToColor(lerParam('Sorteio','Cor Fundo','clWhite'));
    pnlSorteioD.Color := pnlSorteio.Color;
    pnlSorteioE.Color := pnlSorteio.Color;

    tmrSorteio.Enabled := true;

    posicionaElementosTimers();

    lmdSorteio_Fonte_D.Left := pnlSorteio_Fonte.Width - lmdSorteio_Fonte_D.Width;
    lmdSorteio_Fonte_A.Left := pnlSorteio_Fonte.Width - lmdSorteio_Fonte_D.Width - lmdSorteio_Fonte_A.Width;
  end;
end;

procedure TfmIndex.TabSheet7Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['CRONO'] <> 'ok') then
  begin
    loadCol.Strings.Values['CRONO'] := 'ok';
    if tmrCrono.Enabled = true then exit;

    lmdCrono.Font.Name := lerParam('Cronometro','Fonte',fonte);
    lmdCrono.Font.Size := strtoint(lerParam('Cronometro','Tamanho','85'));
    lmdCrono.Font.Color := StringToColor(lerParam('Cronometro','Cor','clBlack'));
    pnlCrono.Color := StringToColor(lerParam('Cronometro','Cor Fundo','clWhite'));
    pnlTempoGravado.Color := pnlCrono.Color;

    rbCronoDirClick(Sender);

    posicionaElementosTimers();

    lmdCrono_Fonte_D.Left := pnlCrono_Fonte.Width - lmdCrono_Fonte_D.Width;
    lmdCrono_Fonte_A.Left := pnlCrono_Fonte.Width - lmdCrono_Fonte_D.Width - lmdCrono_Fonte_A.Width;
  end;
end;

procedure TfmIndex.tabsEscSbShow(Sender: TObject);
var
   Canvas : TCanvas;
    BitMap : TBitMap;
begin
  if (loadCol.Strings.Values['ES'] <> 'ok') then
  begin
    loadCol.Strings.Values['ES'] := 'ok';

    selMusica();
    meESHora.text := lerParam('Escola Sabatina','Hora','10:00');
    cbA.Checked := (lerParam('Escola Sabatina','Abertura','1') = '1');
    cb5.Checked := (lerParam('Escola Sabatina','5 min.','1') = '1');
    cb1.Checked := (lerParam('Escola Sabatina','1 min.','1') = '1');

    lmdEscSb.Font.Name := lerParam('Escola Sabatina','Fonte',fonte);
    lmdEscSb.Font.Size := strtoint(lerParam('Escola Sabatina','Tamanho','150'));
    lmdEscSb.Font.Color := StringToColor(lerParam('Escola Sabatina','Cor','clBlack'));

    lmdEscSbR.Font.Name := lerParam('Escola Sabatina','Fonte',fonte);
    lmdEscSbR.Font.Size := strtoint(lerParam('Escola Sabatina','Tamanho 2','72'));
    lmdEscSbR.Font.Color := StringToColor(lerParam('Escola Sabatina','Cor 2','clRed'));

    pnlEscSB.Color := StringToColor(lerParam('Escola Sabatina','Cor Fundo','clWhite'));

    posicionaElementosTimers();

    lmdEscSb_Fonte_D.Left := pnlEscSb_Fonte.Width - lmdEscSb_Fonte_D.Width;
    lmdEscSb_Fonte_A.Left := pnlEscSb_Fonte.Width - lmdEscSb_Fonte_D.Width - lmdEscSb_Fonte_A.Width;
    lmdEscSbR_Fonte_D.Left := pnlEscSbR_Fonte.Width - lmdEscSbR_Fonte_D.Width;
    lmdEscSbR_Fonte_A.Left := pnlEscSbR_Fonte.Width - lmdEscSbR_Fonte_D.Width - lmdEscSbR_Fonte_A.Width;
  end;
end;

procedure TfmIndex.tmrEscSbTimer(Sender: TObject);
var
  agora: TTime;
  final: TTime;
  crono: TTime;
  MyHora,MyMinuto,MySegundo, MyMiliSegundo:Word;
  Segundos: integer;
begin
  agora := strtotime(formatdatetime('hh:mm:ss',now()));
  lmdEscSb.Caption := formatdatetime('hh:mm:ss',agora);
  if (monitorAtivo(3)) then fMonitor.lmdEscSb.Caption := formatdatetime('hh:mm:ss',agora);

  try
    final := StrToTime(meESHora.Text+':00')
  except
    exit;
  end;
  if (final >= agora)
    then crono := final-agora
    else crono := (final+24)-agora;

  lmdEscSbR.Caption := formatdatetime('hh:mm:ss',crono);
  if (monitorAtivo(3)) then fMonitor.lmdEscSbR.Caption := formatdatetime('hh:mm:ss',crono);

  DecodeTime(crono,MyHora,MyMinuto,MySegundo,MyMiliSegundo);
  Segundos := MyMiliSegundo + (MySegundo * 1000) + (MyMinuto * 60000) + (MyHora * 3600000);
  if (Segundos > gEscSbR.MaxValue)
    then gEscSbR.MaxValue := Segundos;
  gEscSbR.Progress := Segundos;

  if (monitorAtivo(3)) then
  begin
    fMonitor.gEscSbR.MaxValue := gEscSbR.MaxValue;
    fMonitor.gEscSbR.Progress := gEscSbR.Progress;
  end;

  if (lmdEscSbR.Caption = '00:05:10') and (cb5.Checked) then
  begin
    mpMusica.Stop;
    btOuvir.Caption := 'Ouvir';
    btOuvir.ImageIndex := 7;

    cbMusica.ItemIndex := 1;
    selMusica();
    btOuvirClick(Sender);
  end;
  if (lmdEscSbR.Caption = '00:01:05') and (cb1.Checked) then
  begin
    mpMusica.Stop;
    btOuvir.Caption := 'Ouvir';
    btOuvir.ImageIndex := 7;

    cbMusica.ItemIndex := 2;
    selMusica();
    btOuvirClick(Sender);
  end;
  if (lmdEscSbR.Caption = '00:00:00') then
  begin
    tmrEscSb.Enabled := false;
    lmdEscSb.Caption := '00:00:00';
    lmdEscSbR.Caption := '00:00:00';

    btLigar.Caption := 'Ligar';
    btLigar.ImageIndex := 8;
    gEscSbR.MaxValue := 1;
    gEscSbR.Progress := 1;

    if (monitorAtivo(3)) then
    begin
      fMonitor.lmdEscSb.Caption := lmdEscSb.Caption;
      fMonitor.lmdEscSbR.Caption := lmdEscSbR.Caption;
      fMonitor.gEscSbR.MaxValue := gEscSbR.MaxValue;
      fMonitor.gEscSbR.Progress := gEscSbR.Progress;
    end;
  end;
end;

procedure TfmIndex.txtDecrChange(Sender: TObject);
begin
  btZerarCronoClick(Sender);
end;

procedure TfmIndex.txtDecrExit(Sender: TObject);
begin
  try
    strtotime(txtDecr.Text);
  except
    txtDecr.text := '00:01:00';
  end;
end;

function TfmIndex.lerParam(Grupo, Param, Valor: string): string;
var
  ArqIni: TIniFile;
  vl: string;
begin
  vl := Valor;
  ArqIni := TIniFile.Create(ExtractFilePath(application.ExeName)+'config\config.ja');
  try
    vl := ArqIni.ReadString(Grupo, Param, Valor);
  finally
    ArqIni.Free;
  end;
  result := vl;
end;

procedure TfmIndex.gravaParam(Grupo, Param, Valor: string);
var
  ArqIni: TIniFile;
begin
  ArqIni := TIniFile.Create(ExtractFilePath(application.ExeName)+'config\config.ja');
  try
    ArqIni.WriteString(Grupo, Param, Valor);
  finally
    ArqIni.Free;
  end;
end;

procedure TfmIndex.apagaParam(Grupo, Param: string);
var
  ArqIni: TIniFile;
begin
  ArqIni := TIniFile.Create(ExtractFilePath(application.ExeName)+'config\config.ja');
  try
    if (trim(Param) <> '')
      then ArqIni.DeleteKey(Grupo, Param)
      else ArqIni.EraseSection(Grupo);
  finally
    ArqIni.Free;
  end;
end;

procedure TfmIndex.cbAClick(Sender: TObject);
begin
  if cbA.Checked
    then gravaParam('Escola Sabatina','Abertura','1')
    else gravaParam('Escola Sabatina','Abertura','0');
end;

procedure TfmIndex.cb5Click(Sender: TObject);
begin
  if cb5.Checked
    then gravaParam('Escola Sabatina','5 min.','1')
    else gravaParam('Escola Sabatina','5 min.','0');
end;

procedure TfmIndex.cb1Click(Sender: TObject);
begin
  if cb1.Checked
    then gravaParam('Escola Sabatina','1 min.','1')
    else gravaParam('Escola Sabatina','1 min.','0');
end;

procedure TfmIndex.cbMusicaChange(Sender: TObject);
begin
  mpMusica.Stop;
  btOuvir.Caption := 'Ouvir';
  btOuvir.ImageIndex := 7;
  selMusica();
end;

procedure TfmIndex.selMusica;
var
  dir: string;
begin
  dir := ExtractFilePath(application.ExeName)+'config\';
  if (cbMusica.ItemIndex = 0)
    then mpMusica.FileName := dir+'abertura_escsb.mp3'
  else if (cbMusica.ItemIndex = 1)
    then mpMusica.FileName := dir+'5minutos_escsb.mp3'
  else mpMusica.FileName := dir+'1minuto_escsb.mp3';
  mpMusica.Open;
end;

procedure TfmIndex.meESHoraChange(Sender: TObject);
begin
  tmrEscSb.Enabled := false;
  lmdEscSb.Caption := '00:00:00';
  lmdEscSbR.Caption := '00:00:00';

  btLigar.Caption := 'Ligar';
  btLigar.ImageIndex := 8;
  gEscSbR.MaxValue := 1;
  gEscSbR.Progress := 1;

  if (monitorAtivo(3)) then
  begin
    fMonitor.lmdEscSb.Caption := lmdEscSb.Caption;
    fMonitor.lmdEscSbR.Caption := lmdEscSbR.Caption;
    fMonitor.gEscSbR.MaxValue := gEscSbR.MaxValue;
    fMonitor.gEscSbR.Progress := gEscSbR.Progress;
  end;

  mpMusica.Stop;
  tmrMediaPlayer.Enabled := false;
  btOuvir.Caption := 'Ouvir';
  btOuvir.ImageIndex := 7;
  gravaParam('Escola Sabatina','Hora',meESHora.Text);
end;

procedure TfmIndex.tmrMediaPlayerTimer(Sender: TObject);
begin
  if (mpMusica.Position >= mpMusica.Length) then
  begin
    mpMusica.Stop;
    btOuvir.Caption := 'Ouvir';
    btOuvir.ImageIndex := 7;
    tmrMediaPlayer.Enabled := false;
  end;
end;

procedure TfmIndex.TabSheet16Show(Sender: TObject);
var
  i: integer;
  i2: integer;
begin
  if (loadCol.Strings.Values['BIBLIA'] <> 'ok') then
  begin
    loadCol.Strings.Values['BIBLIA'] := 'ok';
    carregaCombo('L');

    dbVersao.items.Clear;
    kfVersao.items.Clear;
    qrVERSAO_BIB.Close;
    qrVERSAO_BIB.Open;
    i := -1;
    i2 := -1;
    while not qrVERSAO_BIB.Eof do
    begin
      dbVersao.Items.Add(qrVERSAO_BIB.fieldbyname('VERSAO').asstring);
      kfVersao.Items.Add(qrVERSAO_BIB.fieldbyname('SIGLA').asstring);
      if qrVERSAO_BIB.fieldbyname('SIGLA').asstring = lerParam('Biblia','Versao','VARA')
        then i := dbVersao.Items.Count-1;
      if qrVERSAO_BIB.fieldbyname('SIGLA').asstring = lerParam('Busca Biblica','Versao','VARA')
        then i2 := dbVersao.Items.Count-1;
      qrVERSAO_BIB.Next;
    end;
    if (i >= 0) then dbVersao.ItemIndex := i;

    dbVersao2.Items := dbVersao.Items;
    if (i2 >= 0) then dbVersao2.ItemIndex := i2;

    pnLivro.Width := round((sPanel5.Width - pnBotoesBiblia.Width)*30/100);
    pnVersiculo.Width := round((sPanel5.Width - pnBotoesBiblia.Width)*10/100);

    cbLivro.Left := 5;
    cbLivro.width := pnLivro.Width-10;
    txtCapitulo.Left := 5;
    txtCapitulo.width := pnCapitulo.Width-10;
    txtVersiculo.Left := 5;
    txtVersiculo.width := pnVersiculo.Width-10;
    dbVersao.Left := 5;
    dbVersao.width := pnVersao.Width-10;

    cbLivro.SetFocus;
  end;
end;

procedure TfmIndex.TabSheet13Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['BIBLIA_BUSCA'] <> 'ok') then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := 'ok';

    pnLocalizaBiblia.Width := round((sPanel6.Width - pnBotoesBibliaBusca.Width - sLabel7.Width)*60/100);

    txtLocaliza.Left := 5;
    txtLocaliza.width := pnLocalizaBiblia.Width-10;
    dbVersao2.Left := 5;
    dbVersao2.width := pnVersao2.Width-10;
  end;
    
  txtLocaliza.SetFocus;
end;

procedure TfmIndex.txtLocalizaKeyPress(Sender: TObject; var Key: Char);
begin
  if (Key = #13) then
  begin
    gravaPassagem('BIBLIA_BUSCA');
    localizaPalavraChave();
    Key := #0;
    exit;
  end;
end;

procedure TfmIndex.Button3Click(Sender: TObject);
begin
  gravaPassagem('BIBLIA_BUSCA');
  localizaPalavraChave();
end;

procedure TfmIndex.localizaPalavraChave(alertas: boolean = True);
var
  livros,busca: string;
  i: integer;
  verso, texto: string;
  html,htmlE: string;

  p_palavra,p_versao: string;
begin
  WBLoadHTML(wbLocaliza,'');
  if (monitorAtivo(2)) then WBLoadHTML(fMonitor.wbLocaliza,'');;

  p_palavra := loadCol.Strings.Values['BIBLIA_BUSCA:PALAVRA'];
  p_versao := loadCol.Strings.Values['BIBLIA_BUSCA:VERSAO'];

  if (trim(p_palavra) = '') then
  begin
    if (alertas) then
    begin
      application.MessageBox('Digite as palavras para serem localizadas!',TITULO,mb_ok+mb_iconexclamation);
      txtLocaliza.setfocus;
    end;
    exit;
  end;

  livros := '0';
  for i := 0 to ckLivros.Items.Count-1 do
    if ckLivros.Checked[i] = true then
      livros := livros + ', ' + inttostr(i+1);

  if (trim(livros) = '0') then
  begin
    if (alertas) then
    begin
      application.MessageBox('Nenhum livro foi selecionado para efetuar a busca!',TITULO,mb_ok+mb_iconexclamation);
      ckLivros.setfocus;
    end;
    exit;
  end;
  busca := p_palavra;
  busca := StringReplace(busca,'  ',' ',[rfIgnoreCase, rfReplaceAll]);
  busca := StringReplace(busca,'  ',' ',[rfIgnoreCase, rfReplaceAll]);

  busca := StringReplace(busca,' ','%" AND BIBLIA.PASSAGEM LIKE "%',[rfIgnoreCase, rfReplaceAll]);
  busca := 'AND (BIBLIA.PASSAGEM LIKE "%'+busca+'%")';

  qrPassagem.Close;
  qrPassagem.SQL.Clear;
  qrPassagem.SQL.Add('SELECT BIBLIA.LIVRO AS LIVRO_ID,LIVRO.LIVRO,BIBLIA.CAPITULO,BIBLIA.VERSICULO,BIBLIA.PASSAGEM FROM BIBLIA,LIVRO');
  qrPassagem.SQL.Add('WHERE');
  qrPassagem.SQL.Add('BIBLIA.LIVRO = LIVRO.ID');
  qrPassagem.SQL.Add('AND BIBLIA.VERSAO = "'+p_versao+'"');
  qrPassagem.SQL.Add('AND LIVRO.ID IN ('+livros+')');
  qrPassagem.SQL.Add(busca);
  qrPassagem.SQL.Add('ORDER BY');
  qrPassagem.SQL.Add('BIBLIA.LIVRO,');
  qrPassagem.SQL.Add('BIBLIA.CAPITULO,');
  qrPassagem.SQL.Add('BIBLIA.VERSICULO');
  qrPassagem.Open;

  html := '';
  htmlE := '';

  if (qrPassagem.Eof) then
  begin
    if (alertas) then
    begin
      application.MessageBox(PChar('Palavra(s) "'+p_palavra+'" não encontrada(s)!'),TITULO,mb_ok+mb_iconexclamation);
      txtLocaliza.setfocus;
    end;
    exit;
  end
  else
  begin
    busca := p_palavra;
    busca := StringReplace(busca,'  ',' ',[rfIgnoreCase, rfReplaceAll]);
    busca := StringReplace(busca,'  ',' ',[rfIgnoreCase, rfReplaceAll]);
    html := html + '<font face="'+lerParam('Busca Biblica','Fonte',fonte)+'"><table width="100%" height="100%"><tr><td colspan=2 style= "font-size:'+lerParam('Busca Biblica','Tamanho Titulo','36')+'px"><font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Titulo','$00dbb497')))+'"><b> Buscando palavra: </font><font color="'+ColorToHtml(StringToColor(lerParam('Busca Biblica','Cor Palavra Buscada','clRed')))+'">' + busca + '</font></b></td></tr><tr><td style= "font-size:'+lerParam('Busca Biblica','Tamanho','36')+'px;height:100%;">';
    htmlE := htmlE + '<font face="'+lerParam('Busca Biblica','Fonte',fonte)+'"><table width="100%" height="100%"><tr><td colspan=2 style= "font-size:'+lerParam('Busca Biblica','Tamanho Titulo (Extendido)','36')+'px"><font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Titulo','$00dbb497')))+'"><b> Buscando palavra: </font><font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Palavra Buscada','clRed')))+'">' + busca + '</font></b></td></tr><tr><td style= "font-size:'+lerParam('Busca Biblica','Tamanho (Extendido)','36')+'px;height:100%;">';

    while not qrPassagem.Eof do
    begin
      verso := qrPassagem.fieldbyname('LIVRO').AsString+' '+qrPassagem.fieldbyname('CAPITULO').AsString+':'+qrPassagem.fieldbyname('VERSICULO').AsString;
      texto := qrPassagem.fieldbyname('PASSAGEM').AsString;

      html := html + '<b><font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Passagem','$00dbb497')))+'">'+verso+'</font></b> <font color="'+ColorToHtml(StringToColor(lerParam('Busca Biblica','Cor','clBlack')))+'">';
      htmlE := htmlE + '<b><font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Passagem','$00dbb497')))+'">'+verso+'</font></b> <font color="'+ColorToHtml(StringToColor(lerParam('Busca Biblica','Cor','clBlack')))+'">';
      while Pos(UpperCase(busca), uppercase(texto)) > 0 do
      begin
        i := Pos(UpperCase(busca), uppercase(texto));
        html := html + Copy(texto,0,i-1) + '<font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Palavra Buscada','clRed')))+'">' + Copy(texto,i,length(busca)) + '</font>';
        htmlE := htmlE + Copy(texto,0,i-1) + '<font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Palavra Buscada','clRed')))+'">' + Copy(texto,i,length(busca)) + '</font>';
        texto := Copy(texto,i + length(busca),length(texto));
      end;
      html := html + texto + '</font><br>';
      htmlE := htmlE + texto + '</font><br>';

      qrPassagem.Next;
    end;
    html := html + '</td></tr><tr><td colspan=2 style="text-align:right" style= "font-size:'+lerParam('Busca Biblica','Tamanho Versao','36')+'px"><b><font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Versao','$00dbb497')))+'">' + dbVersao2.Items[dbVersao2.itemIndex] + '</font></b></td></tr></table></font>';
    htmlE := htmlE + '</td></tr><tr><td colspan=2 style="text-align:right" style= "font-size:'+lerParam('Busca Biblica','Tamanho Versao (Extendido)','36')+'px"><b><font color="'+colortohtml(StringToColor(lerParam('Busca Biblica','Cor Versao','$00dbb497')))+'">' + dbVersao2.Items[dbVersao2.itemIndex] + '</font></b></td></tr></table></font>';
    WBLoadHTML(wbLocaliza,html);
    if (monitorAtivo(2)) then WBLoadHTML(fMonitor.wbLocaliza,htmlE);

    if (alertas) then txtLocaliza.setfocus;
  end;
end;

procedure TfmIndex.Button4Click(Sender: TObject);
begin
  WBLoadHTML(wbLocaliza,'');
  if (monitorAtivo(2)) then WBLoadHTML(fMonitor.wbLocaliza,'');
//  txtLocaliza.Text := '';
//  txtLocaliza.SetFocus;
end;

procedure TfmIndex.Button5Click(Sender: TObject);
var
  i: integer;
begin
  for i := 0 to ckLivros.Items.Count-1 do
    ckLivros.Checked[i] := true;
end;

procedure TfmIndex.Button6Click(Sender: TObject);
var
  i: integer;
begin
  for i := 0 to ckLivros.Items.Count-1 do
    ckLivros.Checked[i] := false;
end;

procedure TfmIndex.Button7Click(Sender: TObject);
var
  i: integer;
begin
  for i := 0 to ckLivros.Items.Count-1 do
    ckLivros.Checked[i] := (i <= 38);
end;

procedure TfmIndex.Button8Click(Sender: TObject);
var
  i: integer;
begin
  for i := 0 to ckLivros.Items.Count-1 do
    ckLivros.Checked[i] := (i > 38);
end;

procedure TfmIndex.Button9Click(Sender: TObject);
var
  i: integer;
begin
  for i := 0 to ckLivros.Items.Count-1 do
    ckLivros.Checked[i] := not ckLivros.Checked[i];
end;

function TfmIndex.ToLower(Text: String): String;
var
  Ind: Integer;
const
  LW = 'áâãàéêíóôõúüûçñ';
  UP = 'ÁÂÃÀÉÊÍÓÔÕÚÜÛÇÑ';

begin
  Result := '';
  for Ind := 1 to Length(Text) do
    if Pos(Copy(Text, Ind, 1), UP) > 0 then
      Result := Result + Copy(LW, Pos(Copy(Text, Ind, 1), UP), 1)
    else
      Result := Result + LowerCase(Copy(Text, Ind, 1));
end;

function TfmIndex.ToUpper(Text: String): String;
var
  Ind: Integer;
const
  LW = 'áâãàéêíóôõúüûçñ';
  UP = 'ÁÂÃÀÉÊÍÓÔÕÚÜÛÇÑ';
begin
  Result := '';
  for Ind := 1 to Length(Text) do
    if Pos(Copy(Text, Ind, 1), LW) > 0 then
      Result := Result + Copy(UP, Pos(Copy(Text, Ind, 1), LW), 1)
    else
      Result := Result + UpperCase(Copy(Text, Ind, 1));
end;

procedure TfmIndex.TabSheet14Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['INI'] <> 'ok')
    then loadCol.Strings.Values['INI'] := 'ok';
end;

procedure TfmIndex.Link(Sender: TObject);
begin
  try
    ShellExecute(0, Nil, PChar(TLabel(Sender).Caption), Nil, Nil, 0);
  except
  end;
end;

procedure TfmIndex.PageControl1Change(Sender: TObject);
begin
  barraTitulo.Items[2].Caption := titulos_abas[PageControl1.ActivePageIndex];
end;

procedure TfmIndex.Fonte_AD_Click(Sender: TObject);
var
  componente,acao: string;
begin
  componente := copy(TAlignEdit(Sender).Name,0,pos('_',TAlignEdit(Sender).Name)-1);
  acao := copy(TAlignEdit(Sender).Name,pos('_',TAlignEdit(Sender).Name)+1,length(TAlignEdit(Sender).Name));

  if (acao = 'Fonte_A') {and (TAlignEdit(FindComponent(componente)).Font.Size < 200)} then
    TsLabelFX(FindComponent(componente)).Font.Size := TsLabelFX(FindComponent(componente)).Font.Size+10
  else if (acao = 'Fonte_D') and (TAlignEdit(FindComponent(componente)).Font.Size > 16) then
    TsLabelFX(FindComponent(componente)).Font.Size := TsLabelFX(FindComponent(componente)).Font.Size-10;

  if (TsLabelFX(FindComponent(componente)).Font.Size < 16) then TsLabelFX(FindComponent(componente)).Font.Size := 16;

  posicionaElementosTimers();

  if (TsLabelFX(FindComponent(componente)).Name = 'lmdEscSb') or (TsLabelFX(FindComponent(componente)).Name = 'lmdEscSbR') then
  begin
    gravaParam('Escola Sabatina','Tamanho',inttostr(lmdEscSb.Font.Size));
    gravaParam('Escola Sabatina','Tamanho 2',inttostr(lmdEscSbR.Font.Size));
  end
  else if (TsLabelFX(FindComponent(componente)).Name = 'lmdSorteio')
    then gravaParam('Sorteio','Tamanho',inttostr(lmdSorteio.Font.Size))
  else if (TsLabelFX(FindComponent(componente)).Name = 'lmdCrono')
    then gravaParam('Cronometro','Tamanho',inttostr(lmdCrono.Font.Size));

end;

procedure TfmIndex.TabSheet15Show(Sender: TObject);
var
  i: Integer;
begin
  if (loadCol.Strings.Values['PERSO'] <> 'ok') then
  begin
    if not cdsCOLETANEAS_PERSO.Active then
    begin
      cdsCOLETANEAS_PERSO.CreateDataSet;
      cdsCOLETANEAS_PERSO.IndexName := '';
      cdsCOLETANEAS_PERSO.IndexFieldNames := 'NOME';
    end;

    if (FileExists(ExtractFilePath(Application.ExeName)+'\config\coletaneasUsuario.xml'))
      then cdsCOLETANEAS_PERSO.LoadFromFile(ExtractFilePath(Application.ExeName)+'\config\coletaneasUsuario.xml');
    cdsCOLETANEAS_PERSO.Open;

    loadCol.Strings.Values['PERSO'] := 'ok';

    for i := sbColPERSO.ComponentCount-1 downto 0 do
      sbColPERSO.Components[i].Free;

    fExibeColetaneasPerso();
  end;
end;

procedure TfmIndex.fExibeColetaneasPerso();
var
  ScrollBox: TsScrollBox;
  GroupBox: TsGroupBox;
  Button: TsButton;
  gLeft,gTop,gWidth,gHeight: Integer;
  mLeft: integer;
  dirIMG: string;
  nome: string;
  id: string;
  formWidth: Integer;
  bitmap: TBitmap;
  idimg: integer;
const
  Tipo = 'PERSO';
begin
  ScrollBox := TsScrollBox(FindComponent('sbCol'+Tipo));
  formWidth := ScrollBox.Width;

  gLeft := 0;
  gTop := 10;
  gWidth := 165;
  gHeight := 190;

  while ((gLeft + gWidth + 10 + gWidth) < formWidth) do
    gLeft := gLeft + gWidth + 10;
  mLeft := trunc((formWidth-(gLeft + gWidth + 10))/2);
  gLeft := mLeft;

  cdsCOLETANEAS_PERSO.First;
  while not cdsCOLETANEAS_PERSO.Eof do
  begin
    id := cdsCOLETANEAS_PERSO.FieldByName('ID').Value;
    nome := 'gbPerso_'+id;
    GroupBox := TsGroupBox(FindComponent(nome));
    GroupBox.Free;
    try
      GroupBox := TsGroupBox.Create(ScrollBox);

      with GroupBox do
      begin
        Parent := ScrollBox;
        Name := nome;
        Caption := ' '+cdsCOLETANEAS_PERSO.FieldByName('NOME').Value+' ';
        Width := gWidth;
        Height := gHeight;
        Left := gLeft;
        Top := gTop;
      end;
    except
      with GroupBox do
      begin
        Caption := ' '+cdsCOLETANEAS_PERSO.FieldByName('NOME').Value+' ';
        Width := gWidth;
        Height := gHeight;
        Left := gLeft;
        Top := gTop;
      end;
    end;

    nome := 'sbPerso_'+id;
    dirIMG := cdsCOLETANEAS_PERSO.FieldByName('IMAGEM').Value;
    if (trim(dirIMG) <> '') and (cdsCOLETANEAS_PERSO.FieldByName('IMAGEM_INFO').Value = 'I')
      then dirIMG := ExtractFilePath(Application.ExeName)+dirIMG;

    Button := TsButton(FindComponent(nome));
    Button.Free;
    try
      Button := TsButton.Create(GroupBox);
      with Button do
      begin
        Parent := GroupBox;
        Name := nome;
        Caption := '';
        Width := gWidth - 10;
        Height := gHeight - 20;
        Images := imCapas;
        ImageAlignment := iaTop;
        Left := 5;
        Top := 15;
        try
          if (fileexists(dirImg) and (UpperCase(copy(dirIMG,length(dirIMG)-3,4)) = '.BMP')) then
          begin
            bitmap := TBitmap.Create;
            bitmap.LoadFromFile(dirIMG);
            bitmap.TransparentColor := clFuchsia;
            bitmap.Transparent := false;
            idimg := imCapas.Add(bitmap,bitmap);
            ImageIndex := idimg;
            bitmap.Free;
          end;
        except
          Font.Color := clRed;
          SkinData.CustomFont := True;
          Caption := 'Tamanho ou formato de imagem inválido!';
          bitmap.Free;
        end;
        onClick := sbClickPerso;
      end;
    except
      with Button do
      begin
        Caption := '';
        Images := imCapas;
        ImageAlignment := iaTop;
        if (fileexists(dirImg) and (UpperCase(copy(dirIMG,length(dirIMG)-3,4)) = '.BMP')) then
        begin
          bitmap := TBitmap.Create;
          bitmap.LoadFromFile(dirIMG);
          idimg := imCapas.Add(bitmap,bitmap);
          ImageIndex := idimg;
          bitmap.Free;
        end;
      end;
    end;

    if ((gLeft + gWidth + 10 + gWidth) >= formWidth) then
    begin
      gLeft := mLeft;
      gTop := gTop + gHeight + 10;
    end
    else
      gLeft := gLeft + gWidth + 10;

    cdsCOLETANEAS_PERSO.Next;
  end;

end;

procedure TfmIndex.sbClickPerso(Sender: TObject);
var
  mComponente: String;
  URL: string;
  ID: string;
begin
  StatusMSG('Aguarde...');
  mComponente := TsSpeedButton(Sender).Name;

  ID := Copy(mComponente,Pos('_',mComponente)+1,Length(mComponente));

  cdsCOLETANEAS_PERSO.Locate('ID', id, []);
  URL := cdsCOLETANEAS_PERSO.FieldByName('URL').AsString;

  StatusMSG('Aguarde... Carregando Coletânea '''+URL+'');

  if not FileExists(URL) then
  begin
    StatusMSG('Coletânea não localizada...');
    application.MessageBox(PChar('Não foi possível localizar a coletânea '''+URL+'''!'),TITULO,mb_ok + mb_iconerror);
    StatusMSG;
    exit;
  end;
  lmdEXEC.Command := URL;
  lmdEXEC.Execute;
  StatusMSG;
end;

procedure TfmIndex.ColetneasPersonalizadas1Click(Sender: TObject);
begin
  PageControl1.ActivePage := TabSheet15;
  PageControl1Change(Sender);  
end;

procedure TfmIndex.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  resize := false;
  tmrSair.Enabled := True;
end;

procedure TfmIndex.sTitleBar1Items0Click(Sender: TObject);
begin
  application.CreateForm(TfAbout,fAbout);
  fAbout.showmodal;
end;

procedure TfmIndex.sButton1Click(Sender: TObject);
begin
  application.CreateForm(TfColetPerso,fColetPerso);
  fColetPerso.acao := 'INS';
  fColetPerso.showmodal;
end;

procedure TfmIndex.sButton2Click(Sender: TObject);
begin
  if (cdsCOLETANEAS_PERSO.RecordCount <= 0) then
  begin
    application.messagebox('Não há nenhuma coletânea nesta página para gerenciar. Adicione uma coletânea primeiro.',TITULO,MB_OK+mb_iconexclamation);
    exit;
  end;
  application.CreateForm(TfColetPerso,fColetPerso);
  fColetPerso.acao := 'ALT';
  fColetPerso.showmodal;
end;

procedure TfmIndex.btOuvirClick(Sender: TObject);
begin
  if btOuvir.Caption = 'Ouvir' then
  begin
    tmrMediaPlayer.Enabled := true;
    mpMusica.Play;
    btOuvir.Caption := 'Parar';
    btOuvir.ImageIndex := 9;
  end
  else
  begin
    tmrMediaPlayer.Enabled := false;
    mpMusica.Stop;
    btOuvir.Caption := 'Ouvir';
    btOuvir.ImageIndex := 7;
  end;
end;

procedure TfmIndex.btLigarClick(Sender: TObject);
begin
  if btLigar.Caption = 'Ligar' then
  begin
    mpMusica.Stop;
    btOuvir.Caption := 'Ouvir';
    btOuvir.ImageIndex := 7;

    tmrEscSb.Enabled := true;
    tmrEscSbTimer(Sender);
    btLigar.Caption := 'Desligar';
    btLigar.ImageIndex := 9;
    try
      StrToTime(meESHora.Text)
    except
      btLigarClick(Sender);
      application.MessageBox('Hora inválida!',TITULO,mb_ok+mb_iconerror);
      meESHora.SetFocus;
    end;
    if (cbA.Checked) then
    begin
      cbMusica.ItemIndex := 0;
      selMusica();
      btOuvirClick(Sender);
    end;
  end
  else
  begin
    tmrEscSb.Enabled := false;
    lmdEscSb.Caption := '00:00:00';
    lmdEscSbR.Caption := '00:00:00';

    btLigar.Caption := 'Ligar';
    btLigar.ImageIndex := 8;
    gEscSbR.MaxValue := 1;
    gEscSbR.Progress := 1;

    if (monitorAtivo(3)) then
    begin
      fMonitor.lmdEscSb.Caption := lmdEscSb.Caption;
      fMonitor.lmdEscSbR.Caption := lmdEscSbR.Caption;
      fMonitor.gEscSbR.MaxValue := gEscSbR.MaxValue;
      fMonitor.gEscSbR.Progress := gEscSbR.Progress;
    end;

    mpMusica.Stop;
    tmrMediaPlayer.Enabled := false;
    btOuvir.Caption := 'Ouvir';
    btOuvir.ImageIndex := 7;
  end;
end;

procedure TfmIndex.posicionaElementosTimers;
begin
{ESCOLA SABATINA}
    lmdEscSb.Width := pnlEscSB.Width;
    lmdEscSb.Left := 0;
    lmdEscSb.Height := lmdEscSb.Font.Height*-1;

    lmdEscSbR.Width := pnlEscSB.Width;
    lmdEscSbR.Left := 0;
    lmdEscSbR.Height := lmdEscSbR.Font.Height*-1;

    lmdEscSb.Top := trunc(pnlEscSB.Height/2) - trunc(lmdEscSb.Height/2) - trunc(lmdEscSbR.Height/2);
    lmdEscSbR.Top := trunc(pnlEscSB.Height/2) + trunc(lmdEscSb.Height/2) - trunc(lmdEscSbR.Height/2);

{SORTEIO}
    lmdSorteio.Width := pnlSorteio.Width;
    lmdSorteio.Left := 0;
    lmdSorteio.Height := lmdSorteio.Font.Height*-1;
    lmdSorteio.Top := trunc((pnlSorteio.Height-sDragBar2.Height-gSorteio.Height)/2) - trunc(lmdSorteio.Height/2);

{CRONOMETRO}
    lmdCrono.Width := pnlCrono.Width;
    lmdCrono.Left := 0;
    lmdCrono.Height := lmdCrono.Font.Height*-1;
    lmdCrono.Top := trunc((pnlCrono.Height-Toolbar7.Height-gCrono.Height-pnlCrono_Fonte.Height)/2) - trunc(lmdCrono.Height/2);


    if (monitorAtivo(3)) then
    begin
      {ESCOLA SABATINA}
      fMonitor.lmdEscSb.Width := fMonitor.pnlEscSB.Width;
      fMonitor.lmdEscSb.Left := 0;
      fMonitor.lmdEscSb.Height := fMonitor.lmdEscSb.Font.Height*-1;

      fMonitor.lmdEscSbR.Width := fMonitor.pnlEscSB.Width;
      fMonitor.lmdEscSbR.Left := 0;
      fMonitor.lmdEscSbR.Height := fMonitor.lmdEscSbR.Font.Height*-1;

      fMonitor.lmdEscSb.Top := trunc(fMonitor.pnlEscSB.Height/2) - trunc(fMonitor.lmdEscSb.Height/2) - trunc(fMonitor.lmdEscSbR.Height/2);
      fMonitor.lmdEscSbR.Top := trunc(fMonitor.pnlEscSB.Height/2) + trunc(fMonitor.lmdEscSb.Height/2) - trunc(fMonitor.lmdEscSbR.Height/2);
    end;
    if (monitorAtivo(4)) then
    begin
      {SORTEIO}
      fMonitor.lmdSorteio.Width := fMonitor.pnlSorteio.Width;
      fMonitor.lmdSorteio.Left := 0;
      fMonitor.lmdSorteio.Height := fMonitor.lmdSorteio.Font.Height*-1;
      fMonitor.lmdSorteio.Top := trunc((fMonitor.pnlSorteio.Height-fMonitor.gSorteio.Height)/2) - trunc(fMonitor.lmdSorteio.Height/2);
    end;
    if (monitorAtivo(5)) then
    begin
      {CRONOMETRO}
      fMonitor.lmdCrono.Width := fMonitor.pnlCrono.Width;
      fMonitor.lmdCrono.Left := 0;
      fMonitor.lmdCrono.Height := fMonitor.lmdCrono.Font.Height*-1;
      fMonitor.lmdCrono.Top := trunc((fMonitor.pnlCrono.Height-fMonitor.gCrono.Height)/2) - trunc(fMonitor.lmdCrono.Height/2);
    end;
end;

procedure TfmIndex.btIniciarCronoClick(Sender: TObject);
begin
  if btIniciarCrono.Caption = 'Iniciar' then
  begin
    tCrono := tCronoT;
    tCronoOld := Now;
    tmrCrono.Enabled := True;
    btIniciarCrono.Caption := 'Pausar';
    btIniciarCrono.ImageIndex := 15;
  end
  else
  begin
    tmrCrono.Enabled := False;
    btIniciarCrono.Caption := 'Iniciar';
    btIniciarCrono.ImageIndex := 8;
  end;
end;

procedure TfmIndex.btZerarCronoClick(Sender: TObject);
var
  hora: string;
begin
  tmrCrono.Enabled := false;
  btIniciarCrono.Caption := 'Iniciar';
  btIniciarCrono.ImageIndex := 8;
  gCrono.MaxValue := 1;
  gCrono.Progress := 1;

  tCronoT := 0;
  if rbCronoDir.Checked then
  begin
    tCronoT := 0;
    lmdCrono.Caption := '00:00:00.000';
  end
  else
  begin
    hora := txtDecr.Text;
    btIniciarCrono.Enabled := true;
    try
      tCronoT := strtotime(hora);
    except
      btIniciarCrono.Enabled := false;
    end;
    lmdCrono.Caption := hora+'.000';
  end;
  if monitorAtivo(5) then
  begin
    fMonitor.lmdCrono.Caption := lmdCrono.Caption;
    fMonitor.gCrono.MaxValue := gCrono.MaxValue;
    fMonitor.gCrono.Progress := gCrono.Progress;
  end;
end;

procedure TfmIndex.btAnotTempoClick(Sender: TObject);
var
  i: integer;
  Item: TListItem;
  tempo: string;
begin
  if lbCrono.Items.Count <= 0 then
    i := 1
  else
    i := strtoint(lbCrono.Items[lbCrono.Items.Count-1].Caption)+1;

  tempo := lmdCrono.Caption;

  Item := lbCrono.Items.Add;
  Item.Caption := formatfloat('00',i);
  Item.SubItems.Add(tempo);
  if (monitorAtivo(5)) then
  begin
    Item := fMonitor.lbCrono.Items.Add;
    Item.Caption := formatfloat('00',i);
    Item.SubItems.Add(tempo);
  end;
end;

procedure TfmIndex.sListView1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (TsListView(Sender).ItemIndex < 0) then Exit;

  if key = vk_return then
    sListView1DblClick(Sender);

  if key = vk_delete then
    MenuItem2Click(Sender);
end;

procedure TfmIndex.ToolButton12Click(Sender: TObject);
begin
  if monitorAtivo(5)
    then LimpaItemListBox(lbCrono,fMonitor.lbCrono,5)
    else LimpaItemListBox(lbCrono);
end;

procedure TfmIndex.ToolButton9Click(Sender: TObject);
begin
  if monitorAtivo(5)
    then RemoveItemListBox(lbCrono,fMonitor.lbCrono,5)
    else RemoveItemListBox(lbCrono)
end;

procedure TfmIndex.ToolButton5Click(Sender: TObject);
begin
  if tmrSorteio.Enabled = false then tmrSorteio.Enabled := true;

  if lbSort_D.Items.Count <= 0 then
  begin
    lmdSorteio.Caption := '0000';
    if monitorAtivo(4) then fMonitor.lmdSorteio.Caption := lmdSorteio.Caption;
    application.messagebox('Não há números disponíveis para serem sorteados!',TITULO,mb_ok+mb_iconexclamation);
    exit;
  end;

  vSorteio := 0;
  tmrSortear.Enabled := true;
end;

procedure TfmIndex.sButton4Click(Sender: TObject);
begin
  if monitorAtivo(4)
    then LimpaItemListBox(lbSort_D,fMonitor.lbSort_D,4)
    else LimpaItemListBox(lbSort_D);
  SorteioContador();
end;

procedure TfmIndex.LimpaItemListBox(ListView: TsListView;MonitorListView: TsListView = nil;tag:Integer = -1);
begin
  if ListView.Items.Count <= 0 then
  begin
    application.MessageBox('Não há nenhum item para ser removido!',TITULO,mb_ok+mb_iconexclamation);
    exit;
  end;

  if application.messagebox(PChar('Deseja realmente remover todos os itens da lista?'),TITULO,mb_yesno+mb_iconquestion) = 6 then
  begin
    ListView.Items.Clear;
    if (monitorAtivo(tag)) then MonitorListView.Items.Clear;
  end;
end;

procedure TfmIndex.sButton5Click(Sender: TObject);
begin
  if monitorAtivo(4)
    then LimpaItemListBox(lbSort_S,fMonitor.lbSort_S,4)
    else LimpaItemListBox(lbSort_S);    
  SorteioContador();
end;

procedure TfmIndex.lbSort_SKeyPress(Sender: TObject; var Key: Char);
begin
  if key = #46 then
  begin
    key := #0;
    ToolButton2Click(Sender);
  end;
end;

procedure TfmIndex.dbVersaoChange(Sender: TObject);
begin
  gravaPassagem();
  geraPassagem();
  gravaParam('Biblia','Versao',kfVersao.Items[dbVersao.Itemindex]);
end;

procedure TfmIndex.dbVersao2Change(Sender: TObject);
begin
  gravaPassagem('BIBLIA_BUSCA');
  localizaPalavraChave();
  gravaParam('Busca Biblica','Versao',kfVersao.Items[dbVersao2.Itemindex]);
end;

procedure TfmIndex.Localizar(ValorBusca: String; RichEdit: TRichEdit; recolore: boolean);
var
  ProcurePor : LongInt;
  PosInicial, PosFinal : integer;
  vPosAntiga : Integer;
begin
  with RichEdit do
  begin
    SelStart := 0;
    SelLength := Length(Text);
    if recolore = true
      then SelAttributes.Color := clBlack;

    vPosAntiga := SelStart;
    SelStart := 0;
    SelLength := 0;
    while True do
    begin
      PosInicial := SelStart + SelLength;
      PosFinal := Length(Text) - PosInicial;
      ProcurePor := FindText(ValorBusca, PosInicial, PosFinal, []);
      if ProcurePor < 0 then Break;
      begin
        SelStart := ProcurePor;
        SelLength := Length(ValorBusca);
      end;
      SelAttributes.Color := clRed;
    end;
    SelStart := vPosAntiga;
    SelLength := 0;
    if recolore = true
      then SelAttributes.Color := clBlack;
  end;
end;

procedure TfmIndex.sButton3Click(Sender: TObject);
begin
  application.messagebox(PChar('Verificar arquivos faltantes e corrigir arquivos em diretórios errados!'+#13+
                               'Os arquivos faltantes deverão ser baixados do blog http://louvorja.blogspot.com'),TITULO,MB_OK+mb_iconinformation);
end;

procedure TfmIndex.TabSheet9Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['VERIFICA_LINKS'] <> 'ok') then
  begin
    loadCol.Strings.Values['VERIFICA_LINKS'] := 'ok';
    lvErros.Columns[3].Width := lvErros.Width - lvErros.Columns[2].Width - lvErros.Columns[1].Width - lvErros.Columns[0].Width - 25;
  end;
end;

procedure TfmIndex.formataTexto(RichEdit: TsRichEdit);
var
  iPosINI,iPosTAM: integer;
begin
  RichEdit.SelStart := 0;
  RichEdit.SelLength := Length(RichEdit.text);
  RichEdit.SelAttributes.Style := [];

  reAux.Text := RichEdit.Text;
  RichEdit.Text := StringReplace(RichEdit.text, '[', '',[rfIgnoreCase, rfReplaceAll]);
  RichEdit.Text := StringReplace(RichEdit.text, ']', '',[rfIgnoreCase, rfReplaceAll]);

  while Pos('[',reAux.text) > 0 do
  begin
    iPosINI := Pos('[',reAux.text);
    iPosTAM := Pos(']',Copy(reAux.text,iPosINI,Length(reAux.text)));

    reAux.Text := Copy(reAux.Text,1,iPosINI-1)+
                  Copy(reAux.Text,iPosINI+1,iPosTAM-2)+
                  Copy(reAux.Text,iPosINI+iPosTAM,Length(reAux.Text));

    if iPosTAM > 0 then
    begin
      RichEdit.SelStart := iPosINI-1;
      RichEdit.SelLength := iPosTAM-2;
      RichEdit.SelAttributes.Style := [fsBold];
    end;
  end;

  RichEdit.SelStart := 0;
  RichEdit.SelLength := 0;
end;

procedure TfmIndex.FormResize(Sender: TObject);
var
  i: integer;
begin
  for i := 1 to loadCol.RowCount-1 do
    loadCol.Cells[1,i] := '';

  PageControl1.Pages[PageControl1.ActivePageIndex].OnShow(Sender);
end;

procedure TfmIndex.TabSheet11Show(Sender: TObject);
begin
  PageControl4.Pages[PageControl4.ActivePageIndex].OnShow(Sender);
end;

procedure TfmIndex.TabSheet5Show(Sender: TObject);
begin
  PageControl2.Pages[PageControl2.ActivePageIndex].OnShow(Sender);
end;

procedure TfmIndex.TabSheet8Show(Sender: TObject);
begin
  PageControl3.Pages[PageControl3.ActivePageIndex].OnShow(Sender);
end;

function TfmIndex.ExtraiTexto(const Str, Str1, Str2: String): String;
var
  Inicio, Fim : String;
begin
  Inicio := Copy(Str, Pos(Str1, Str) + Length(Str1), Length(str));

  // Pega o Texto Restante, iniciando ao final da variavel Str1;
  Fim := Copy(Inicio, 0, Pos(str2,Inicio) - 1);

  // Copia o Texto da posição inicial '0' até o Final, que é determinado pela posição inicial da variavel str2 menos '1' para corrigir;
  Result := Fim;
end;


procedure TfmIndex.BaixaColetanea(col, tit: string);
var
  dir,arq,url: string;
  Flags : Cardinal;  
begin
  dir := ExtractFilePath(Application.ExeName)+'~temp';

  if not InternetGetConnectedState(@Flags, 0) then
  begin
    Application.MessageBox('Não foi possível estabelecer uma conexão com a internet. Verifique sua conexão e tente novamente!',fmIndex.TITULO,mb_ok+mb_iconerror);
    exit;
  end;

  url := fmIndex.param.Strings.Values[col];
  if (trim(url) = '') then
  begin
    Application.MessageBox('Não foi possível localizar o link para download. Baixe manualmente através do site http://louvorja.blogspot.com.br.',fmIndex.TITULO,mb_ok+mb_iconerror);
    exit;
  end;

  application.CreateForm(TfAtualiza,fAtualiza);
  fAtualiza.sStatus.Caption := 'Verificando atualização...';
  arq := FormatDateTime('YYYYMMDD_HHMMSSZZZ',Now())+'.rar';
  fAtualiza.filename := dir+'\'+arq;
  fAtualiza.arq := arq;
  fAtualiza.url := url;

  fAtualiza.Caption := 'Atualização em andamento...';
  fAtualiza.sTitulo.Caption := tit;
  fAtualiza.acao := 'baixa';

  fAtualiza.showmodal;
end;

function TfmIndex.DecodeBase64(const CinLine: string): string;
const
  RESULT_ERROR = -2;
var
  inLineIndex: Integer;
  c: Char;
  x: SmallInt;
  c4: Word;
  StoredC4: array[0..3] of SmallInt;
  InLineLength: Integer;
begin
  Result := '';
  inLineIndex := 1;
  c4 := 0;
  InLineLength := Length(CinLine);

  while inLineIndex <= InLineLength do
  begin
    while (inLineIndex <= InLineLength) and (c4 < 4) do
    begin
      c := CinLine[inLineIndex];
      case c of
        '+'     : x := 62;
        '/'     : x := 63;
        '0'..'9': x := Ord(c) - (Ord('0')-52);
        '='     : x := -1;
        'A'..'Z': x := Ord(c) - Ord('A');
        'a'..'z': x := Ord(c) - (Ord('a')-26);
      else
        x := RESULT_ERROR;
      end;
      if x <> RESULT_ERROR then
      begin
        StoredC4[c4] := x;
        Inc(c4);
      end;
      Inc(inLineIndex);
    end;

    if c4 = 4 then
    begin
      c4 := 0;
      Result := Result + Char((StoredC4[0] shl 2) or (StoredC4[1] shr 4));
      if StoredC4[2] = -1 then Exit;
      Result := Result + Char((StoredC4[1] shl 4) or (StoredC4[2] shr 2));
      if StoredC4[3] = -1 then Exit;
      Result := Result + Char((StoredC4[2] shl 6) or (StoredC4[3]));
    end;
  end;
end;

function TfmIndex.EncodeBase64(const inStr: string): string;
  function Encode_Byte(b: Byte): char;
  const
    Base64Code: string[64] =
      'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
  begin
    Result := Base64Code[(b and $3F)+1];
  end;
var
  i: Integer;
begin
  i := 1;
  Result := '';
  while i <= Length(InStr) do
  begin
    Result := Result + Encode_Byte(Byte(inStr[i]) shr 2);
    Result := Result + Encode_Byte((Byte(inStr[i]) shl 4) or (Byte(inStr[i+1]) shr 4));
    if i+1 <= Length(inStr) then
      Result := Result + Encode_Byte((Byte(inStr[i+1]) shl 2) or (Byte(inStr[i+2]) shr 6))
    else
      Result := Result + '=';
    if i+2 <= Length(inStr) then
      Result := Result + Encode_Byte(Byte(inStr[i+2]))
    else
      Result := Result + '=';
    Inc(i, 3);
  end;
end;

procedure TfmIndex.carregaParams;
var
  LinkPag: String;
  txt: string;
  Flags : Cardinal;
  vers: string;
  ip: TIdIPWatch;
  lParams :TStringList;
begin
  if (paramstr(1) <> '0') then
  begin
    if not InternetGetConnectedState(@Flags, 0) then
    begin
      txt := DecodeBase64(lerParam('Config','Params','='));
      txt := IfThen(trim(txt) = '','=',txt);
      param.Strings.Text := txt;
      param.Strings.Values['internet_conexao'] := '0';
      param.Strings.Values['download_params'] := '0';
    end
    else
    begin
      if (lerParam('Config','UltimaConexao','') <> formatdatetime('yyyy-mm-dd',Now())) then
      begin
        gravaParam('Config','UltimaConexao',formatdatetime('yyyy-mm-dd',Now()));
        try
          LinkPag := IdHTTP1.Get('http://louvorja.blogspot.com.br/p/config.html');
          txt := ExtraiTexto(LinkPag,'<params>','</params>');
          txt := IfThen(trim(txt) = '','=',txt);
          param.Strings.Text := txt;
          param.Strings.Values['internet_conexao'] := '1';
          param.Strings.Values['download_params'] := '1';
          gravaParam('Config','Params',EncodeBase64(txt));
        except
          txt := DecodeBase64(lerParam('Config','Params','='));
          txt := IfThen(trim(txt) = '','=',txt);
          param.Strings.Text := txt;
          param.Strings.Values['internet_conexao'] := '1';
          param.Strings.Values['download_params'] := '0';
        end;

        if (Trim(param.Strings.Values['formulario']) <> '') then
        begin
          qrVERSAO.Close;
          qrVERSAO.Open;
          vers := VERSAO+'.'+qrVERSAO.fieldbyname('VERSAO_BD').AsString;
          if (vers <> lerParam('Config','EnviaAcesso','')) then
          begin
            try
              ip := TIdIPWatch.Create(nil);
              lParams := TStringList.Create;
              lParams.Add('versao='+vers);
              lParams.Add('datahora='+formatdatetime('yyyy-mm-dd hh:nn:ss',Now()));
              lParams.Add('ip='+ip.LocalIP);
              lParams.Add('dir='+Application.ExeName);
              Memo1.Lines.Clear;
              Memo1.Text := GetComputerNameFunc;
              lParams.Add('nome='+trim(Memo1.Lines[0]));
              memo1.Text := idHttp1.Post(param.Strings.Values['formulario'],lParams);
            except
            end;
            gravaParam('Config','EnviaAcesso',vers);
          end;
        end;
      end
      else
      begin
        txt := DecodeBase64(lerParam('Config','Params','='));
        txt := IfThen(trim(txt) = '','=',txt);
        param.Strings.Text := txt;
        param.Strings.Values['internet_conexao'] := '0';
        param.Strings.Values['download_params'] := '0';
      end;
    end;
  end
  else
  begin
    txt := DecodeBase64(lerParam('Config','Params','='));
    txt := IfThen(trim(txt) = '','=',txt);
    param.Strings.Text := txt;
    param.Strings.Values['internet_conexao'] := '-1';
    param.Strings.Values['download_params'] := '0';
  end;
end;

procedure TfmIndex.tmrSairTimer(Sender: TObject);
begin
  Application.Terminate;
end;

procedure TfmIndex.barraTituloItems0Click(Sender: TObject);
begin
//  carregaParams();
  verVersao();
end;

procedure TfmIndex.Espere(N: Integer);
var 
  O:TDateTime; 
begin
  O := IncMilliSecond(Now,N);
  while Now < O do
    Continue;
end;

procedure TfmIndex.removeArqTemp(dir:string);
var
  SearchRec: TSearchRec;
  Result : Integer;
begin
  if (dir = '') then
    dir := ExtractFilePath(Application.ExeName)+'~temp\';

  result := FindFirst(dir+'*.*', faAnyFile, SearchRec);
  While Result = 0 do
  begin
    if (SearchRec.Name <> '.') and (SearchRec.Name <> '..') and (DirectoryExists(dir+SearchRec.Name)) then
    begin
      removeArqTemp(dir+SearchRec.Name+'\');
      RemoveDir(dir+SearchRec.Name);
    end
    else
      DeleteFile(dir+SearchRec.Name);
    Result := FindNext(SearchRec);
  end;

  if DirectoryExists(dir) then
    RemoveDir(dir);
end;

procedure TfmIndex.sButton6Click(Sender: TObject);
begin
  if (fmIndex.param.Strings.Values['metodo_download'] = 'link') then
  begin
    if (Application.MessageBox('Link para baixar o hinário não disponível.'+#13+
                               'Deseja se conectar ao site para baixar manualmente o hinário?',TITULO,mb_yesno+mb_iconquestion) = 6)
      then ShellExecute(0, Nil, 'http://louvorja.blogspot.com.br/p/download.html', Nil, Nil, 0);
  end
  else if (trim(param.Strings.Values['hasd']) = '') then
  begin
    if (Application.MessageBox(PChar('Não foi possível localizar o link para baixar o hinário!'+#13+
                               'Deseja se conectar ao site para baixar manualmente o hinário?'),TITULO,mb_yesno+mb_iconquestion) = 6)
      then ShellExecute(0, Nil, 'http://louvorja.blogspot.com.br/p/download.html', Nil, Nil, 0);
  end
  else
  begin
    if (Application.MessageBox(PChar('O hinário pode levar muito tempo para ser baixado. Deseja baixar o Hinário Adventista?'),TITULO,mb_yesno+mb_iconquestion) = 6) then
    begin
      BaixaColetanea('hasd','Hinário Adventista');
    end;
  end;
end;

function TfmIndex.GetComputerNameFunc: string;
var ipbuffer : string;
      nsize : dword;
begin
   nsize := 255;
   SetLength(ipbuffer,nsize);
   if GetComputerName(pchar(ipbuffer),nsize) then
      result := ipbuffer;
end;

procedure TfmIndex.BitmapFileToPNG(const Source, Dest: String);
var
  Bitmap: TBitmap;
  PNG: TPNGObject;
begin
  Bitmap := TBitmap.Create;
  PNG := TPNGObject.Create;
  {In case something goes wrong, free booth Bitmap and PNG}
  try
    Bitmap.LoadFromFile(Source);
    PNG.Assign(Bitmap);    //Convert data into png
    PNG.SaveToFile(Dest);
  finally 
    Bitmap.Free;
    PNG.Free;
  end
end;

procedure TfmIndex.LiturgiaCalendarClick(Sender: TObject);
var
  dia_semana: integer;
  i: integer;
begin
  dia_semana := TComponent(Sender).Tag;
  seSemana.Value := dia_semana;
  for i := 1 to 7 do
    TToolButton(FindComponent('lcal_'+inttostr(i)) as TToolButton).Down := (TToolButton(FindComponent('lcal_'+inttostr(i)) as TToolButton).Tag = dia_semana);

  limpaCamposLiturgia();
  carregaLiturgia(dia_semana);
end;

procedure TfmIndex.sTabSheet1Show(Sender: TObject);
begin
  if (loadCol.Strings.Values['LITURGIA'] <> 'ok') then
  begin
    loadCol.Strings.Values['LITURGIA'] := 'ok';

    sListView1.Columns[1].Width := sListView1.Width - sListView1.Columns[0].Width - 25;  

    if not cdsLITURGIA.Active then
    begin
      cdsLITURGIA.CreateDataSet;
      cdsLITURGIA.IndexName := '';
      cdsLITURGIA.IndexFieldNames := 'ORDEM';
    end;

    if (FileExists(ExtractFilePath(Application.ExeName)+'\config\liturgia.xml'))
      then cdsLITURGIA.LoadFromFile(ExtractFilePath(Application.ExeName)+'\config\liturgia.xml');
    cdsLITURGIA.Open;

    limpaCamposLiturgia();
    TToolButton(FindComponent('lcal_'+inttostr(dayofweek(now()))) as TToolButton).Click;
  end;
end;

function TfmIndex.verificaURL(url: string; input: TEdit): string;
var
  dirCol: string;
  dirArqPart: string;
begin
  dirCol := ExtractFilePath(Application.ExeName);
  dirArqPart := AnsiMidStr(PChar(url), 1, StrLen(PChar(dirCol)));
  if (dirCol = dirArqPart) then
  begin
    url := AnsiMidStr(PChar(url), StrLen(PChar(dirCol))+1, StrLen(PChar(url)));
    input.Text := 'I';
  end
  else if (FileExists(dirCol+'\'+dirArqPart))
    then input.Text := 'I'
  else input.Text := 'E';

  result := url;
end;

procedure TfmIndex.txtUrlChange(Sender: TObject);
begin
  if (trim(txtNome.Text) = '')
    then txtNome.Text := ChangeFileExt(ExtractFileName(txtUrl.Text),'');
  txtUrl.Text := verificaURL(txtUrl.Text,txtUrlInfo);
end;

procedure TfmIndex.limpaCamposLiturgia;
begin
  txtItem.Text := '';
  cbAbrir.ItemIndex := -1;
  cbAbrirChange(nil);
  seHino.Value := 1;
  cbNome.Items.Clear;
  cbNome.ItemIndex := -1;
  cbKeys.Items.Clear;
  cbKeys.ItemIndex := -1;
  txtNome.Text := '';
  txtUrl.Text := '';
  txtUrlInfo.Text := '';
  txtID.Text := '';
  txtSite.Text := '';
  cbFormatoHino.ItemIndex := cbFormatoHino.Items.IndexOf(lerParam('Hinario','Formato','pps'));

  btCancel.Visible := False;  
  pnlLitBotoes.Width := 46;
  btSave.ImageIndex := 44;
  btSave.Left := 5;
  btSave.Visible := True;
end;

procedure TfmIndex.cbAbrirChange(Sender: TObject);
begin
  seHino.Visible := False;
  cbNome.Visible := False;
  cbKeys.Visible := False;
  txtNome.Visible := False;
  txtUrl.Visible := False;
  txtSite.Visible := False;
  cbFormatoHino.Visible := False;

  cbNome.Items.Clear;
  cbNome.ItemIndex := -1;
  cbKeys.Items.Clear;
  cbKeys.ItemIndex := -1;

  if (cbAbrir.ItemIndex = 0) then
  begin
    qrHINOS_LITURGIA.Close;
    qrHINOS_LITURGIA.Filtered := false;
    qrHINOS_LITURGIA.Open;
    while not qrHINOS_LITURGIA.Eof do
    begin
      cbNome.Items.Add(qrHINOS_LITURGIA.FieldByName('NOME').AsString);
      cbKeys.Items.Add(qrHINOS_LITURGIA.FieldByName('FAIXA').AsString);
      qrHINOS_LITURGIA.Next;
    end;

    cbFormatoHino.Items := cbExtensaoHinos.Items;
    cbFormatoHino.ItemIndex := cbFormatoHino.Items.IndexOf(lerParam('Hinario','Formato','pps'));

    seHino.MinValue := 1;
    seHino.MaxValue := 610;
    seHino.MaxLength := 3;
    seHino.Value := 1;
    seHino.Left := 5;
    seHinoChange(nil);
    cbNome.Left := (seHino.Width + 10);
    cbNome.Width := (pnlLitPanel.Width - seHino.Width - cbFormatoHino.Width - 20);
    cbNome.BoundLabel.Caption := 'Hino:';
    cbFormatoHino.Left := (seHino.Width + cbNome.Width + 15);
    seHino.Visible := true;
    cbNome.Visible := true;
    cbFormatoHino.Visible := True;
  end
  else
  if (cbAbrir.ItemIndex = 1) then
  begin
    qrCOLETANEAS_LITURGIA.Close;
    qrCOLETANEAS_LITURGIA.Filtered := false;
    qrCOLETANEAS_LITURGIA.Open;
    while not qrCOLETANEAS_LITURGIA.Eof do
    begin
      cbNome.Items.Add(qrCOLETANEAS_LITURGIA.FieldByName('NOME_ALBUM').AsString);
      cbKeys.Items.Add(qrCOLETANEAS_LITURGIA.FieldByName('ID').AsString);
      qrCOLETANEAS_LITURGIA.Next;
    end;

    seHino.MinValue := 0;
    seHino.MaxValue := 0;
    seHino.MaxLength := 0;
    cbNome.Left := 5;
    cbNome.Width := (pnlLitPanel.Width - 10);
    cbNome.BoundLabel.Caption := 'Escolha a Coletânea:';
    cbNome.Visible := true;
  end
  else
  if (cbAbrir.ItemIndex = 2) then
  begin
    txtNome.Left := 5;
    txtNome.Width := txtItem.Width;
    txtUrl.Left := (txtNome.Width + 10);
    txtUrl.Width := (pnlLitPanel.Width - txtNome.Width - 15);
    txtNome.Visible := true;
    txtUrl.Visible := True;
  end
  else
  if (cbAbrir.ItemIndex = 3) then
  begin
    txtNome.Left := 5;
    txtNome.Width := txtItem.Width;
    txtSite.Left := (txtNome.Width + 10);
    txtSite.Width := (pnlLitPanel.Width - txtNome.Width - 15);
    txtNome.Visible := true;
    txtSite.Visible := True;
  end;
end;

procedure TfmIndex.cbNomeChange(Sender: TObject);
begin
  cbKeys.ItemIndex := cbNome.ItemIndex;
  seHino.Value := StrToInt(cbKeys.Items[cbNome.ItemIndex]);
end;

procedure TfmIndex.seHinoChange(Sender: TObject);
begin
  cbNome.ItemIndex := cbKeys.Items.IndexOf(IntToStr(seHino.Value));
  cbKeys.ItemIndex := cbNome.ItemIndex;
end;

procedure TfmIndex.btSaveClick(Sender: TObject);
var
  acao: string;
  vUrlCol: string;
  id: string;
  ordem: integer;
begin
  if trim(txtID.text) = ''
    then acao := 'INS'
    else acao := 'ALT';

  if (trim(txtItem.Text) = '') and (cbAbrir.ItemIndex <> 5) then
  begin
    application.messagebox('Digite o nome do item da liturgia!',TITULO,MB_OK+mb_iconexclamation);
    txtItem.SetFocus;
    exit;
  end;

  if (cbAbrir.ItemIndex <= -1) then
  begin
    application.messagebox('Escolha um objeto para abrir!',TITULO,MB_OK+mb_iconexclamation);
    cbAbrir.SetFocus;
    cbAbrir.DroppedDown;
    exit;
  end;

  if (cbAbrir.ItemIndex = 1) and (cbNome.ItemIndex <= -1) then
  begin
    application.messagebox('Escolha uma coletânea para abrir!',TITULO,MB_OK+mb_iconexclamation);
    cbNome.SetFocus;
    cbNome.DroppedDown;
    exit;
  end;

  if (cbAbrir.ItemIndex = 2) and (trim(txtNome.text) = '') then
  begin
    application.messagebox('Digite o nome do arquivo!',TITULO,MB_OK+mb_iconexclamation);
    txtNome.SetFocus;
    exit;
  end;

  if (cbAbrir.ItemIndex = 2) and (trim(txtUrl.text) = '') then
  begin
    application.messagebox('Mencione o diretório do arquivo!',TITULO,MB_OK+mb_iconexclamation);
    txtUrl.SetFocus;
    exit;
  end;

  if (cbAbrir.ItemIndex = 2) then
  begin
    vUrlCol := IfThen(txtUrlInfo.Text = 'I',ExtractFilePath(Application.ExeName)+'\')+txtUrl.text;
    if (not FileExists(vUrlCol)) then
    begin
      application.messagebox(PChar('Arquivo "'+vUrlCol+'" não encontrado!'),fmIndex.TITULO,MB_OK+mb_iconerror);
      txtUrl.SetFocus;
      exit;
    end;
  end;

  if (cbAbrir.ItemIndex = 3) and (trim(txtSite.text) = '') then
  begin
    application.messagebox('Mencione o endereço da página web!',TITULO,MB_OK+mb_iconexclamation);
    cbAbrir.SetFocus;
    exit;
  end;

  cbKeys.ItemIndex := cbNome.ItemIndex;
  if (acao = 'INS') then
  begin
    id := FormatDateTime('ddmmyyyyhhnnsszzz',Now);
    if (cdsLITURGIA.Locate('ID', id, [])) then
    begin
      application.messagebox('Não foi possível salvar. Clique em salvar novamente!',fmIndex.TITULO,MB_OK+mb_iconerror);
      exit;
    end;

    cdsLITURGIA.Last;
    if cdsLITURGIA.RecordCount <= 0
      then ordem := 1
      else ordem := cdsLITURGIA.FieldByName('ORDEM').AsInteger+1;

    cdsLITURGIA.Append;
    cdsLITURGIA.FieldByName('ID').Value := id;
    cdsLITURGIA.FieldByName('ORDEM').Value := ordem;
    cdsLITURGIA.FieldByName('SEMANA').Value := seSemana.Value;
  end
  else
  begin
    cdsLITURGIA.Locate('ID', txtID.Text, []);
    cdsLITURGIA.Edit;
  end;

  cdsLITURGIA.FieldByName('ITEM').Value := txtItem.Text;
  cdsLITURGIA.FieldByName('TIPO').Value := cbAbrir.ItemIndex;
  if (cbAbrir.ItemIndex = 0) then
  begin
    cdsLITURGIA.FieldByName('NOME').Value := '';
    cdsLITURGIA.FieldByName('URL').Value := cbKeys.Items[cbNome.ItemIndex];
    cdsLITURGIA.FieldByName('URL_INFO').Value := cbFormatoHino.Items[cbFormatoHino.ItemIndex];
  end
  else
  if (cbAbrir.ItemIndex = 1) then
  begin
    cdsLITURGIA.FieldByName('NOME').Value := '';
    cdsLITURGIA.FieldByName('URL').Value := cbKeys.Items[cbNome.ItemIndex];
    cdsLITURGIA.FieldByName('URL_INFO').Value := '';
  end
  else
  if (cbAbrir.ItemIndex = 2) then
  begin
    cdsLITURGIA.FieldByName('NOME').Value := txtNome.Text;
    cdsLITURGIA.FieldByName('URL').Value := txtUrl.Text;
    cdsLITURGIA.FieldByName('URL_INFO').Value := txtUrlInfo.text;
  end
  else
  if (cbAbrir.ItemIndex = 3) then
  begin
    cdsLITURGIA.FieldByName('NOME').Value := txtNome.Text;
    cdsLITURGIA.FieldByName('URL').Value := txtSite.Text;
    cdsLITURGIA.FieldByName('URL_INFO').Value := '';
  end
  else
  begin
    cdsLITURGIA.FieldByName('NOME').Value := '';
    cdsLITURGIA.FieldByName('URL').Value := '';
    cdsLITURGIA.FieldByName('URL_INFO').Value := '';
  end;
  cdsLITURGIA.Post;

  cdsLITURGIA.SaveToFile(ExtractFilePath(Application.ExeName)+'\config\liturgia.xml');

  limpaCamposLiturgia();
  TToolButton(FindComponent('lcal_'+inttostr(seSemana.Value)) as TToolButton).Click;
end;

procedure TfmIndex.carregaLiturgia(dia_semana: integer);
var
  item: TListItem;
  nome,url: string;
  tipo: integer;
  ico: integer;
begin
  sListView1.Items.Clear;

  cdsLITURGIA.Filtered := false;
  cdsLITURGIA.Filter := 'SEMANA = '+inttostr(dia_semana);
  cdsLITURGIA.Filtered := true;

  cdsLITURGIA.First;
  while not cdsLITURGIA.Eof do
  begin
    item := sListView1.Items.Add;
    item.Caption := cdsLITURGIA.fieldByName('ITEM').AsString;


    tipo := cdsLITURGIA.fieldByName('TIPO').AsInteger;
    ico := -1;
    if (tipo = 0) then
    begin
      qrHINOS_LITURGIA.Close;
      qrHINOS_LITURGIA.Filter := 'FAIXA = '+cdsLITURGIA.fieldByName('URL').AsString;
      qrHINOS_LITURGIA.Filtered := true;
      qrHINOS_LITURGIA.Open;

      item.ImageIndex := 50;

      nome := 'Hino '+qrHINOS_LITURGIA.fieldbyname('FAIXA').AsString+' - '+qrHINOS_LITURGIA.fieldbyname('NOME').AsString+' (.'+cdsLITURGIA.fieldByName('URL_INFO').AsString+')';
      url := ExtractFilePath(application.ExeName)+'config\'+qrHINOS_LITURGIA.fieldbyname('URL_ALBUM').AsString;
      if (cdsLITURGIA.fieldByName('URL_INFO').AsString <> '')
        then url := ChangeFileExt(url,'.'+cdsLITURGIA.fieldByName('URL_INFO').AsString)
        else url := ChangeFileExt(url,'.'+lerParam('Hinario','Formato','pps'));
      ico := 47;
    end
    else if (tipo = 1) then
    begin
      qrCOLETANEAS_LITURGIA.Close;
      qrCOLETANEAS_LITURGIA.Filter := 'ID = '+cdsLITURGIA.fieldByName('URL').AsString;
      qrCOLETANEAS_LITURGIA.Filtered := true;
      qrCOLETANEAS_LITURGIA.Open;

      item.ImageIndex := 50;

      nome := 'Coletânea: '+qrCOLETANEAS_LITURGIA.fieldbyname('NOME_ALBUM').AsString;
      url := ExtractFilePath(application.ExeName)+'config\'+qrCOLETANEAS_LITURGIA.fieldbyname('URL').AsString;
      if (qrCOLETANEAS_LITURGIA.fieldbyname('TIPO').AsString = 'JA')
        then ico := 46
        else ico := 45;
    end
    else if (tipo = 2) then
    begin
      item.ImageIndex := 50;

      nome := cdsLITURGIA.fieldByName('NOME').AsString;
      if (cdsLITURGIA.fieldByName('URL_INFO').AsString = 'I')
        then url := ExtractFilePath(application.ExeName)+cdsLITURGIA.fieldByName('URL').AsString
        else url := cdsLITURGIA.fieldByName('URL').AsString;
      ico := 48;
    end
    else if (tipo = 3) then
    begin
      item.ImageIndex := 50;

      nome := cdsLITURGIA.fieldByName('NOME').AsString;
      url := cdsLITURGIA.fieldByName('URL').AsString;
      ico := 49;
    end
    else if (tipo = 4) then
    begin
      item.ImageIndex := 19;

      nome := UpperCase(cdsLITURGIA.fieldByName('NOME').AsString);
      url := cdsLITURGIA.fieldByName('URL').AsString;
      ico := -1;
    end
    else
    begin
      item.ImageIndex := 51;

      nome := cdsLITURGIA.fieldByName('NOME').AsString;
      url := cdsLITURGIA.fieldByName('URL').AsString;
      ico := -1;
    end;

    item.SubItems.Add(nome);
    item.SubItemImages[0] := ico;
    item.SubItems.Add(url);
    item.SubItems.Add(cdsLITURGIA.fieldByName('ID').AsString);
    cdsLITURGIA.Next;
  end;
end;

procedure TfmIndex.sListView1DblClick(Sender: TObject);
var
  item: Integer;
  URL: string;
begin
  item := TsListView(Sender).ItemIndex;
  if (item < 0) then Exit;

  URL := TsListView(Sender).Items[item].SubItems[1];
  if (trim(URL) = '') then Exit;

  StatusMSG('Aguarde... Carregando Coletânea '''+URL+'');

  lmdEXEC.Command := URL;
  lmdEXEC.Execute;

  StatusMSG;
end;

procedure TfmIndex.lbCronoKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = vk_Delete then
    ToolButton9Click(Sender);
end;

procedure TfmIndex.MenuItem2Click(Sender: TObject);
var
  item: Integer;
  id: string;
begin
  if (sListView1.SelCount <= 0) then Exit;

  item := sListView1.Selected.Index;
  id := sListView1.Items[item].SubItems[2];

  cdsLITURGIA.Locate('ID', id, []);
  cdsLITURGIA.Delete;
  cdsLITURGIA.SaveToFile(ExtractFilePath(Application.ExeName)+'\config\liturgia.xml');

  sListView1.DeleteSelected;           
//  TToolButton(FindComponent('lcal_'+inttostr(seSemana.Value)) as TToolButton).Click;
end;

procedure TfmIndex.ppLiturgiaGridPopup(Sender: TObject);
var
  item: Integer;
begin
  if (sListView1.SelCount <= 0) then
  begin
    Abort;
    Exit;
  end;

  item := sListView1.Selected.Index;
  miUp.Enabled := (item > 0);
  miDown.Enabled := (item < sListView1.Items.Count-1);
end;

procedure TfmIndex.miUpClick(Sender: TObject);
var
  item: integer;
  id,nid: string;
  ordem,nordem: integer;
begin
  if (sListView1.SelCount <= 0) or (sListView1.Selected.Index <= 0) then Exit;

  item := sListView1.Selected.Index;

  id := sListView1.Items[item].SubItems[2];
  cdsLITURGIA.Locate('ID', id, []);
  ordem := cdsLITURGIA.fieldbyname('ORDEM').AsInteger;

  cdsLITURGIA.Locate('ID', id, []);  
  cdsLITURGIA.Prior;

  nid := cdsLITURGIA.fieldbyname('ID').AsString;
  nordem := cdsLITURGIA.fieldbyname('ORDEM').AsInteger;

  cdsLITURGIA.Locate('ID', nid, []);
  cdsLITURGIA.Edit;
  cdsLITURGIA.FieldByName('ORDEM').Value := ordem;
  cdsLITURGIA.Post;

  cdsLITURGIA.Locate('ID', id, []);
  cdsLITURGIA.Edit;
  cdsLITURGIA.FieldByName('ORDEM').Value := nordem;
  cdsLITURGIA.Post;

  cdsLITURGIA.SaveToFile(ExtractFilePath(Application.ExeName)+'\config\liturgia.xml');
  TToolButton(FindComponent('lcal_'+inttostr(seSemana.Value)) as TToolButton).Click;

  cdsLITURGIA.Locate('ID', id, []);
  sListView1.ItemIndex := item-1;
  sListView1.Selected.Focused := true;
end;

procedure TfmIndex.sListView1Change(Sender: TObject; Item: TListItem;
  Change: TItemChange);
begin
  if (sListView1.SelCount <= 0) then Exit;
  cdsLITURGIA.Locate('ID', sListView1.Items[sListView1.Selected.Index].SubItems[2], []);
end;

procedure TfmIndex.miDownClick(Sender: TObject);
var
  item: integer;
  id,nid: string;
  ordem,nordem: integer;
begin
  if (sListView1.SelCount <= 0) or (sListView1.Selected.Index >= sListView1.Items.Count-1) then Exit;

  item := sListView1.Selected.Index;

  id := sListView1.Items[item].SubItems[2];
  cdsLITURGIA.Locate('ID', id, []);
  ordem := cdsLITURGIA.fieldbyname('ORDEM').AsInteger;

  cdsLITURGIA.Locate('ID', id, []);  
  cdsLITURGIA.Next;

  nid := cdsLITURGIA.fieldbyname('ID').AsString;
  nordem := cdsLITURGIA.fieldbyname('ORDEM').AsInteger;

  cdsLITURGIA.Locate('ID', nid, []);
  cdsLITURGIA.Edit;
  cdsLITURGIA.FieldByName('ORDEM').Value := ordem;
  cdsLITURGIA.Post;

  cdsLITURGIA.Locate('ID', id, []);
  cdsLITURGIA.Edit;
  cdsLITURGIA.FieldByName('ORDEM').Value := nordem;
  cdsLITURGIA.Post;

  cdsLITURGIA.SaveToFile(ExtractFilePath(Application.ExeName)+'\config\liturgia.xml');
  TToolButton(FindComponent('lcal_'+inttostr(seSemana.Value)) as TToolButton).Click;

  cdsLITURGIA.Locate('ID', id, []);
  sListView1.ItemIndex := item+1;
  sListView1.Selected.Focused := true;
end;

procedure TfmIndex.MenuItem1Click(Sender: TObject);
var
  item: integer;
  id: string;
begin
  if (sListView1.SelCount <= 0) then Exit;

  limpaCamposLiturgia();

  pnlLitBotoes.Width := 82;
  btSave.ImageIndex := 2;
  btSave.Left := 5;
  btCancel.Left := 42;
  
  item := sListView1.Selected.Index;
  id := sListView1.Items[item].SubItems[2];
  cdsLITURGIA.Locate('ID', id, []);

  txtID.text := cdsLITURGIA.fieldbyname('ID').AsString;
  txtItem.Text := cdsLITURGIA.fieldbyname('ITEM').AsString;
  cbAbrir.ItemIndex := cdsLITURGIA.fieldbyname('TIPO').AsInteger;
  cbAbrirChange(nil);
  if (cbAbrir.ItemIndex = 0) then
  begin
    qrHINOS_LITURGIA.Close;
    qrHINOS_LITURGIA.Filtered := false;
    qrHINOS_LITURGIA.Open;
    while not qrHINOS_LITURGIA.Eof do
    begin
      cbNome.Items.Add(qrHINOS_LITURGIA.FieldByName('NOME').AsString);
      cbKeys.Items.Add(qrHINOS_LITURGIA.FieldByName('FAIXA').AsString);
      qrHINOS_LITURGIA.Next;
    end;

    cbFormatoHino.Items := cbExtensaoHinos.Items;
    if (cdsLITURGIA.fieldbyname('URL_INFO').AsString <> '')
      then cbFormatoHino.ItemIndex := cbFormatoHino.Items.IndexOf(cdsLITURGIA.fieldbyname('URL_INFO').AsString)
      else cbFormatoHino.ItemIndex := cbFormatoHino.Items.IndexOf(lerParam('Hinario','Formato','pps'));

    seHino.MinValue := 1;
    seHino.MaxValue := 610;
    seHino.MaxLength := 3;
    seHino.Value := StrToInt(cdsLITURGIA.fieldbyname('URL').AsString);
    seHino.Left := 5;
    seHinoChange(nil);
    cbNome.Left := (seHino.Width + 10);
    cbNome.Width := (pnlLitPanel.Width - seHino.Width - cbFormatoHino.Width - 20);
    cbNome.BoundLabel.Caption := 'Hino:';
    cbFormatoHino.Left := (seHino.Width + cbNome.Width + 15);
    seHino.Visible := true;
    cbNome.Visible := true;
    cbFormatoHino.Visible := True;
  end
  else
  if (cbAbrir.ItemIndex = 1) then
  begin
    qrCOLETANEAS_LITURGIA.Close;
    qrCOLETANEAS_LITURGIA.Filtered := false;
    qrCOLETANEAS_LITURGIA.Open;
    while not qrCOLETANEAS_LITURGIA.Eof do
    begin
      cbNome.Items.Add(qrCOLETANEAS_LITURGIA.FieldByName('NOME_ALBUM').AsString);
      cbKeys.Items.Add(qrCOLETANEAS_LITURGIA.FieldByName('ID').AsString);
      qrCOLETANEAS_LITURGIA.Next;
    end;

    seHino.MinValue := 0;
    seHino.MaxValue := 0;
    seHino.MaxLength := 0;
    seHino.Value := StrToInt(cdsLITURGIA.fieldbyname('URL').AsString);
    cbNome.Left := 5;
    cbNome.Width := (pnlLitPanel.Width - 10);
    cbNome.BoundLabel.Caption := 'Escolha a Coletânea:';
    cbNome.Visible := true;
  end
  else
  if (cbAbrir.ItemIndex = 2) then
  begin
    txtNome.Left := 5;
    txtNome.Width := txtItem.Width;
    txtUrl.Left := (txtNome.Width + 10);
    txtUrl.Width := (pnlLitPanel.Width - txtNome.Width - 15);

    txtNome.Text := cdsLITURGIA.fieldbyname('NOME').AsString;
    txtUrl.Text := cdsLITURGIA.fieldbyname('URL').AsString;
    txtUrlInfo.Text := cdsLITURGIA.fieldbyname('URL_INFO').AsString;

    txtNome.Visible := true;
    txtUrl.Visible := True;
  end
  else
  if (cbAbrir.ItemIndex = 3) then
  begin
    txtNome.Left := 5;
    txtNome.Width := txtItem.Width;
    txtSite.Left := (txtNome.Width + 10);
    txtSite.Width := (pnlLitPanel.Width - txtNome.Width - 15);

    txtNome.Text := cdsLITURGIA.fieldbyname('NOME').AsString;
    txtSite.Text := cdsLITURGIA.fieldbyname('URL').AsString;

    txtNome.Visible := true;
    txtSite.Visible := True;
  end;

  btSave.Visible := True;
  btCancel.Visible := True;
end;

procedure TfmIndex.btCancelClick(Sender: TObject);
begin
  limpaCamposLiturgia();
end;

procedure TfmIndex.sListView1CustomDrawItem(Sender: TCustomListView;
  Item: TListItem; State: TCustomDrawState; var DefaultDraw: Boolean);
begin
  if Item.ImageIndex = 19 then
  begin
    sListview1.Canvas.Brush.Color := $00E8B17A;
    sListview1.Canvas.Font.Color := clWhite;
  end;
end;

procedure TfmIndex.sTabSheet2Show(Sender: TObject);
begin
  carrega_opc := True;

  if (loadCol.Strings.Values['OPCOES'] <> 'ok') then
  begin
    loadCol.Strings.Values['OPCOES'] := 'ok';
    sbOpc.VertScrollBar.Position := 0;
  end;

  cbExtensaoHinos.ItemIndex := cbExtensaoHinos.Items.IndexOf(lerParam('Hinario','Formato','pps'));
  sbMonitorAreaExtendida.ItemIndex := sbMonitorAreaExtendida.Items.IndexOf(lerParam('Config','Monitor','2'));

  fcBibliaFonte.ItemIndex := fcEscsbFonte.Items.IndexOf(lerParam('Biblia','Fonte',fonte));
  seBibliaTamanho.Value := strtoint(lerParam('Biblia','Tamanho','36'));
  seBibliaTamanhoExtendido.Value := strtoint(lerParam('Biblia','Tamanho (Extendido)','36'));
  seBibliaTamanho2.Value := strtoint(lerParam('Biblia','Tamanho Titulo','36'));
  seBibliaTamanhoExtendido2.Value := strtoint(lerParam('Biblia','Tamanho Titulo (Extendido)','36'));
  seBibliaTamanho3.Value := strtoint(lerParam('Biblia','Tamanho Versao','36'));
  seBibliaTamanhoExtendido3.Value := strtoint(lerParam('Biblia','Tamanho Versao (Extendido)','36'));
  csBibliaCor.ColorValue := StringToColor(lerParam('Biblia','Cor','clBlack'));
  csBibliaCor2.ColorValue := StringToColor(lerParam('Biblia','Cor Versos','$00dbb497'));
  csBibliaCor3.ColorValue := StringToColor(lerParam('Biblia','Cor Titulo','$00dbb497'));
  csBibliaCor4.ColorValue := StringToColor(lerParam('Biblia','Cor Versao','$00dbb497'));
  csBibliaCorFundo.ColorValue := StringToColor(lerParam('Biblia','Cor Fundo','clWhite'));
  tsBibliaImagem.Text := lerParam('Biblia','Imagem Fundo','');
  tsBibliaImagemInfo.Text := lerParam('Biblia','Imagem Fundo - UrlInfo','');

  fcBibliabFonte.ItemIndex := fcEscsbFonte.Items.IndexOf(lerParam('Busca Biblica','Fonte',fonte));
  seBibliabTamanho.Value := strtoint(lerParam('Busca Biblica','Tamanho','36'));
  seBibliabTamanhoExtendido.Value := strtoint(lerParam('Busca Biblica','Tamanho (Extendido)','36'));
  seBibliabTamanho2.Value := strtoint(lerParam('Busca Biblica','Tamanho Titulo','36'));
  seBibliabTamanhoExtendido2.Value := strtoint(lerParam('Busca Biblica','Tamanho Titulo (Extendido)','36'));
  seBibliabTamanho3.Value := strtoint(lerParam('Busca Biblica','Tamanho Versao','36'));
  seBibliabTamanhoExtendido3.Value := strtoint(lerParam('Busca Biblica','Tamanho Versao (Extendido)','36'));
  csBibliabCor.ColorValue := StringToColor(lerParam('Busca Biblica','Cor','clBlack'));
  csBibliabCor2.ColorValue := StringToColor(lerParam('Busca Biblica','Cor Passagem','$00dbb497'));
  csBibliabCor3.ColorValue := StringToColor(lerParam('Busca Biblica','Cor Titulo','$00dbb497'));
  csBibliabCor4.ColorValue := StringToColor(lerParam('Busca Biblica','Cor Versao','$00dbb497'));
  csBibliabCor5.ColorValue := StringToColor(lerParam('Busca Biblica','Cor Palavra Buscada','clRed'));
  csBibliabCorFundo.ColorValue := StringToColor(lerParam('Busca Biblica','Cor Fundo','clWhite'));
  tsBibliabImagem.Text := lerParam('Busca Biblica','Imagem Fundo','');
  tsBibliabImagemInfo.Text := lerParam('Busca Biblica','Imagem Fundo - UrlInfo','');

  fcEscsbFonte.ItemIndex := fcEscsbFonte.Items.IndexOf(lerParam('Escola Sabatina','Fonte',fonte));
  seEscsbTamanho.Value := strtoint(lerParam('Escola Sabatina','Tamanho','150'));
  seEscsbTamanhoExtendido.Value := strtoint(lerParam('Escola Sabatina','Tamanho (Extendido)','150'));
  csEscsbCor.ColorValue := StringToColor(lerParam('Escola Sabatina','Cor','clBlack'));
  seEscsbTamanho2.Value := strtoint(lerParam('Escola Sabatina','Tamanho 2','72'));
  seEscsbTamanhoExtendido2.Value := strtoint(lerParam('Escola Sabatina','Tamanho 2 (Extendido)','72'));
  csEscsbCor2.ColorValue := StringToColor(lerParam('Escola Sabatina','Cor 2','clRed'));
  csEscsbCorFundo.ColorValue := StringToColor(lerParam('Escola Sabatina','Cor Fundo','clWhite'));

  fcSorteioFonte.ItemIndex := fcCronoFonte.Items.IndexOf(lerParam('Sorteio','Fonte',fonte));
  seSorteioTamanho.Value := strtoint(lerParam('Sorteio','Tamanho','100'));
  seSorteioTamanhoExtendido.Value := strtoint(lerParam('Sorteio','Tamanho (Extendido)','100'));
  csSorteioCor.ColorValue := StringToColor(lerParam('Sorteio','Cor','clBlack'));
  csSorteioCorFundo.ColorValue := StringToColor(lerParam('Sorteio','Cor Fundo','clWhite'));
  cbSorteioEl1.Checked := (lerParam('Sorteio','Numeros Disponiveis (Extendido)','1') = '1');
  cbSorteioEl2.Checked := (lerParam('Sorteio','Numeros Sorteados (Extendido)','1') = '1');

  fcCronoFonte.ItemIndex := fcCronoFonte.Items.IndexOf(lerParam('Cronometro','Fonte',fonte));
  seCronoTamanho.Value := strtoint(lerParam('Cronometro','Tamanho','85'));
  seCronoTamanhoExtendido.Value := strtoint(lerParam('Cronometro','Tamanho (Extendido)','85'));
  csCronoCor.ColorValue := StringToColor(lerParam('Cronometro','Cor','clBlack'));
  csCronoCorFundo.ColorValue := StringToColor(lerParam('Cronometro','Cor Fundo','clWhite'));
  cbCronoEl1.Checked := (lerParam('Cronometro','Tempos Gravados (Extendido)','1') = '1');

  carrega_opc := False;
end;

procedure TfmIndex.cbExtensaoHinosChange(Sender: TObject);
begin
  cbExtensaoHinosHinario.ItemIndex := cbExtensaoHinos.ItemIndex;
  gravaParam('Hinario','Formato',cbExtensaoHinos.Items[cbExtensaoHinos.ItemIndex]);
end;

procedure TfmIndex.cbExtensaoHinosHinarioChange(Sender: TObject);
begin
  cbExtensaoHinos.ItemIndex := cbExtensaoHinosHinario.ItemIndex;
  cbExtensaoHinosChange(Sender);
end;

procedure TfmIndex.sbMonitorAreaExtendidaChange(Sender: TObject);
begin
  gravaParam('Config','Monitor',sbMonitorAreaExtendida.Items[sbMonitorAreaExtendida.ItemIndex]);
end;

procedure TfmIndex.expandirArea(Sender: TObject);
var
  abre: Boolean;
  monitor: Integer;
  tag: integer;
begin
  if Sender = nil
    then abre := False
  else
  begin
    if (TsButton(Sender).ImageIndex <> 54)
      then abre := True
      else abre := False;
  end;

  btExp_Biblia.ImageIndex := 53;
  btExp_BibliaBusca.ImageIndex := 53;
  btExp_EscolaSabatina.ImageIndex := 53;
  btExp_Sorteio.ImageIndex := 53;
  btExp_Cronometro.ImageIndex := 53;

  if abre = True then
  begin
    if fMonitor <> nil then
      fMonitor.Close;

    monitor := strtoint(lerParam('Config','Monitor','2'));
    if (Screen.MonitorCount < monitor) then
    begin
      if (Application.MessageBox('Não foi possível localizar monitor secundário. Deseja abrir no monitor principal?',TITULO,mb_yesno+mb_iconquestion) <> 6) then
        Exit;

      monitor := 0;
    end
    else monitor := monitor-1;

    application.CreateForm(TfMonitor,fMonitor);

    tag := TsButton(Sender).Tag;
    fMonitor.tag := tag;

    fMonitor.show;


    fMonitor.Left := Screen.Monitors[monitor].Left;
    fMonitor.Top := Screen.Monitors[monitor].Top;
    fMonitor.Width := Screen.Monitors[monitor].Width;
    fMonitor.Height := Screen.Monitors[monitor].Height;

    copiaDadosTelaExtendida();
  end
  else
    if Sender <> nil then
      fMonitor.Close;

  if (abre = true) then TsButton(Sender).ImageIndex := 54;
end;

procedure TfmIndex.tsDesenvolvedorShow(Sender: TObject);
var
  i: integer;
  item: TListItem;
begin
  lvMonitores.Items.Clear;
  for i := 0 to Screen.MonitorCount-1 do
  begin
    item := lvMonitores.Items.Add;
    item.Caption := 'Monitor '+inttostr(i+1);

    item := lvMonitores.Items.Add;
    item.Caption := 'Índice';
    item.SubItems.Add(inttostr(i));

    item := lvMonitores.Items.Add;
    item.Caption := 'Dimensões';
    item.SubItems.Add(inttostr(Screen.Monitors[i].Width)+'px x '+inttostr(Screen.Monitors[i].Height)+'px');

    item := lvMonitores.Items.Add;
    item.Caption := 'Posição';
    item.SubItems.Add('T: '+inttostr(Screen.Monitors[i].Top)+' | E: '+inttostr(Screen.Monitors[i].Left));

    item := lvMonitores.Items.Add;
    item.Caption := '';
  end;

  mmParam.Lines.Clear;
  for i := 0 to ParamCount do
    mmParam.Text := mmParam.Text + ParamStr(i) + ' ';
  mmParam.Text := trim(mmParam.Text);

  mmConfigJA.Lines.LoadFromFile(ExtractFilePath(application.ExeName)+'config\config.ja');
end;

procedure TfmIndex.copiaDadosTelaExtendida;
var
  indice: integer;
begin
  if fMonitor = nil then Exit;

  indice := fMonitor.tag;

  case indice of
    1: geraPassagem('',false);
    2: localizaPalavraChave(false);
    3: begin
         fMonitor.lmdEscSb.Font.Name := lerParam('Escola Sabatina','Fonte',fonte);
         fMonitor.lmdEscSb.Font.Size := strtoint(lerParam('Escola Sabatina','Tamanho (Extendido)','150'));
         fMonitor.lmdEscSb.Font.Color := StringToColor(lerParam('Escola Sabatina','Cor','clBlack'));

         fMonitor.lmdEscSbR.Font.Name := lerParam('Escola Sabatina','Fonte',fonte);
         fMonitor.lmdEscSbR.Font.Size := strtoint(lerParam('Escola Sabatina','Tamanho 2 (Extendido)','72'));
         fMonitor.lmdEscSbR.Font.Color := StringToColor(lerParam('Escola Sabatina','Cor 2','clRed'));
         fMonitor.pnlEscSB.Color := StringToColor(lerParam('Escola Sabatina','Cor Fundo','clWhite'));

         fMonitor.lmdEscSb.Caption := lmdEscSb.Caption;
         fMonitor.lmdEscSbR.Caption := lmdEscSbR.Caption;
         fMonitor.gEscSbR.MaxValue := gEscSbR.MaxValue;
         fMonitor.gEscSbR.Progress := gEscSbR.Progress;
         posicionaElementosTimers();
       end;
    4: begin
         fMonitor.lmdSorteio.Font.Name := lerParam('Sorteio','Fonte',fonte);
         fMonitor.lmdSorteio.Font.Size := strtoint(lerParam('Sorteio','Tamanho (Extendido)','100'));
         fMonitor.lmdSorteio.Font.Color := StringToColor(lerParam('Sorteio','Cor','clBlack'));
         fMonitor.pnlSorteio.Color := StringToColor(lerParam('Sorteio','Cor Fundo','clWhite'));
         fMonitor.pnlSorteioD.Color := fMonitor.pnlSorteio.Color;
         fMonitor.pnlSorteioE.Color := fMonitor.pnlSorteio.Color;
         fMonitor.pnlSorteioE.Visible := (lerParam('Sorteio','Numeros Disponiveis (Extendido)','1') = '1');
         fMonitor.pnlSorteioD.Visible := (lerParam('Sorteio','Numeros Sorteados (Extendido)','1') = '1');

         fMonitor.lmdSorteio.Caption := lmdSorteio.Caption;
         fMonitor.lblNumDis.Caption := lblNumDis.Caption;
         fMonitor.lblNumSort.Caption := lblNumSort.Caption;
         fMonitor.lbSort_D.Clear;
         fMonitor.lbSort_S.Clear;
         fMonitor.lbSort_D.Items := lbSort_D.Items;
         fMonitor.lbSort_S.Items := lbSort_S.Items;
         fMonitor.gSorteio.MaxValue := gSorteio.MaxValue;
         fMonitor.gSorteio.Progress := gSorteio.Progress;
         posicionaElementosTimers();
       end;
    5: begin
         fMonitor.lmdCrono.Font.Name := lerParam('Cronometro','Fonte',fonte);
         fMonitor.lmdCrono.Font.Size := strtoint(lerParam('Cronometro','Tamanho (Extendido)','85'));
         fMonitor.lmdCrono.Font.Color := StringToColor(lerParam('Cronometro','Cor','clBlack'));
         fMonitor.pnlCrono.Color := StringToColor(lerParam('Cronometro','Cor Fundo','clWhite'));
         fMonitor.pnlTempoGravado.Color := fMonitor.pnlCrono.Color;
         fMonitor.pnlTempoGravado.Visible := (lerParam('Cronometro','Tempos Gravados (Extendido)','1') = '1');

         fMonitor.lmdCrono.Caption := lmdCrono.Caption;
         fMonitor.lbCrono.Items := lbCrono.Items;
         fMonitor.gCrono.MaxValue := gCrono.MaxValue;
         fMonitor.gCrono.Progress := gCrono.Progress;
         posicionaElementosTimers();
       end;
  end;

end;

function TfmIndex.monitorAtivo(index: integer): Boolean;
begin
  if fMonitor = nil
    then result := False
    else result := (fMonitor.tag = index);
end;

procedure TfmIndex.WBLoadHTML(WebBrowser: TWebBrowser; HTMLCode: string);
var
   sl: TStringList; 
   ms: TMemoryStream;
   tag: integer;
   css: string;
   img,img_ui: string;
begin
  css := 'overflow:auto;overflow-x:hidden;border:0;margin:0;';
  tag := WebBrowser.Tag;

  if (tag = 1) then
  begin
    css := css + 'background-color:'+ColorToHtml(StringToColor(lerParam('Biblia','Cor Fundo','clWhite')))+';';

    img := lerParam('Biblia','Imagem Fundo','');
    img_ui := lerParam('Biblia','Imagem Fundo - UrlInfo','');
  end
  else if (tag = 2) then
  begin
    css := css + 'background-color:'+ColorToHtml(StringToColor(lerParam('Busca Biblica','Cor Fundo','clWhite')))+';';

    img := lerParam('Busca Biblica','Imagem Fundo','');
    img_ui := lerParam('Busca Biblica','Imagem Fundo - UrlInfo','');
  end;

  if (img <> '') then
  begin
    if (img_ui = 'I') then img := ExtractFilePath(Application.ExeName)+img;
    HTMLCode := '<img id="fundo" border=0 src="'+img+'" style="top:0;top: expression((0+(ignoreMe=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop))+''px'');left:0;position:absolute;z-index:-999;width:100%;height:'+inttostr(WebBrowser.Height)+'px;">' + HTMLCode;
  end;

  HTMLCode := '<html style="'+css+'"><head></head><body style="'+css+'">'+HTMLCode+'</body></hmtl>';
  WebBrowser.Navigate('about:blank') ;
  while WebBrowser.ReadyState < READYSTATE_INTERACTIVE do
    Application.ProcessMessages;

  if Assigned(WebBrowser.Document) then
  begin
    sl := TStringList.Create;
    try
      ms := TMemoryStream.Create;
      try
        sl.Text := HTMLCode;
        sl.SaveToStream(ms) ;
        ms.Seek(0, 0) ;
        (WebBrowser.Document as IPersistStreamInit).Load(TStreamAdapter.Create(ms)) ;
      finally
        ms.Free;
      end;
    finally
      sl.Free;
    end;
  end;

//  WebBrowser.OleObject.document.body.style.overflowX := 'hidden';
//  WebBrowser.OleObject.document.body.style.overflowY := 'hidden';
  WebBrowser.OleObject.document.body.style.borderstyle := 'none';
end;

procedure TfmIndex.btOpcResetClick(Sender: TObject);
var
  tag: integer;
begin
  tag := TComponent(Sender).Tag;
  if (tag = 1) then
  begin
    apagaParam('Biblia','Fonte');
    apagaParam('Biblia','Tamanho');
    apagaParam('Biblia','Tamanho (Extendido)');
    apagaParam('Biblia','Tamanho Titulo');
    apagaParam('Biblia','Tamanho Titulo (Extendido)');
    apagaParam('Biblia','Tamanho Versao');
    apagaParam('Biblia','Tamanho Versao (Extendido)');
    apagaParam('Biblia','Cor');
    apagaParam('Biblia','Cor Versos');
    apagaParam('Biblia','Cor Titulo');
    apagaParam('Biblia','Cor Versao');
    apagaParam('Biblia','Cor Fundo');
    apagaParam('Biblia','Imagem Fundo');
    apagaParam('Biblia','Imagem Fundo - UrlInfo');
    loadCol.Strings.Values['BIBLIA'] := '';
    sTabSheet2Show(Sender);
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 2) then
  begin
    apagaParam('Busca Biblica','Fonte');
    apagaParam('Busca Biblica','Tamanho');
    apagaParam('Busca Biblica','Tamanho (Extendido)');
    apagaParam('Busca Biblica','Tamanho Titulo');
    apagaParam('Busca Biblica','Tamanho Titulo (Extendido)');
    apagaParam('Busca Biblica','Tamanho Versao');
    apagaParam('Busca Biblica','Tamanho Versao (Extendido)');
    apagaParam('Busca Biblica','Cor');
    apagaParam('Busca Biblica','Cor Passagem');
    apagaParam('Busca Biblica','Cor Titulo');
    apagaParam('Busca Biblica','Cor Versao');
    apagaParam('Busca Biblica','Cor Palavra Buscada');
    apagaParam('Busca Biblica','Cor Fundo');
    apagaParam('Busca Biblica','Imagem Fundo');
    apagaParam('Busca Biblica','Imagem Fundo - UrlInfo');
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    sTabSheet2Show(Sender);
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 3) then
  begin
    apagaParam('Escola Sabatina','Fonte');
    apagaParam('Escola Sabatina','Tamanho');
    apagaParam('Escola Sabatina','Tamanho (Extendido)');
    apagaParam('Escola Sabatina','Cor');
    apagaParam('Escola Sabatina','Tamanho 2');
    apagaParam('Escola Sabatina','Tamanho 2 (Extendido)');
    apagaParam('Escola Sabatina','Cor 2');
    apagaParam('Escola Sabatina','Cor Fundo');
    loadCol.Strings.Values['ES'] := '';
    sTabSheet2Show(Sender);
  end
  else if (tag = 4) then
  begin
    apagaParam('Sorteio','Fonte');
    apagaParam('Sorteio','Tamanho');
    apagaParam('Sorteio','Tamanho (Extendido)');
    apagaParam('Sorteio','Cor');
    apagaParam('Sorteio','Cor Fundo');
    apagaParam('Sorteio','Numeros Disponiveis (Extendido)');
    apagaParam('Sorteio','Numeros Sorteados (Extendido)');
    loadCol.Strings.Values['SORTEIO'] := '';
    sTabSheet2Show(Sender);
  end
  else if (tag = 5) then
  begin
    apagaParam('Cronometro','Fonte');
    apagaParam('Cronometro','Tamanho');
    apagaParam('Cronometro','Tamanho (Extendido)');
    apagaParam('Cronometro','Cor');
    apagaParam('Cronometro','Cor Fundo');
    apagaParam('Cronometro','Tempos Gravados (Extendido)');
    loadCol.Strings.Values['CRONO'] := '';
    sTabSheet2Show(Sender);
  end;

  copiaDadosTelaExtendida();
  posicionaElementosTimers();
end;

procedure TfmIndex.csOpcCorChange(Sender: TObject);
var
  tag: integer;
begin
  if carrega_opc then Exit;
  
  tag := TComponent(Sender).Tag;
  if (tag = 1) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Cor',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 11) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Cor Versos',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 12) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Cor Titulo',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 13) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Cor Versao',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 19) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Cor Fundo',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 2) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Cor',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 21) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Cor Passagem',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 22) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Cor Titulo',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 23) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Cor Versao',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 24) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Cor Palavra Buscada',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 29) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Cor Fundo',ColorToString(TsColorSelect(Sender).ColorValue));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 3) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Cor',ColorToString(TsColorSelect(Sender).ColorValue));
  end
  else if (tag = 32) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Cor 2',ColorToString(TsColorSelect(Sender).ColorValue));
  end
  else if (tag = 39) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Cor Fundo',ColorToString(TsColorSelect(Sender).ColorValue));
  end
  else if (tag = 4) then
  begin
    loadCol.Strings.Values['SORTEIO'] := '';
    gravaParam('Sorteio','Cor',ColorToString(TsColorSelect(Sender).ColorValue));
  end
  else if (tag = 49) then
  begin
    loadCol.Strings.Values['SORTEIO'] := '';
    gravaParam('Sorteio','Cor Fundo',ColorToString(TsColorSelect(Sender).ColorValue));
  end
  else if (tag = 5) then
  begin
    loadCol.Strings.Values['CRONO'] := '';
    gravaParam('Cronometro','Cor',ColorToString(TsColorSelect(Sender).ColorValue));
  end
  else if (tag = 59) then
  begin
    loadCol.Strings.Values['CRONO'] := '';
    gravaParam('Cronometro','Cor Fundo',ColorToString(TsColorSelect(Sender).ColorValue));
  end;

  copiaDadosTelaExtendida();
end;

procedure TfmIndex.fcOpcFonteChange(Sender: TObject);
var
  tag: integer;
begin
  if carrega_opc then Exit;

  tag := TComponent(Sender).Tag;
  if (tag = 1) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Fonte',TsFontComboBox(Sender).Items[TsFontComboBox(Sender).ItemIndex]);
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 2) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Fonte',TsFontComboBox(Sender).Items[TsFontComboBox(Sender).ItemIndex]);
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 3) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Fonte',TsFontComboBox(Sender).Items[TsFontComboBox(Sender).ItemIndex]);
  end
  else if (tag = 4) then
  begin
    loadCol.Strings.Values['SORTEIO'] := '';
    gravaParam('Sorteio','Fonte',TsFontComboBox(Sender).Items[TsFontComboBox(Sender).ItemIndex]);
  end
  else if (tag = 5) then
  begin
    loadCol.Strings.Values['CRONO'] := '';
    gravaParam('Cronometro','Fonte',TsFontComboBox(Sender).Items[TsFontComboBox(Sender).ItemIndex]);
  end;
  copiaDadosTelaExtendida();
  posicionaElementosTimers();
end;

procedure TfmIndex.seOpcTamanhoChange(Sender: TObject);
var
  tag: integer;
begin
  if carrega_opc then Exit;

  tag := TComponent(Sender).Tag;
  if (tag = 1) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Tamanho',IntToStr(TsSpinEdit(Sender).Value));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 11) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Tamanho Titulo',IntToStr(TsSpinEdit(Sender).Value));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 12) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Tamanho Versao',IntToStr(TsSpinEdit(Sender).Value));
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 2) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Tamanho',IntToStr(TsSpinEdit(Sender).Value));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 21) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Tamanho Titulo',IntToStr(TsSpinEdit(Sender).Value));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 22) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Tamanho Versao',IntToStr(TsSpinEdit(Sender).Value));
    if fMonitor = nil then localizaPalavraChave(false);
  end
  else if (tag = 3) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Tamanho',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 32) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Tamanho 2',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 4) then
  begin
    loadCol.Strings.Values['SORTEIO'] := '';
    gravaParam('Sorteio','Tamanho',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 5) then
  begin
    loadCol.Strings.Values['CRONO'] := '';
    gravaParam('Cronometro','Tamanho',IntToStr(TsSpinEdit(Sender).Value));
  end;
  copiaDadosTelaExtendida();
  posicionaElementosTimers();
end;

procedure TfmIndex.seOpcTamanhoExtendidoChange(Sender: TObject);
var
  tag: integer;
begin
  if carrega_opc then Exit;
  
  tag := TComponent(Sender).Tag;
  if (tag = 1) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Tamanho (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 11) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Tamanho Titulo (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 12) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    gravaParam('Biblia','Tamanho Versao (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 2) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Tamanho (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 21) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Tamanho Titulo (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 22) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    gravaParam('Busca Biblica','Tamanho Versao (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 3) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Tamanho (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 32) then
  begin
    loadCol.Strings.Values['ES'] := '';
    gravaParam('Escola Sabatina','Tamanho 2 (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 4) then
  begin
    loadCol.Strings.Values['SORTEIO'] := '';
    gravaParam('Sorteio','Tamanho (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end
  else if (tag = 5) then
  begin
    loadCol.Strings.Values['CRONO'] := '';
    gravaParam('Cronometro','Tamanho (Extendido)',IntToStr(TsSpinEdit(Sender).Value));
  end;
  copiaDadosTelaExtendida();
  posicionaElementosTimers();
end;

function TfmIndex.ColorToHtml(DColor: TColor): string;
var
  tmpRGB : TColorRef;
begin
  tmpRGB := ColorToRGB(DColor) ;
  Result:=Format('#%.2x%.2x%.2x',
                 [GetRValue(tmpRGB),
                  GetGValue(tmpRGB),
                  GetBValue(tmpRGB)]) ;
end;

procedure TfmIndex.cbOpcCheckBox(Sender: TObject);
var
  tag: integer;
begin
  if carrega_opc then Exit;

  tag := TComponent(Sender).Tag;
  if (tag = 41) then
  begin
    loadCol.Strings.Values['SORTEIO'] := '';
    if TsCheckBox(Sender).Checked
      then gravaParam('Sorteio','Numeros Disponiveis (Extendido)','1')
      else gravaParam('Sorteio','Numeros Disponiveis (Extendido)','0');
  end
  else if (tag = 42) then
  begin
    loadCol.Strings.Values['SORTEIO'] := '';
    if TsCheckBox(Sender).Checked
      then gravaParam('Sorteio','Numeros Sorteados (Extendido)','1')
      else gravaParam('Sorteio','Numeros Sorteados (Extendido)','0');
  end
  else if (tag = 5) then
  begin
    loadCol.Strings.Values['CRONO'] := '';
    if TsCheckBox(Sender).Checked
      then gravaParam('Cronometro','Tempos Gravados (Extendido)','1')
      else gravaParam('Cronometro','Tempos Gravados (Extendido)','0');
  end;
  copiaDadosTelaExtendida();
  posicionaElementosTimers();
end;

procedure TfmIndex.btOpcFileNameEditChange(Sender: TObject);
var
  tag: integer;
begin
  if carrega_opc then Exit;

  tag := TComponent(Sender).Tag;
  if (tag = 1) then
  begin
    loadCol.Strings.Values['BIBLIA'] := '';
    TsFilenameEdit(Sender).Text := verificaURL(TsFilenameEdit(Sender).Text,tsBibliaImagemInfo);

    if (TsFilenameEdit(Sender).Text = '') then
    begin
      apagaParam('Biblia','Imagem Fundo');
      apagaParam('Biblia','Imagem Fundo - UrlInfo');
    end
    else
    begin
      gravaParam('Biblia','Imagem Fundo',TsFilenameEdit(Sender).Text);
      gravaParam('Biblia','Imagem Fundo - UrlInfo',tsBibliaImagemInfo.Text);
    end;
    if fMonitor = nil then geraPassagem('',false);
  end
  else if (tag = 2) then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA'] := '';
    TsFilenameEdit(Sender).Text := verificaURL(TsFilenameEdit(Sender).Text,tsBibliabImagemInfo);

    if (TsFilenameEdit(Sender).Text = '') then
    begin
      apagaParam('Busca Biblica','Imagem Fundo');
      apagaParam('Busca Biblica','Imagem Fundo - UrlInfo');
    end
    else
    begin
      gravaParam('Busca Biblica','Imagem Fundo',TsFilenameEdit(Sender).Text);
      gravaParam('Busca Biblica','Imagem Fundo - UrlInfo',tsBibliabImagemInfo.Text);
    end;
    if fMonitor = nil then localizaPalavraChave(false);
  end;
  copiaDadosTelaExtendida();
end;

procedure TfmIndex.txtCapituloKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (Key = VK_RETURN) then
  begin
    gravaPassagem();
    geraPassagem();
    exit;
  end;
end;

procedure TfmIndex.gravaPassagem(acao: string = 'BIBLIA');
var
  i: integer;
begin
  if (acao = 'BIBLIA') then
  begin
    i := cbLivro.ItemIndex;
    cbLivro.Text := '';
    cbLivro.ItemIndex := -1;
    cbLivro.ItemIndex := i;

    if (trim(txtCapitulo.Text) = '') then txtCapitulo.Text := '1';

    loadCol.Strings.Values['BIBLIA:LIVRO'] := cbLivro.Text;
    loadCol.Strings.Values['BIBLIA:CAPITULO'] := txtCapitulo.Text;
    loadCol.Strings.Values['BIBLIA:VERSO'] := txtVersiculo.Text;
    loadCol.Strings.Values['BIBLIA:VERSAO'] := kfVersao.Items[dbVersao.Itemindex];
  end
  else
  if (acao = 'BIBLIA_BUSCA') then
  begin
    loadCol.Strings.Values['BIBLIA_BUSCA:PALAVRA'] := txtLocaliza.Text;
    loadCol.Strings.Values['BIBLIA_BUSCA:VERSAO'] := kfVersao.Items[dbVersao2.Itemindex];
  end;

end;

end.
